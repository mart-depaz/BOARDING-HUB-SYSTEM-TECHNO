<!--
templates/students/partials/owner_dashboard_students.html
-->

{% extends "students/layout_students.html" %}

{% block title %}Student Dashboard - Boarding Hub System{% endblock %}

{% block content %}
<style>
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: scale(0.95);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .comment-slide-animation {
        animation: slideDown 0.5s ease-out;
    }

    #name-cooldown-modal:not(.hidden) {
        display: flex !important;
        animation: fadeIn 0.3s ease-in-out;
    }
</style>

{% if section == 'home' %}
<!-- Home as News Feed: show public posts feed so users can scroll, react, and comment -->
<section class="space-y-6">
    <div class="grid gap-6 lg:grid-cols-[2fr,1fr] items-start">
        <!-- Left: Feed -->
        <div>
            {% comment %} Include the community posts feed so visitors see all public posts and can interact {% endcomment %}
            {% include "students/partials/community_feed.html" %}
        </div>

        <!-- Right: Sidebar with shortcuts and notifications -->
        <aside class="glass-card rounded-3xl p-6 flex flex-col space-y-6 lg:sticky lg:top-24 self-start h-fit">
            <div>
                <p class="text-xs text-text-muted uppercase tracking-[0.5em]">Explore</p>
                <h2 class="text-2xl font-semibold text-white mt-2">Quick Links</h2>
            </div>
            <div class="space-y-3">
                    <div>
                        <p class="text-white font-semibold">My Home Console</p>
                        <p class="text-xs text-text-muted">Manage your posts & properties</p>
                    </div>
                    <span class="text-neon-cyan text-lg">&rarr;</span>
                </a>
                <a href="{% url 'students:student_dashboard_section' 'survey' %}" class="flex items-center justify-between px-4 py-3 rounded-2xl bg-white/5 hover:bg-white/10 transition border border-white/10">
                    <div>
                        <p class="text-white font-semibold">Admin Surveys</p>
                        <p class="text-xs text-text-muted">Stay compliant with schools</p>
                    </div>
                    <span class="text-neon-cyan text-lg">&rarr;</span>
                </a>
            </div>

        </aside>
    </div>
</section>
{% elif section == 'my-home' %}
<section class="glass-card rounded-3xl p-6 space-y-8 relative">
    <!-- Header Section -->
    <div class="mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div class="flex-1">
                <p class="text-xs uppercase tracking-[0.5em] text-neon-cyan font-semibold">My Home Hub</p>
                <h2 class="text-3xl font-bold text-white mt-2">Room & Payment Management</h2>
                <p class="text-text-muted mt-2 max-w-3xl">View your rented room details, manage payments, and connect with your property owner. Keep all your boarding information organized in one place.</p>
            </div>
            <button id="toggle-create-form" class="add-post-btn hidden px-4 py-2 rounded-xl border border-neon-cyan/60 text-neon-cyan text-sm font-semibold hover:bg-neon-cyan/10 hover:border-neon-cyan transition flex items-center space-x-2 whitespace-nowrap">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                <span>Add Post</span>
            </button>
        </div>
    </div>

    <div class="flex flex-col lg:flex-row gap-6">
        <!-- Left Sidebar with Tabs (Sticky) -->
        <div class="lg:w-64 flex-shrink-0">
            <div class="sticky top-24">
                <div class="flex lg:flex-col rounded-2xl bg-white/5 border border-white/10 p-2 gap-2">
        </div>
    </div>
</div>

        <!-- Main Content Area -->
        <div class="flex-1">
            <div id="myhome-panels" class="space-y-8">
                  {% include "students/partials/my_home_posts_students.html" %}
                  {% include "students/partials/my_home_boarders_students.html" with properties=properties %}
                  {% include "students/partials/my_home_payments_students.html" %}
                  {% include "students/partials/my_home_messenger_students.html" %}
            </div>
        </div>
    </div>
</section>
{% elif section == 'survey' %}
<section class="glass-card rounded-3xl p-6 space-y-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <p class="text-xs uppercase tracking-[0.5em] text-neon-cyan">Survey Terminal</p>
            <h2 class="text-3xl font-bold text-white mt-1">Compliance from admin schools</h2>
            <p class="text-text-muted mt-2 max-w-2xl">When a partnered school deploys a property compliance survey, it appears here for quick action. Keep your listings validated so students can trust your network.</p>
        </div>
        <button class="primary-gradient text-gray-900 font-semibold px-6 py-3 rounded-2xl shadow-lg hover:opacity-90 transition border-2 border-neon-orange">Launch Survey Console</button>
    </div>
    <div class="grid gap-4 sm:grid-cols-3">
        <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
            <p class="text-sm text-text-muted uppercase">Pending Forms</p>
            <p class="text-3xl font-bold text-white mt-2">0</p>
        </div>
        <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
            <p class="text-sm text-text-muted uppercase">Average Score</p>
            <p class="text-3xl font-bold text-white mt-2">—</p>
        </div>
        <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
            <p class="text-sm text-text-muted uppercase">Last Submission</p>
            <p class="text-3xl font-bold text-white mt-2">N/A</p>
        </div>
    </div>
</section>
{% elif section == 'profile' %}
<section class="space-y-8">
    <div class="glass-card rounded-3xl p-6 space-y-6">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div>
                <p class="text-xs uppercase tracking-[0.5em] text-neon-cyan">Identity Console</p>
                <h2 class="text-3xl font-bold text-white mt-1">Owner profile & presence</h2>
                <p class="text-text-muted mt-2 max-w-2xl text-sm">Keep your contact channels, onboarding info, and branding photo updated so students and schools know who's managing each boarding house.</p>
            </div>
            <button id="profile-save-btn" class="px-6 py-3 rounded-2xl border border-neon-cyan/60 text-neon-cyan text-sm font-semibold hover:bg-neon-cyan/10 transition">Save Profile</button>
        </div>
        <div class="grid gap-6 lg:grid-cols-2">
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-text-muted uppercase tracking-[0.4em]">Full Name</label>
                    <input id="profile-full-name" type="text" class="w-full mt-2 rounded-2xl bg-white/5 border border-white/10 px-4 py-2 text-sm focus:outline-none focus:border-neon-cyan text-white placeholder-text-muted" placeholder="Enter your display name" value="{{ user.get_full_name|default:user.username }}">
                </div>
                <div class="grid gap-4 md:grid-cols-2">
                    <div>
                        <label class="text-xs text-text-muted uppercase tracking-[0.4em]">Email</label>
                        <input type="email" class="w-full mt-2 rounded-2xl bg-white/5 border border-white/10 px-4 py-2 text-sm text-text-muted cursor-not-allowed" value="{{ user.email }}" readonly>
                    </div>
                    <div>
                        <label class="text-xs text-text-muted uppercase tracking-[0.4em]">Phone</label>
                        <input id="profile-phone" type="tel" class="w-full mt-2 rounded-2xl bg-white/5 border border-white/10 px-4 py-2 text-sm focus:outline-none focus:border-neon-cyan text-white placeholder-text-muted" placeholder="e.g. 09XX XXX XXXX">
                    </div>
                </div>
                <div>
                    <label class="text-xs text-text-muted uppercase tracking-[0.4em]">Owner Story / Bio</label>
                    <textarea id="profile-bio" rows=4 class="w-full mt-2 rounded-2xl bg-white/5 border border-white/10 px-4 py-3 text-sm focus:outline-none focus:border-neon-cyan text-white placeholder-text-muted" placeholder="Share your mission statement, response hours, or a quick welcome note for tenants."></textarea>
                </div>
            </div>
            <div class="space-y-4">
                <div class="rounded-2xl border border-white/10 p-4 bg-white/5">
                    <p class="text-sm font-semibold text-white mb-2">Profile Photo</p>
                    <div class="flex items-center space-x-4">
                        <img id="profile-photo-preview" src="https://ui-avatars.com/api/?name={{ user.get_full_name|default:user.username|urlencode }}&background=0D1117&color=00FFFF" alt="Profile preview" class="h-20 w-20 rounded-full border border-white/20 object-cover">
                        <div class="space-y-2">
                            <label for="profile-photo-input" class="inline-flex items-center space-x-2 px-4 py-2 rounded-xl border border-neon-cyan/50 text-neon-cyan text-xs font-semibold cursor-pointer hover:bg-neon-cyan/10 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.293-1.293a2 2 0 012.828 0L22 16M12 6v6" />
                                </svg>
                                <span>Choose Photo</span>
                            </label>
                            <input type="file" id="profile-photo-input" class="hidden" accept="image/*">
                            <button type="button" id="profile-photo-remove" class="block text-xs text-red-300 hover:text-red-100">Remove photo</button>
                        </div>
                    </div>
                    <p class="text-xs text-text-muted mt-3">Suggested: 400x400px PNG/JPG/WEBP under 10MB. You can crop the image after selecting it.</p>
                </div>
                <div class="rounded-2xl border border-white/10 p-4 bg-white/5 space-y-2 text-sm text-text-muted">
                    <p class="text-xs uppercase tracking-[0.4em] text-neon-cyan">Signup Snapshot</p>
                    <div class="flex items-center justify-between">
                        <span>Role</span>
                        <span class="text-white font-semibold">{{ user.profile.get_role_display|default:user.profile.role|capfirst }}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span>Joined</span>
                        <span class="text-white font-semibold">{{ user.date_joined|date:"M d, Y" }}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span>School / Partner</span>
                        <span class="text-white font-semibold">{{ user.profile.school.name|default:"Independent Owner" }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Crop Modal -->
    <div id="image-crop-modal" class="hidden fixed inset-0 z-50 bg-black/70 backdrop-blur flex items-center justify-center px-4">
        <div class="glass-card rounded-2xl p-6 w-full max-w-2xl border border-white/10">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold text-white">Crop Your Profile Photo</h3>
                <button id="crop-modal-close" class="text-text-muted hover:text-white text-2xl">&times;</button>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="space-y-2">
                    <p class="text-sm text-text-muted">Original Image</p>
                    <div class="bg-white/5 rounded-xl p-4 flex items-center justify-center min-h-[250px] max-h-[350px] overflow-hidden">
                        <img id="crop-image" src="" alt="Original" class="max-w-full max-h-full">
                    </div>
                </div>
                <div class="space-y-2">
                    <p class="text-sm text-text-muted">Crop Preview (Square)</p>
                    <div class="bg-white/5 rounded-xl p-4 flex items-center justify-center w-full h-[250px]">
                        <div id="crop-preview" style="width: 250px; height: 250px; overflow: hidden; border: 2px dashed #00FFFF; border-radius: 8px; background: rgba(0,0,0,0.5);">
                            <img id="crop-preview-image" src="" alt="Crop preview" class="w-full h-full object-cover">
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <div class="flex-1"></div>
                <button id="crop-cancel-btn" type="button" class="px-4 py-2 rounded-xl border border-white/20 text-white text-sm font-semibold hover:bg-white/10 transition">Cancel</button>
                <button id="crop-confirm-btn" type="button" class="px-4 py-2 rounded-xl bg-neon-cyan/20 border border-neon-cyan/60 text-neon-cyan text-sm font-semibold hover:bg-neon-cyan/30 transition">Use This Photo</button>
            </div>
        </div>
    </div>

    <!-- Boarding Key Confirmation Modals -->
    <div id="boarding-key-confirm-modal" class="hidden fixed inset-0 z-50 bg-black/70 backdrop-blur flex items-center justify-center px-4">
        <div class="glass-card rounded-2xl p-6 w-full max-w-md border border-white/10">
            <div class="flex items-center justify-between mb-4">
                <h3 id="boarding-key-modal-title" class="text-xl font-semibold text-white">Generate New Key?</h3>
                <button id="boarding-key-modal-close" class="text-text-muted hover:text-white text-2xl">&times;</button>
            </div>
            <p id="boarding-key-modal-message" class="text-text-muted mb-6">Are you sure? This will generate a new 8-character boarding house key.</p>
            <div class="flex space-x-3">
                <button id="boarding-key-cancel-btn" class="flex-1 px-4 py-2 rounded-xl border border-white/20 text-white text-sm font-semibold hover:bg-white/10 transition">Cancel</button>
                <button id="boarding-key-confirm-btn" class="flex-1 px-4 py-2 rounded-xl bg-neon-cyan/20 border border-neon-cyan/60 text-neon-cyan text-sm font-semibold hover:bg-neon-cyan/30 transition">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Name Change Cooldown Modal -->
    <div id="name-cooldown-modal" class="hidden fixed inset-0 z-50 bg-black/70 backdrop-blur flex items-center justify-center px-4">
        <div class="glass-card rounded-2xl p-6 w-full max-w-md border border-white/10 border-neon-cyan/30">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold text-white flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-neon-pink" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm-1 4h2v6h-2z"/>
                    </svg>
                    <span>Name Change Limit Reached</span>
                </h3>
                <button id="name-cooldown-close" class="text-text-muted hover:text-white text-2xl">&times;</button>
            </div>
            <div class="space-y-3">
                <p class="text-text-muted text-sm">You can only update your display name once every <span class="text-neon-green font-semibold">7 days</span>.</p>
                <div class="bg-neon-cyan/10 border border-neon-cyan/30 rounded-xl p-4">
                    <p class="text-sm text-text-muted mb-1">You can change your name again in:</p>
                    <p class="text-lg font-bold text-neon-cyan"><span id="days-remaining">0</span><span id="time-remaining"></span></p>
                </div>
                <p class="text-xs text-text-muted italic">This helps maintain account security and prevent frequent name changes.</p>
            </div>
            <div class="flex justify-end mt-6">
                <button id="name-cooldown-ok-btn" class="px-6 py-2 rounded-xl bg-neon-cyan/20 border border-neon-cyan/60 text-neon-cyan text-sm font-semibold hover:bg-neon-cyan/30 transition">Okay</button>
            </div>
        </div>
    </div>

    </div>
</section>
{% endif %}
{% endblock %}

{% block extra_scripts %}
{{ student_location_data|json_script:"student-properties-data" }}
{% if section == 'my-home' %}
<script>
// Post Management System with localStorage persistence
function getPhilippinesTime(timestamp) {
    const date = timestamp ? new Date(timestamp) : new Date();
    const phTime = new Date(date.toLocaleString("en-US", {timeZone: "Asia/Manila"}));
    const dateStr = phTime.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    const timeStr = phTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
    return { date: dateStr, time: timeStr, full: `${dateStr} ${timeStr}` };
}

function formatRelativeTime(timestamp) {
    const now = new Date();
    const postTime = new Date(timestamp);
    const diffMs = now - postTime;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return getPhilippinesTime(timestamp).full;
}

// IndexedDB for storing large image data
let db = null;

function initIndexedDB() {
    return new Promise((resolve, reject) => {
        if (db) {
            resolve(db);
            return;
        }
        const request = indexedDB.open('BoardingHubDB', 1);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
            db = request.result;
            resolve(db);
        };
        request.onupgradeneeded = (e) => {
            const newDb = e.target.result;
            if (!newDb.objectStoreNames.contains('posts')) {
                newDb.createObjectStore('posts', { keyPath: 'id' });
            }
        };
    });
}

function loadPosts() {
    const saved = localStorage.getItem('student_posts');
    return saved ? JSON.parse(saved) : [];
}

async function loadPostsWithImages() {
    try {
        await initIndexedDB();
        const posts = loadPosts();

        // Load images from IndexedDB
        for (let post of posts) {
            if (post.imageIds && post.imageIds.length > 0) {
                post.images = [];
                for (let imageId of post.imageIds) {
                    const imageData = await getImageFromIndexedDB(imageId);
                    if (imageData) {
                        // imageData should be a data URL string (stored directly in IndexedDB)
                        // Or a Blob that needs conversion to data URL
                        if (imageData instanceof Blob) {
                            try {
                                const dataUrl = await new Promise((resolve, reject) => {
                                    const reader = new FileReader();
                                    reader.onload = () => resolve(reader.result);
                                    reader.onerror = reject;
                                    reader.readAsDataURL(imageData);
                                });
                                post.images.push(dataUrl);
                            } catch (e) {
                                console.warn('Failed to convert Blob to data URL:', e);
                                post.images.push('');
                            }
                        } else {
                            // Already a data URL or string URL - use directly
                            post.images.push(imageData);
                        }
                    }
                }
            }
        }
        return posts;
    } catch (err) {
        console.warn('Error loading from IndexedDB, using LocalStorage only:', err);
        return loadPosts();
    }
}

async function savePosts(posts) {
    // Separate images from metadata for storage
    const postsMetadata = posts.map(post => {
        const postCopy = { ...post };
        if (postCopy.images && postCopy.images.length > 0) {
            // Store image IDs instead of actual images
            postCopy.imageIds = postCopy.images.map((_, idx) => `${post.id}_img_${idx}`);
            delete postCopy.images; // Remove images from LocalStorage copy
        }
        return postCopy;
    });

    // Save images to IndexedDB first (async), collect promises
    const imagePromises = [];
    posts.forEach(post => {
        // If there are new File/Blob objects attached to the post, save them directly
        if (post._fileObjects && post._fileObjects.length > 0) {
            post._fileObjects.forEach((fileObj, idx) => {
                const imageId = `${post.id}_img_${idx}`;
                imagePromises.push(
                    saveImageToIndexedDB(imageId, fileObj).catch(err => {
                        console.warn(`Failed to save image ${imageId}:`, err);
                    })
                );
            });
        } else if (post.images && post.images.length > 0) {
            post.images.forEach((imgUrl, idx) => {
                const imageId = `${post.id}_img_${idx}`;
                imagePromises.push(
                    saveImageToIndexedDB(imageId, imgUrl).catch(err => {
                        console.warn(`Failed to save image ${imageId}:`, err);
                    })
                );
            });
        }
    });

    // Wait for all image writes to settle before saving metadata
    try {
        await Promise.allSettled(imagePromises);
    } catch (err) {
        console.warn('Error while saving images to IndexedDB:', err);
    }

    // Save metadata to LocalStorage
    try {
        localStorage.setItem('student_posts', JSON.stringify(postsMetadata));
    } catch (err) {
        if (err && err.name === 'QuotaExceededError') {
            console.error('LocalStorage quota exceeded. Clearing old deleted posts...');
            // Try to free up space by removing soft-deleted posts
            const filtered = postsMetadata.filter(p => !p.isDeleted);
            try {
                localStorage.setItem('student_posts', JSON.stringify(filtered));
            } catch (err2) {
                console.error('Still cannot save posts:', err2);
                showMessage('Storage limit exceeded. Please clear browser cache.', true);
            }
        } else {
            throw err;
        }
    }
}

async function saveImageToIndexedDB(imageId, imageData) {
    try {
        await initIndexedDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction('posts', 'readwrite');
            const store = tx.objectStore('posts');
            // If it's already a data URL string, store it directly (more reliable than converting to Blob)
            if (typeof imageData === 'string' && imageData.startsWith('data:')) {
                const request = store.put({ id: imageId, data: imageData });
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
                return;
            }
            // If it's a Blob/File, convert to data URL for reliable storage and retrieval
            if (imageData && typeof imageData === 'object' && (imageData instanceof Blob || imageData instanceof File)) {
                const reader = new FileReader();
                reader.onload = () => {
                    const dataUrl = reader.result;
                    const request = store.put({ id: imageId, data: dataUrl });
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                };
                reader.onerror = () => reject(reader.error);
                reader.readAsDataURL(imageData);
                return;
            }
            // Fallback: store as-is (string URL)
            const request = store.put({ id: imageId, data: imageData });
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    } catch (err) {
        console.warn('Failed to save image to IndexedDB:', err);
    }
}

async function getImageFromIndexedDB(imageId) {
    try {
        await initIndexedDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction('posts', 'readonly');
            const store = tx.objectStore('posts');
            const request = store.get(imageId);
            request.onsuccess = () => resolve(request.result?.data);
            request.onerror = () => reject(request.error);
        });
    } catch (err) {
        console.warn('Failed to get image from IndexedDB:', err);
        return null;
    }
}

function getUserId() {
    return '{{ user.id|default:"user_"|escapejs }}';
}

function getUserName() {
    return '{{ user.get_full_name|default:user.username|escapejs }}';
}

function getDisplayName() {
    // Get the current profile name from localStorage (updates as user changes it)
    const userId = '{{ user.id|default:"user_"|escapejs }}';
    const profileStateKey = `student_profile_settings_${userId}`;
    try {
        const profileState = JSON.parse(localStorage.getItem(profileStateKey) || '{}');
        return profileState.fullName || getUserName();
    } catch (err) {
        return getUserName();
    }
}

function getUserInitial() {
    return '{{ user.first_name|default:user.username|slice:":1"|upper|escapejs }}';
}

function getProfilePhoto() {
    const userId = getUserId();
    const profileStateKey = `student_profile_settings_${userId}`;
    try {
        const profileState = JSON.parse(localStorage.getItem(profileStateKey) || '{}');
        return profileState.photo || null;
    } catch (err) {
        return null;
    }
}

// Escape HTML to prevent XSS when inserting user content into innerHTML
function escapeHtml(value = '') {
    const HTML_ESCAPE_LOOKUP = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
    return String(value).replace(/[&<>"']/g, (char) => HTML_ESCAPE_LOOKUP[char] || char);
}

// Convert URLs in text to blue clickable links
function linkifyText(text) {
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return escapeHtml(text).replace(urlRegex, (url) => {
        return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:text-blue-300 underline">${url}</a>`;
    });
}

function getUserAvatarHtml(size = 'w-10 h-10', showInitial = true) {
    const photo = getProfilePhoto();
    const initial = getUserInitial();
    const name = getUserName();

    if (photo) {
        return `<div class="relative ${size} flex-shrink-0">
            <img src="${photo}" alt="${name}" class="${size} rounded-full border border-neon-cyan/60 object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
            <div class="${size} rounded-full bg-neon-cyan/20 border border-neon-cyan/60 flex items-center justify-center text-neon-cyan font-bold hidden">${initial}</div>
        </div>`;
    } else {
        return `<div class="${size} rounded-full bg-neon-cyan/20 border border-neon-cyan/60 flex-shrink-0 flex items-center justify-center text-neon-cyan font-bold">${initial}</div>`;
    }
}

// Count total comments including nested replies
function getTotalCommentCount(post) {
    if (!post.comments || post.comments.length === 0) return 0;

    function countReplies(replies) {
        if (!replies || replies.length === 0) return 0;
        let count = replies.length;
        replies.forEach(reply => {
            if (reply.replies && reply.replies.length > 0) {
                count += countReplies(reply.replies);
            }
        });
        return count;
    }

    let total = post.comments.length;
    post.comments.forEach(comment => {
        if (comment.replies && comment.replies.length > 0) {
            total += countReplies(comment.replies);
        }
    });

    return total;
}

function createExamplePosts() {
    // Check if user has already liked example posts
    const example1LikedBy = JSON.parse(localStorage.getItem('example_liked_by_example-1') || '[]');
    const example2LikedBy = JSON.parse(localStorage.getItem('example_liked_by_example-2') || '[]');
    const userId = getUserId();

    const example1Likes = parseInt(localStorage.getItem('example_likes_example-1') || '47');
    const example2Likes = parseInt(localStorage.getItem('example_likes_example-2') || '31');

    return [
        {
            id: 'example-1',
            userId: 'example',
            userInitial: getUserInitial(),
            content: 'Fully furnished boarding house with modern amenities. Perfect for students looking for a comfortable and secure place to stay. Includes WiFi, study areas, and 24/7 security.',
            location: 'Sampaloc, Manila',
            images: [
                'https://images.unsplash.com/photo-1505691938895-1758d7feb511?auto=format&fit=crop&w=900&q=60',
                'https://images.unsplash.com/photo-1484101403633-562f891dc89a?auto=format&fit=crop&w=900&q=60'
            ],
            timestamp: new Date(Date.now() - 2 * 3600000).toISOString(),
            likes: example1Likes,
            likedBy: example1LikedBy,
            comments: [
                { id: 'c1', author: 'Student', text: 'Is the rate inclusive of utilities?', timestamp: new Date(Date.now() - 3600000).toISOString(), replies: [], likes: 0, likedBy: [] }
            ],
            isExample: true
        },
        {
            id: 'example-2',
            userId: 'example',
            userInitial: getUserInitial(),
            content: 'Spacious rooms available near university belt. Features include air conditioning, private bathrooms, and study desks. Perfect for students who value comfort and convenience.',
            location: 'España, Manila',
            images: [
                'https://images.unsplash.com/photo-1494145904049-0dca59b4bbad?auto=format&fit=crop&w=900&q=60',
                'https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?auto=format&fit=crop&w=900&q=60'
            ],
            timestamp: new Date(Date.now() - 6 * 3600000).toISOString(),
            likes: example2Likes,
            likedBy: example2LikedBy,
            comments: [
                { id: 'c2', author: 'Student', text: 'Need one slot for December intake!', timestamp: new Date(Date.now() - 4 * 3600000).toISOString(), replies: [], likes: 0, likedBy: [] }
            ],
            isExample: true
        }
    ];
}

// Global variables
let selectedImages = [];
let currentViewerImages = [];
let currentViewerIndex = 0;

    // Ensure a global renderImagePreviews function exists (used in multiple places)
    // Use object URLs for previews to avoid base64 conversions and reduce memory pressure
    window._previewObjectURLs = window._previewObjectURLs || [];
    function renderImagePreviews() {
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreviewGrid = document.getElementById('image-preview-grid');
        if (!imagePreviewContainer || !imagePreviewGrid) return;
        imagePreviewGrid.innerHTML = '';

        // Revoke any previous preview object URLs
        try {
            (window._previewObjectURLs || []).forEach(u => { try { URL.revokeObjectURL(u); } catch(_){} });
        } catch(e){}
        window._previewObjectURLs = [];

        if (!selectedImages || selectedImages.length === 0) {
            imagePreviewContainer.classList.add('hidden');
            return;
        }

        // Show container
        imagePreviewContainer.classList.remove('hidden');

        selectedImages.forEach((file, idx) => {
            const previewDiv = document.createElement('div');
            previewDiv.className = 'relative group';
            previewDiv.dataset.newFileIndex = idx;

            const isVideo = file.type && file.type.startsWith && file.type.startsWith('video/');
            const src = URL.createObjectURL(file);
            window._previewObjectURLs.push(src);

            if (isVideo) {
                previewDiv.innerHTML = `
                    <video src="${src}" class="w-full h-32 object-contain rounded-xl border border-white/10 bg-black/20" controls></video>
                    <button type="button" class="absolute top-2 right-2 w-6 h-6 rounded-full bg-red-500/80 text-white text-xs font-bold hover:bg-red-500 transition remove-image" data-index="${idx}">×</button>
                    <span class="absolute bottom-2 left-2 px-2 py-1 bg-black/60 text-white text-xs rounded">Video</span>
                `;
            } else {
                previewDiv.innerHTML = `
                    <img src="${src}" alt="Preview ${idx + 1}" class="w-full h-32 object-contain rounded-xl border border-white/10 bg-black/20">
                    <button type="button" class="absolute top-2 right-2 w-6 h-6 rounded-full bg-red-500/80 text-white text-xs font-bold hover:bg-red-500 transition remove-image" data-index="${idx}">×</button>
                `;
            }

            imagePreviewGrid.appendChild(previewDiv);

            // Attach click handler to open inline viewer for this set of selected images
            const previewImgs = Array.from(imagePreviewGrid.querySelectorAll('img, video')).map(el => el.src);
            const mediaEl = previewDiv.querySelector('img, video');
            if (mediaEl) {
                mediaEl.style.cursor = 'zoom-in';
                mediaEl.addEventListener('click', (ev) => {
                    ev && ev.preventDefault();
                    const index = Array.from(imagePreviewGrid.querySelectorAll('img, video')).indexOf(mediaEl);
                    openInlineViewer(previewImgs, index);
                });
            }
        });
    }

// Open an inline viewer for an array of srcs (data URLs or remote URLs)
function openInlineViewer(imagesArray, startIndex = 0) {
    if (!imagesArray || imagesArray.length === 0) return;
    currentViewerImages = imagesArray.slice();
    currentViewerIndex = Math.max(0, Math.min(startIndex || 0, currentViewerImages.length - 1));
    const modal = document.getElementById('image-viewer-modal');
    const img = document.getElementById('image-viewer-img');
    const video = document.getElementById('image-viewer-video');
    const counter = document.getElementById('image-viewer-counter');
    if (!modal || !img) return;
    function showMedia(index) {
        const mediaUrl = currentViewerImages[index];
        const isVideo = typeof mediaUrl === 'string' && (mediaUrl.includes('.mp4') || mediaUrl.includes('video'));
        if (isVideo) {
            img.classList.add('hidden');
            video.classList.remove('hidden');
            video.src = mediaUrl;
        } else {
            video.classList.add('hidden');
            img.classList.remove('hidden');
            img.src = mediaUrl;
        }
        if (counter) counter.textContent = `${index + 1} / ${currentViewerImages.length}`;
    }
    showMedia(currentViewerIndex);
    // Bind controls
    const nextBtn = document.getElementById('image-viewer-next');
    const prevBtn = document.getElementById('image-viewer-prev');
    const closeBtn = document.getElementById('image-viewer-close');
    if (nextBtn) nextBtn.onclick = (e) => { e && e.preventDefault(); e && e.stopPropagation(); currentViewerIndex = (currentViewerIndex + 1) % currentViewerImages.length; showMedia(currentViewerIndex); };
    if (prevBtn) prevBtn.onclick = (e) => { e && e.preventDefault(); e && e.stopPropagation(); currentViewerIndex = (currentViewerIndex - 1 + currentViewerImages.length) % currentViewerImages.length; showMedia(currentViewerIndex); };
    if (closeBtn) closeBtn.onclick = (e) => { e && e.preventDefault(); e && e.stopPropagation(); modal.classList.add('hidden'); };
    modal.classList.remove('hidden');
}

document.addEventListener('DOMContentLoaded', () => {
    const pills = document.querySelectorAll('.myhome-pill');
    const panels = document.querySelectorAll('.myhome-panel');
    const addPostBtn = document.getElementById('toggle-create-form');

    // Initialize: Show Add Post button if My Posts is active on page load
    const activePostsTab = document.querySelector('.myhome-pill[data-panel="posts"].myhome-pill-active');
    if (activePostsTab && addPostBtn) {
        addPostBtn.classList.remove('hidden');
    }

    pills.forEach(pill => {
        pill.addEventListener('click', () => {
            const target = pill.dataset.panel;
            pills.forEach(p => { p.classList.remove('myhome-pill-active'); p.classList.add('myhome-pill-inactive'); });
            pill.classList.add('myhome-pill-active');
            pill.classList.remove('myhome-pill-inactive');
            panels.forEach(panel => {
                panel.classList.toggle('hidden', panel.dataset.panel !== target);
            });

            // Show/hide Add Post button based on active panel
            if (addPostBtn) {
                if (target === 'posts') {
                    addPostBtn.classList.remove('hidden');
                } else {
                    addPostBtn.classList.add('hidden');
                }
            }

            // If clicking "My Posts" tab, scroll to top with smooth animation
            if (target === 'posts') {
                window.scrollTo({ top: 0, behavior: 'smooth' });
                // Also re-render posts and re-initialize buttons
                setTimeout(() => {
                    renderAllPosts();
                    reinitializeFormButtons();
                }, 100);
            }
        });
    });

    // ===== Room Creation Form Toggle =====
    const toggleRoomFormBtn = document.getElementById('toggle-room-form');
    const roomCreationForm = document.getElementById('room-creation-form');
    const cancelRoomFormBtn = document.getElementById('cancel-room-form');

    if (toggleRoomFormBtn) {
        toggleRoomFormBtn.addEventListener('click', () => {
            // open/close add-room modal
            const modal = document.getElementById('add-room-modal');
            if (!modal) return;

            // determine current visibility before changing it
            const wasHidden = modal.classList.contains('hidden');
            const showText = toggleRoomFormBtn.querySelector('.show-text');
            const hideText = toggleRoomFormBtn.querySelector('.hide-text');

            if (wasHidden) {
                // open modal
                modal.classList.remove('hidden');
                if (showText) showText.classList.add('hidden');
                if (hideText) hideText.classList.remove('hidden');
            } else {
                // close modal and clear inputs
                modal.classList.add('hidden');
                if (showText) showText.classList.remove('hidden');
                if (hideText) hideText.classList.add('hidden');
                const rtc = document.getElementById('room-type-custom'); if (rtc) { rtc.value = ''; rtc.classList.add('hidden'); }
                const pic = document.getElementById('room-picture'); if (pic) pic.value = '';
                const previewGrid = document.getElementById('room-picture-preview-grid'); if (previewGrid) { previewGrid.classList.add('hidden'); previewGrid.innerHTML = ''; }
                selectedRoomPictureDataUrls = [];
            }
        });
    }

    // Cancel room form button - hide modal and reset
    if (cancelRoomFormBtn) {
        cancelRoomFormBtn.addEventListener('click', () => {
            const modal = document.getElementById('add-room-modal'); if (modal) modal.classList.add('hidden');
            if (toggleRoomFormBtn) {
                toggleRoomFormBtn.querySelector('.show-text').classList.remove('hidden');
                toggleRoomFormBtn.querySelector('.hide-text').classList.add('hidden');
            }
            // Reset form fields
            if (document.getElementById('room-name')) {
                document.getElementById('room-name').value = '';
                document.getElementById('room-capacity').value = '';
                document.getElementById('room-rate').value = '';
                const rt = document.getElementById('room-type'); if (rt) rt.value = '1 person';
                const rtc = document.getElementById('room-type-custom'); if (rtc) { rtc.value = ''; rtc.classList.add('hidden'); }
                const pic = document.getElementById('room-picture'); if (pic) pic.value = '';
                const previewGrid = document.getElementById('room-picture-preview-grid'); if (previewGrid) { previewGrid.classList.add('hidden'); previewGrid.innerHTML = ''; }
                selectedRoomPictureDataUrls = [];
            }
        });
    }

    // Room rendering and handlers moved to `partials/my_home_boarders.html` to avoid duplicate
    // definitions when the partial is included. See `templates/properties/partials/my_home_boarders.html`.

    // Post creation form handlers - get elements first
    const toggleFormBtn = document.getElementById('toggle-create-form');
    const postForm = document.getElementById('post-form');
    const photoVideoBtn = document.getElementById('photo-video-btn');
    const imageInput = document.getElementById('image-input');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const imagePreviewGrid = document.getElementById('image-preview-grid');
    const locationBtn = document.getElementById('location-btn');
    const locationInputContainer = document.getElementById('location-input-container');

    // Get post modal
    const postFormModal = document.getElementById('post-form-modal');
    const postModalClose = document.getElementById('post-modal-close');

    // Toggle form visibility - open modal
    if (toggleFormBtn && postFormModal) {
        toggleFormBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            postFormModal.classList.remove('hidden');
            // Initialize user info with profile picture
            const userInfoDiv = document.getElementById('post-form-user-info');
            if (userInfoDiv) {
                const avatarHtml = getUserAvatarHtml('w-10 h-10', true);
                userInfoDiv.innerHTML = `
                    ${avatarHtml}
                    <div class="flex-grow">
                        <p class="text-white font-medium">${getUserName()}</p>
                        <p class="text-xs text-text-muted mt-1">Public</p>
                    </div>
                `;
            }
            // Re-initialize buttons when form is shown
            setTimeout(() => {
                reinitializeFormButtons();
            }, 100);
        });
    }

    // Close modal handlers
    if (postModalClose && postFormModal) {
        postModalClose.addEventListener('click', () => {
            postFormModal.classList.add('hidden');
            if (postForm) postForm.reset();
            selectedImages = [];
            if (imagePreviewContainer) imagePreviewContainer.classList.add('hidden');
            if (imagePreviewGrid) imagePreviewGrid.innerHTML = '';
            if (locationInputContainer) locationInputContainer.classList.add('hidden');
            window.selectedPostLocation = null;
            window.selectedPostLocationType = null;
        });
    }

    // Close modal when clicking outside
    if (postFormModal) {
        postFormModal.addEventListener('click', (e) => {
            if (e.target === postFormModal) {
                postFormModal.classList.add('hidden');
                if (postForm) postForm.reset();
                selectedImages = [];
                if (imagePreviewContainer) imagePreviewContainer.classList.add('hidden');
                if (imagePreviewGrid) imagePreviewGrid.innerHTML = '';
                if (locationInputContainer) locationInputContainer.classList.add('hidden');
                window.selectedPostLocation = null;
                window.selectedPostLocationType = null;
            }
        });
    }

    // Cancel button - using event delegation for reliability
    document.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'cancel-create-form') {
            e.preventDefault();
            e.stopPropagation();
            const postFormModal = document.getElementById('post-form-modal');
            const postForm = document.getElementById('post-form');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const imagePreviewGrid = document.getElementById('image-preview-grid');
            const locationInputContainer = document.getElementById('location-input-container');

            if (postFormModal) postFormModal.classList.add('hidden');
            if (postForm) postForm.reset();
            selectedImages = [];
            if (imagePreviewContainer) imagePreviewContainer.classList.add('hidden');
            if (imagePreviewGrid) imagePreviewGrid.innerHTML = '';
            if (locationInputContainer) locationInputContainer.classList.add('hidden');
            window.selectedPostLocation = null;
            window.selectedPostLocationType = null;
        }
    }, true); // Use capture phase to ensure it fires before other handlers

    // Delegated click handlers for post modal close and edit-image remove buttons
    document.addEventListener('click', function(e) {
        const t = e.target;
        if (!t) return;

        // Close post modal (X) - delegated
        if (t.id === 'post-modal-close') {
            const postFormModal = document.getElementById('post-form-modal');
            const postForm = document.getElementById('post-form');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const imagePreviewGrid = document.getElementById('image-preview-grid');
            const locationInputContainer = document.getElementById('location-input-container');
            if (postFormModal) postFormModal.classList.add('hidden');
            if (postForm) postForm.reset();
            selectedImages = [];
            if (imagePreviewContainer) imagePreviewContainer.classList.add('hidden');
            if (imagePreviewGrid) imagePreviewGrid.innerHTML = '';
            if (locationInputContainer) locationInputContainer.classList.add('hidden');
            window.selectedPostLocation = null;
            window.selectedPostLocationType = null;
            return;
        }

        // Remove original image in edit mode
        if (t.classList && t.classList.contains('remove-edit-image')) {
            const idx = parseInt(t.dataset.index);
            const postForm = document.getElementById('post-form');
            const originalImages = JSON.parse(postForm.dataset.originalImages || '[]');
            originalImages.splice(idx, 1);
            postForm.dataset.originalImages = JSON.stringify(originalImages);
            if (typeof window.reRenderEditImagePreviews === 'function') window.reRenderEditImagePreviews();
            return;
        }

        // Remove newly selected image in edit mode
        if (t.classList && t.classList.contains('remove-new-image')) {
            const idx = parseInt(t.dataset.index);
            selectedImages.splice(idx, 1);
            if (typeof window.reRenderEditImagePreviews === 'function') window.reRenderEditImagePreviews();
            return;
        }
    }, true);

    // Handle post submission
    async function handlePost(event) {
        event.preventDefault();
        const postForm = document.getElementById('post-form');
        const postContent = document.getElementById('post-content');
        const locationInput = document.getElementById('location-input');
        const postButton = document.getElementById('post-button');

        // Prevent multiple submissions
        if (postButton && postButton.disabled) {
            return;
        }

        // Check if we're in edit mode
            if (postForm && postForm.dataset.editingPostId) {
            // This is edit mode - handle it differently
            const postId = postForm.dataset.editingPostId;
            const posts = loadPosts();
            const post = posts.find(p => p.id === postId);
            // Define content and location for edit mode (use current form values or fall back to post values)
            const content = postContent ? postContent.value : (post && post.content) || '';
            const location = window.selectedPostLocation || (post && post.location) || null;
            if (!location) {
                const requireLocation = {% if user.profile.role != 'student' %}true{% else %}false{% endif %};
                if (requireLocation) {
                    showMessage('Please select a location for your post.', 'error');
                    return;
                }
            }

            // Get images: remaining original images + new selected images
            const originalImages = JSON.parse(postForm.dataset.originalImages || '[]');
            const newImageUrls = [];

            // Guard: estimate total selected size to avoid exceeding localStorage limits (base64 expands size)
            const totalBytes = selectedImages.reduce((s, f) => s + (f.size || 0), 0);
            // base64 expands approx 33% — be conservative and limit to ~3.5MB raw
            const MAX_RAW_BYTES = 3.5 * 1024 * 1024; // ~3.5 MB
            if (totalBytes > MAX_RAW_BYTES) {
                showMessage('Total images too large to store in browser. Reduce number/size of images or upload fewer at a time.', 'error');
                if (postButton) { postButton.disabled = false; postButton.textContent = 'Post'; }
                return;
            }

            // Process new images sequentially to avoid blocking and improve reliability
            if (selectedImages.length > 0) {
                const converted = [];
                const readFileAsDataURL = (file) => new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onerror = () => reject(new Error('Failed to read file: ' + (file.name || 'unknown')));
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });

                try {
                    for (const file of selectedImages) {
                        // yield to the event loop between files
                        await new Promise(r => setTimeout(r, 0));
                        const dataUrl = await readFileAsDataURL(file);
                        converted.push(dataUrl);
                    }
                    await updatePostWithImages(post, posts, postId, content, location, originalImages, converted, postForm, postButton);
                } catch (err) {
                    console.error('Error processing images for edit:', err);
                    // If something failed, still attempt update with what we have
                    await updatePostWithImages(post, posts, postId, content, location, originalImages, converted, postForm, postButton);
                }
            } else {
                // No new images, just use original images
                await updatePostWithImages(post, posts, postId, content, location, originalImages, [], postForm, postButton);
            }
            return; // Exit early for edit mode
        }

        // This is create mode — preserve whitespace/newlines from textarea
        const content = postContent.value;

        // Get location from the selected post location object
        const location = window.selectedPostLocation || null;

        if (!content || !content.trim()) {
            showMessage('Post content cannot be empty.', 'error');
            return;
        }

        if (!location) {
            const requireLocation = {% if user.profile.role != 'student' %}true{% else %}false{% endif %};
            if (requireLocation) {
                showMessage('Please select a location for your post.', 'error');
                return;
            }
        }

            // Disable button during submission
            if (postButton) {
                postButton.disabled = true;
                postButton.textContent = 'Publishing...';
            }

        // Helper: format location to a single display string
        function formatLocation(loc) {
            if (!loc) return '';
            // If already a string, try to detect JSON and parse it
            if (typeof loc === 'string') {
                try {
                    const parsed = JSON.parse(loc);
                    if (parsed && typeof parsed === 'object') loc = parsed;
                    else return loc;
                } catch (e) {
                    return loc;
                }
            }
            if (typeof loc === 'object' && loc !== null) {
                const parts = [loc.province || loc.state || '', loc.city || '', loc.barangay || '', loc.address || loc.display_name || '']
                    .filter(p => p && String(p).trim());
                return parts.join(', ');
            }
            return String(loc);
        }

        // Build FormData and always POST to server (no localStorage fallback)
        const fd = new FormData();
        fd.append('content', content);
        const locationStr = formatLocation(location);
        if (locationStr) fd.append('location', locationStr);
        selectedImages.forEach(file => fd.append('images', file));

        try {
            const res = await fetch('/students/api/create-post/', {
                method: 'POST',
                headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '' },
                body: fd
            });

            if (!res.ok) {
                const txt = await res.text();
                showMessage('Failed to publish post. Server responded with status ' + res.status, 'error');
                console.error('Publish failed:', res.status, txt);
                if (postButton) { postButton.disabled = false; postButton.textContent = 'Post'; }
                return;
            }

            const data = await res.json();
            if (data.success) {
                if (data.post_html) {
                    const feed = document.getElementById('post-feed');
                    if (feed) {
                        feed.insertAdjacentHTML('afterbegin', data.post_html);
                        try { if (typeof attachPostEventListeners === 'function') attachPostEventListeners(); } catch(_){}
                    }
                }
                // Reset and close modal
                const postFormModal = document.getElementById('post-form-modal');
                if (postFormModal) postFormModal.classList.add('hidden');
                if (postForm) postForm.reset();
                selectedImages = [];
                if (imagePreviewContainer) imagePreviewContainer.classList.add('hidden');
                if (imagePreviewGrid) imagePreviewGrid.innerHTML = '';
                if (locationInputContainer) locationInputContainer.classList.add('hidden');
                window.selectedPostLocation = null;
                window.selectedPostLocationType = null;
                if (postButton) { postButton.disabled = false; postButton.textContent = 'Post'; }
                showMessage('Post successfully published.');
                try { renderAllPosts(); } catch (e) {}
                return;
            } else {
                showMessage('Failed to publish post: ' + (data.error || 'Unknown error'), 'error');
            }
        } catch (err) {
            console.error('Error publishing post:', err);
            showMessage('Network error while publishing post. Please try again.', 'error');
        } finally {
            if (postButton) { postButton.disabled = false; postButton.textContent = 'Post'; }
        }
    }

    async function savePostToStorage(content, location, imageUrls, existingPosts) {
        const newPost = {
            id: 'post_' + Date.now(),
            userId: getUserId(),
            userInitial: getUserInitial(),
            content: content,
            location: location || null,
            images: imageUrls,
            timestamp: new Date().toISOString(),
            likes: 0,
            likedBy: [],
            comments: [],
            isExample: false
        };

        existingPosts.unshift(newPost);
        await savePosts(existingPosts);

        // Close modal FIRST
        const postFormModal = document.getElementById('post-form-modal');
        if (postFormModal) postFormModal.classList.add('hidden');

        // Reset form
        const postForm = document.getElementById('post-form');
        if (postForm) postForm.reset();
        selectedImages = [];
        const imageInput = document.getElementById('image-input');
        if (imageInput) imageInput.value = '';
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreviewGrid = document.getElementById('image-preview-grid');
        const locationInputContainer = document.getElementById('location-input-container');
        const locationInput = document.getElementById('location-input');
        if (imagePreviewContainer) imagePreviewContainer.classList.add('hidden');
        if (imagePreviewGrid) imagePreviewGrid.innerHTML = '';
        if (locationInputContainer) locationInputContainer.classList.add('hidden');
        if (locationInput) locationInput.value = '';
        window.selectedPostLocation = null;
        window.selectedPostLocationType = null;

        // Re-enable button
        const postButton = document.getElementById('post-button');
        if (postButton) {
            postButton.disabled = false;
            postButton.textContent = 'Post';
            postButton.className = 'flex-1 bg-neon-cyan/20 border border-neon-cyan text-neon-cyan font-semibold py-3 rounded-2xl hover:bg-neon-cyan/30 hover:border-neon-cyan transition';
        }

        // Re-render all posts
        renderAllPosts();
        showMessage('Post successfully published.');
    }

    // Render a single post
    function renderPost(post, isExample = false) {
        const phTime = getPhilippinesTime(post.timestamp);
        const relativeTime = formatRelativeTime(post.timestamp);
        const userId = getUserId();
        let isLiked = false;

        if (isExample || post.isExample) {
            // For example posts, check localStorage
            const exampleLikedByKey = `example_liked_by_${post.id}`;
            const exampleLikedBy = JSON.parse(localStorage.getItem(exampleLikedByKey) || '[]');
            isLiked = exampleLikedBy.includes(userId);
        } else {
            // For regular posts, check post.likedBy
            isLiked = post.likedBy && post.likedBy.includes(userId);
        }

        let locationHtml = '';
        if (post.location) {
            if (typeof post.location === 'object' && post.location !== null) {
                // New format: location is an object with province, city, barangay, address
                const province = post.location.province || '';
                const city = post.location.city || '';
                const barangay = post.location.barangay || '';
                const address = post.location.address || '';

                // Format as comma-separated: Province, City, Barangay, Address
                const locationParts = [province, city, barangay, address].filter(part => part && part.trim());
                const locationText = locationParts.join(', ');

                if (locationText) {
                    locationHtml = `<p class="text-xs text-text-muted mt-1">📍 ${escapeHtml(locationText)}</p>`;
                }
            } else {
                // Fallback for old string format
                locationHtml = `<p class="text-xs text-text-muted mt-1">📍 ${escapeHtml(String(post.location))}</p>`;
            }
        }

        let imagesHtml = '';
        if (post.images && post.images.length > 0) {
            let gridColsClass = 'sm:grid-cols-2';
            if (post.images.length === 1) {
                gridColsClass = 'sm:grid-cols-1';
            } else if (post.images.length >= 3) {
                gridColsClass = 'sm:grid-cols-3';
            }
            const mediaItems = post.images.map((img, idx) => {
                const isVideo = typeof img === 'string' && (img.includes('.mp4') || img.includes('video'));
                if (isVideo) {
                    return `<video src="${img}" class="post-media rounded-xl w-full h-40 object-cover border border-white/10 cursor-pointer" data-index="${idx}" data-post-id="${post.id}" controls onerror="console.warn('Video failed to load', this.src)"></video>`;
                } else {
                    return `<img src="${img}" class="post-media rounded-xl w-full h-40 object-cover border border-white/10 cursor-pointer" data-index="${idx}" data-post-id="${post.id}" alt="Post image" onerror="console.warn('Image failed to load:', this.src); this.style.display='none';">`;
                }
            }).join('');
            imagesHtml = `<div class="grid grid-cols-2 mt-4 gap-3 ${gridColsClass}">${mediaItems}</div>`;
        }

        const deleteEditHtml = !isExample ? `
            <div class="relative">
                <button class="post-actions-btn text-white hover:text-neon-cyan text-2xl font-bold transition leading-none" data-post-id="${post.id}" title="More options">⋮</button>
                <div id="actions-menu-${post.id}" class="hidden absolute right-0 top-8 glass-card rounded-xl border border-white/10 p-2 z-10 min-w-[120px] shadow-xl">
                    <button class="edit-post-btn block w-full text-left px-3 py-2 rounded-lg text-sm text-neon-cyan hover:bg-white/10" data-post-id="${post.id}">Edit</button>
                    <button class="delete-post-btn block w-full text-left px-3 py-2 rounded-lg text-sm text-red-300 hover:bg-red-500/20" data-post-id="${post.id}">Delete</button>
                </div>
            </div>
        ` : '';

        // Format timestamp like post_card: "Jan 15, 2025 14:30"
        const postDate = new Date(post.timestamp);
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const month = months[postDate.getMonth()];
        const day = postDate.getDate();
        const year = postDate.getFullYear();
        const hours = String(postDate.getHours()).padStart(2, '0');
        const minutes = String(postDate.getMinutes()).padStart(2, '0');
        const formattedTimestamp = `${month} ${day}, ${year} ${hours}:${minutes}`;

        return `
            <article class="glass-card rounded-2xl p-6 border border-white/10 relative" data-post-id="${post.id}" data-likes="${post.likes || 0}" data-liked="${isLiked}">
                <!-- Header: Avatar + Author + 3-dots menu -->
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-start space-x-3 flex-1">
                        <!-- Avatar Circle -->
                        ${getUserAvatarHtml('w-10 h-10 rounded-full bg-neon-cyan/20 border border-neon-cyan/60 flex-shrink-0 flex items-center justify-center text-neon-cyan font-bold text-sm', true)}
                        <!-- Author Info -->
                        <div class="flex-1">
                            <p class="text-white font-medium post-author-name">${post.userName || getDisplayName()}</p>
                            ${locationHtml}
                            <p class="text-xs text-text-muted mt-1">${formattedTimestamp}</p>
                        </div>
                    </div>
                    <!-- 3-Dots Menu -->
                    ${deleteEditHtml}
                </div>
                <!-- Message -->
                <p class="text-text-muted mt-4 text-sm"><span class="whitespace-pre-wrap">${linkifyText(post.content || '')}</span></p>
                ${imagesHtml}
                <!-- Actions: Heart + Comments -->
                <div class="flex items-center justify-between mt-4 text-sm text-text-muted">
                    <button class="like-btn flex items-center space-x-2 ${isLiked ? 'text-red-500' : 'text-text-muted hover:text-red-500'}" data-post-id="${post.id}" data-liked="${isLiked}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${isLiked ? 'fill-current' : ''}" fill="${isLiked ? 'currentColor' : 'none'}" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                        </svg>
                        <span class="like-count">${post.likes || 0}</span>
                    </button>
                    <button class="comments-btn text-xs text-text-muted hover:text-neon-cyan transition" data-post-id="${post.id}">
                        Comments (${getTotalCommentCount(post)})
                    </button>
                </div>
            </article>
        `;
    }

    // Render all posts
    async function renderAllPosts() {
        const feed = document.getElementById('post-feed');
        if (!feed) return;

        const posts = await loadPostsWithImages();
        console.log('Rendering posts:', posts.map(p => ({ id: p.id, imageIds: p.imageIds, images: p.images ? p.images.length : 0 })));

        // Detect server-rendered posts already present in the feed (preserved by Django)
        const existingPostEls = Array.from(feed.querySelectorAll('article[data-post-id]'));
        const existingIds = existingPostEls.map(el => String(el.dataset.postId));

        // If there are no server posts and no local posts, show examples
        if ((posts.length === 0) && (existingIds.length === 0)) {
            const examplePosts = createExamplePosts();
            const exampleContainer = document.createElement('div');
            exampleContainer.id = 'example-posts';
            exampleContainer.className = 'space-y-6';
            examplePosts.forEach(post => {
                const article = document.createElement('div');
                article.innerHTML = renderPost(post, true);
                exampleContainer.appendChild(article.firstElementChild);
            });
            feed.appendChild(exampleContainer);
        } else {
            // Append local posts that are not already rendered by the server
            posts.forEach(post => {
                const pid = String(post.id || post.postId || post.idStr || post._id || Math.random());
                if (existingIds.includes(pid)) return; // skip duplicates
                const article = document.createElement('div');
                article.innerHTML = renderPost(post, false);
                feed.appendChild(article.firstElementChild);
            });
        }

        attachPostEventListeners();
    }

    // Attach event listeners to posts
    function attachPostEventListeners() {
        // Like buttons - toggle functionality (0->1->0) - one react per user
        document.querySelectorAll('.like-btn').forEach(btn => {
            // Remove any existing listeners to prevent duplicates
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);

            newBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                const postId = this.dataset.postId;
                const posts = loadPosts();
                const post = posts.find(p => p.id === postId);

                if (!post) {
                    // Handle example posts - use localStorage to track likes (one react per user)
                    const exampleLikedByKey = `example_liked_by_${postId}`;
                    const exampleLikesKey = `example_likes_${postId}`;
                    let exampleLikedBy = JSON.parse(localStorage.getItem(exampleLikedByKey) || '[]');
                    const userId = getUserId();
                    const isLiked = exampleLikedBy.includes(userId);

                    let currentLikes = parseInt(localStorage.getItem(exampleLikesKey) || this.querySelector('.like-count').textContent) || 0;

                    if (isLiked) {
                        // Unlike - only if user already liked
                        currentLikes = Math.max(0, currentLikes - 1);
                        exampleLikedBy = exampleLikedBy.filter(id => id !== userId);
                        this.classList.remove('text-red-500');
                        this.classList.add('text-text-muted');
                        this.querySelector('svg').setAttribute('fill', 'none');
                        this.dataset.liked = 'false';
                    } else {
                        // Like - only if user hasn't liked yet
                        if (!exampleLikedBy.includes(userId)) {
                            currentLikes = currentLikes + 1;
                            exampleLikedBy.push(userId);
                            this.classList.add('text-red-500');
                            this.classList.remove('text-text-muted');
                            this.querySelector('svg').setAttribute('fill', 'currentColor');
                            this.dataset.liked = 'true';
                        }
                    }

                    this.querySelector('.like-count').textContent = currentLikes;
                    localStorage.setItem(exampleLikedByKey, JSON.stringify(exampleLikedBy));
                    localStorage.setItem(exampleLikesKey, currentLikes.toString());
                    return;
                }

                const userId = getUserId();
                if (!post.likedBy) post.likedBy = [];
                const isLiked = post.likedBy.includes(userId);

                if (isLiked) {
                    // Unlike - decrease count
                    post.likes = Math.max(0, (post.likes || 0) - 1);
                    post.likedBy = post.likedBy.filter(id => id !== userId);
                    this.classList.remove('text-red-500');
                    this.classList.add('text-text-muted');
                    this.querySelector('svg').setAttribute('fill', 'none');
                    this.dataset.liked = 'false';
                } else {
                    // Like - increase count (only if not already liked)
                    if (!post.likedBy.includes(userId)) {
                        post.likes = (post.likes || 0) + 1;
                        post.likedBy.push(userId);
                        this.classList.add('text-red-500');
                        this.classList.remove('text-text-muted');
                        this.querySelector('svg').setAttribute('fill', 'currentColor');
                        this.dataset.liked = 'true';
                    }
                }

                this.querySelector('.like-count').textContent = post.likes;
                savePosts(posts);
            });
        });

        // Comments buttons
        document.querySelectorAll('.comments-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const postId = this.dataset.postId;
                openCommentsModal(postId);
            });
        });

        // Image/media click handlers
        document.querySelectorAll('.post-media').forEach(media => {
            media.addEventListener('click', function() {
                const postId = this.dataset.postId;
                const index = parseInt(this.dataset.index);
                openImageViewer(postId, index);
            });
        });

        // Post actions menu
        document.querySelectorAll('.post-actions-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const postId = this.dataset.postId;
                const menu = document.getElementById(`actions-menu-${postId}`);
                document.querySelectorAll('[id^="actions-menu-"]').forEach(m => {
                    if (m.id !== menu.id) m.classList.add('hidden');
                });
                menu.classList.toggle('hidden');
            });
        });

        // Delete buttons - with proper event handling
        document.querySelectorAll('.delete-post-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const postId = this.dataset.postId;
                console.log('Delete button clicked for post:', postId);
                // Close the menu first
                const menu = document.getElementById(`actions-menu-${postId}`);
                if (menu) menu.classList.add('hidden');
                // Show delete modal
                showDeleteConfirmModal(postId);
            });
        });

        // Edit buttons - with proper event handling
        document.querySelectorAll('.edit-post-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const postId = this.dataset.postId;
                // Close the menu first
                const menu = document.getElementById(`actions-menu-${postId}`);
                if (menu) menu.classList.add('hidden');
                editPost(postId);
            });
        });

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.post-actions-btn') && !e.target.closest('[id^="actions-menu-"]')) {
                document.querySelectorAll('[id^="actions-menu-"]').forEach(m => m.classList.add('hidden'));
            }
        });
    }

    // Delete post - move to trash instead of permanent deletion
    async function deletePost(postId) {
        console.log('deletePost called for postId:', postId);
        const posts = loadPosts();
        // Normalize id comparison (dataset values are strings)
        const pidStr = postId != null ? postId.toString() : postId;
        const post = posts.find(p => (p.id != null && p.id.toString() === pidStr));

        if (!post) {
            console.error('Post not found');
            return;
        }

        console.log('Post found, moving to trash');

        // Add deletion timestamp
        post.deletedAt = new Date().toISOString();

        // Get current deleted posts from trash
        const deletedPosts = JSON.parse(localStorage.getItem('student_deleted_posts') || '[]');

        // Add post to trash (handle storage quota errors)
        deletedPosts.unshift(post);
        try {
            localStorage.setItem('student_deleted_posts', JSON.stringify(deletedPosts));
            console.log('Post moved to trash');
        } catch (err) {
            // Handle QuotaExceededError by trimming oldest deleted posts and retrying
            const isQuota = err && (err.name === 'QuotaExceededError' || err.name === 'NS_ERROR_DOM_QUOTA_REACHED' || err.code === 22);
            if (isQuota) {
                console.warn('localStorage quota exceeded when saving student_deleted_posts; attempting to trim oldest entries');
                // Remove oldest entries until it fits or none left
                while (deletedPosts.length > 0) {
                    deletedPosts.pop();
                    try {
                        localStorage.setItem('student_deleted_posts', JSON.stringify(deletedPosts));
                        console.log('Trimmed student_deleted_posts and saved');
                        break;
                    } catch (err2) {
                        // continue trimming
                        continue;
                    }
                }

                if (deletedPosts.length === 0) {
                    // Could not save to trash; inform user and proceed to remove from active posts
                    console.error('Unable to save deleted post to localStorage trash due to quota. Post will be removed from active posts but not recoverable from this browser.');
                    showMessage('Trash is full in this browser. Post removed but not saved to Trash.', true);
                }
            } else {
                // Unknown error, rethrow
                throw err;
            }
        }

        // Remove from active posts (compare as strings)
        const filtered = posts.filter(p => !(p.id != null && p.id.toString() === pidStr));
        await savePosts(filtered);
        console.log('Post removed from active posts');

        // Re-render feed
        renderAllPosts();
        console.log('Feed re-rendered');

        showMessage('Post deleted successfully. You can restore it from Trash.');
    }

function showConfirmModal({ title = 'Confirm Action', message = 'Are you sure?', confirmText = 'Confirm', onConfirm = null }) {
    const modal = document.getElementById('delete-confirm-modal');
    const titleEl = document.getElementById('delete-modal-title');
    const messageEl = document.getElementById('delete-modal-message');
    const confirmBtn = document.getElementById('delete-confirm-btn');
    const cancelBtn = document.getElementById('delete-cancel-btn');
    const closeBtn = document.getElementById('delete-modal-close');

    console.log('showConfirmModal called:', { title, modal: !!modal, confirmBtn: !!confirmBtn, cancelBtn: !!cancelBtn });

    if (!modal || !confirmBtn || !cancelBtn) {
        console.error('Modal elements not found');
        if (typeof onConfirm === 'function') onConfirm();
        return;
    }

    // Update text content
    if (titleEl) titleEl.textContent = title;
    if (messageEl) messageEl.textContent = message;
    confirmBtn.textContent = confirmText || 'Confirm';

    const handleClose = () => {
        console.log('Closing modal');
        modal.classList.add('hidden');
    };

    const handleConfirm = (e) => {
        console.log('Confirm button clicked');
        if (typeof onConfirm === 'function') {
            console.log('Executing onConfirm callback');
            onConfirm();
        }
        handleClose();
    };

    const handleCancel = (e) => {
        console.log('Cancel button clicked');
        handleClose();
    };

    // Remove old listeners by cloning buttons (to clear all event listeners)
    const newConfirmBtn = confirmBtn.cloneNode(true);
    const newCancelBtn = cancelBtn.cloneNode(true);

    // Add new listeners to cloned buttons
    newConfirmBtn.addEventListener('click', handleConfirm);
    newCancelBtn.addEventListener('click', handleCancel);

    // Replace in DOM
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

    // Setup close button handler
    if (closeBtn) {
        closeBtn.onclick = handleClose;
    }

    // Setup modal background click
    modal.onclick = (evt) => {
        if (evt.target === modal) {
            console.log('Modal overlay clicked');
            handleClose();
        }
    };

    console.log('Showing modal');
    modal.classList.remove('hidden');
}

// Show delete confirmation modal for posts
function showDeleteConfirmModal(postId) {
    showConfirmModal({
        title: 'Delete Post',
        message: 'Are you sure you want to delete this post? This action cannot be undone.',
        confirmText: 'Delete',
        onConfirm: () => deletePost(postId),
        });
    }

    // Edit post functionality (loads images)
    async function editPost(postId) {
        const posts = await loadPostsWithImages();
        const post = posts.find(p => p.id === postId);
        if (!post) return;

        // Close any open action menus
        document.querySelectorAll('[id^="actions-menu-"]').forEach(m => m.classList.add('hidden'));

        // Show the create form modal
        const postFormModal = document.getElementById('post-form-modal');
        const postForm = document.getElementById('post-form');
        const postContent = document.getElementById('post-content');
        const locationInput = document.getElementById('location-input');
        const locationInputContainer = document.getElementById('location-input-container');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreviewGrid = document.getElementById('image-preview-grid');

        if (!postFormModal || !postForm) return;

        // Initialize user info with profile picture
        const userInfoDiv = document.getElementById('post-form-user-info');
        if (userInfoDiv) {
            const avatarHtml = getUserAvatarHtml('w-10 h-10', true);
            userInfoDiv.innerHTML = `
                ${avatarHtml}
                <div class="flex-grow">
                    <p class="text-white font-medium">${getUserName()}</p>
                    <p class="text-xs text-text-muted mt-1">Public</p>
                </div>
            `;
        }

        // RESET location picker state for edit mode
        window.selectedPostLocation = null;
        window.selectedPostLocationType = null;
        const locationDropdown = document.getElementById('location-dropdown');
        if (locationDropdown) {
            locationDropdown.value = '';
        }

        // Populate form with post data
        postContent.value = post.content;
        if (post.location) {
            // Set selectedPostLocation to the post's location for editing
            window.selectedPostLocation = post.location;
            if (locationInput) {
                // Set locationInput to show location in the hidden location input field
                if (typeof post.location === 'object') {
                    // Format object location as string for display
                    const locParts = [];
                    if (post.location.province) locParts.push(post.location.province);
                    if (post.location.city) locParts.push(post.location.city);
                    if (post.location.barangay) locParts.push(post.location.barangay);
                    if (post.location.address) locParts.push(post.location.address);
                    locationInput.value = locParts.join(', ');
                } else {
                    locationInput.value = post.location;
                }
                locationInputContainer.classList.remove('hidden');
            }
        }

        // Display existing images for editing - don't clear selectedImages, keep them separate
        if (post.images && post.images.length > 0) {
            // Don't clear selectedImages - we want to keep new images separate from existing ones
            imagePreviewGrid.innerHTML = '';

            // Store original images for reference (these are the ones that can be removed with X)
            postForm.dataset.originalImages = JSON.stringify(post.images);

            // Display existing images
            post.images.forEach((imgUrl, idx) => {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'relative group';
                previewDiv.dataset.imageIndex = idx;
                previewDiv.dataset.imageUrl = imgUrl;
                previewDiv.dataset.isOriginal = 'true';

                const isVideo = typeof imgUrl === 'string' && (imgUrl.includes('.mp4') || imgUrl.includes('video'));
                if (isVideo) {
                    previewDiv.innerHTML = `
                        <video src="${imgUrl}" class="w-full h-32 object-contain rounded-xl border border-white/10 bg-black/20" controls></video>
                        <button type="button" class="absolute top-2 right-2 w-6 h-6 rounded-full bg-red-500/80 text-white text-xs font-bold hover:bg-red-500 transition remove-edit-image" data-index="${idx}" data-is-original="true">×</button>
                        <span class="absolute bottom-2 left-2 px-2 py-1 bg-black/60 text-white text-xs rounded">Video</span>
                    `;
                } else {
                    previewDiv.innerHTML = `
                        <img src="${imgUrl}" alt="Edit preview ${idx + 1}" class="w-full h-32 object-contain rounded-xl border border-white/10 bg-black/20">
                        <button type="button" class="absolute top-2 right-2 w-6 h-6 rounded-full bg-red-500/80 text-white text-xs font-bold hover:bg-red-500 transition remove-edit-image" data-index="${idx}" data-is-original="true">×</button>
                    `;
                }
                imagePreviewGrid.appendChild(previewDiv);
            });

            imagePreviewContainer.classList.remove('hidden');
        } else {
            // No original images, but might have new selected images
            if (selectedImages && selectedImages.length > 0) {
                imagePreviewContainer.classList.remove('hidden');
            }
        }

        // Store editing state
        postForm.dataset.editingPostId = postId;

        // Change button text and styling to match add post
        const postButton = document.getElementById('post-button');
        if (postButton) {
            // Always label as 'Post' (use same button for create and update)
            postButton.textContent = 'Post';
            postButton.className = 'flex-1 bg-neon-cyan/20 border border-neon-cyan text-neon-cyan font-semibold py-3 rounded-2xl hover:bg-neon-cyan/30 hover:border-neon-cyan transition';
        }

        // Show form modal - don't scroll, stay where user is
        if (postFormModal) postFormModal.classList.remove('hidden');

        // Re-initialize buttons in edit mode
        setTimeout(() => {
            reinitializeFormButtons();
        }, 100);

        // Function to re-render image previews (both original and new) - make it globally available
        window.reRenderEditImagePreviews = function reRenderEditImagePreviews() {
            const originalImages = JSON.parse(postForm.dataset.originalImages || '[]');
            imagePreviewGrid.innerHTML = '';

            // Render original images (with X buttons)
            originalImages.forEach((imgUrl, idx) => {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'relative group';
                const isVideo = typeof imgUrl === 'string' && (imgUrl.includes('.mp4') || imgUrl.includes('video'));
                if (isVideo) {
                    previewDiv.innerHTML = `
                        <video src="${imgUrl}" class="w-full h-32 object-contain rounded-xl border border-white/10 bg-black/20" controls></video>
                        <button type="button" class="absolute top-2 right-2 w-6 h-6 rounded-full bg-red-500/80 text-white text-xs font-bold hover:bg-red-500 transition remove-edit-image" data-index="${idx}" data-is-original="true">×</button>
                        <span class="absolute bottom-2 left-2 px-2 py-1 bg-black/60 text-white text-xs rounded">Video</span>
                    `;
                } else {
                    previewDiv.innerHTML = `
                        <img src="${imgUrl}" alt="Edit preview ${idx + 1}" class="w-full h-32 object-contain rounded-xl border border-white/10 bg-black/20">
                        <button type="button" class="absolute top-2 right-2 w-6 h-6 rounded-full bg-red-500/80 text-white text-xs font-bold hover:bg-red-500 transition remove-edit-image" data-index="${idx}" data-is-original="true">×</button>
                    `;
                }
                imagePreviewGrid.appendChild(previewDiv);
            });

            // Render new selected images (with X buttons) - ensure they display properly
            if (selectedImages && selectedImages.length > 0) {
                // Get already rendered new image indices to avoid duplicates
                const renderedIndices = new Set();
                imagePreviewGrid.querySelectorAll('[data-new-file-index]').forEach(el => {
                    const idx = parseInt(el.dataset.newFileIndex);
                    if (!isNaN(idx)) renderedIndices.add(idx);
                });

                selectedImages.forEach((file, idx) => {
                    // Skip if already rendered
                    if (renderedIndices.has(idx)) return;

                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'relative group';
                    previewDiv.dataset.newFileIndex = idx;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const isVideo = file.type.startsWith('video/');
                        if (isVideo) {
                            previewDiv.innerHTML = `
                                <video src="${e.target.result}" class="w-full h-32 object-contain rounded-xl border border-white/10 bg-black/20" controls></video>
                                <button type="button" class="absolute top-2 right-2 w-6 h-6 rounded-full bg-red-500/80 text-white text-xs font-bold hover:bg-red-500 transition remove-new-image" data-index="${idx}">×</button>
                                <span class="absolute bottom-2 left-2 px-2 py-1 bg-black/60 text-white text-xs rounded">Video</span>
                            `;
                        } else {
                            previewDiv.innerHTML = `
                                <img src="${e.target.result}" alt="New image ${idx + 1}" class="w-full h-32 object-contain rounded-xl border border-white/10 bg-black/20">
                                <button type="button" class="absolute top-2 right-2 w-6 h-6 rounded-full bg-red-500/80 text-white text-xs font-bold hover:bg-red-500 transition remove-new-image" data-index="${idx}">×</button>
                            `;
                        }
                        // Check again before appending to avoid duplicates
                        if (!imagePreviewGrid.querySelector(`[data-new-file-index="${idx}"]`)) {
                            imagePreviewGrid.appendChild(previewDiv);
                        }
                    };
                    reader.readAsDataURL(file);
                });
            }

            if (originalImages.length === 0 && (!selectedImages || selectedImages.length === 0)) {
                imagePreviewContainer.classList.add('hidden');
            } else {
                imagePreviewContainer.classList.remove('hidden');
            }

            // Attach click handlers to preview media so user can view them large
            setTimeout(() => {
                const mediaEls = Array.from(imagePreviewGrid.querySelectorAll('img, video'));
                const srcs = mediaEls.map(el => el.src);
                mediaEls.forEach((el, idx) => {
                    el.style.cursor = 'zoom-in';
                    el.onclick = (e) => { e && e.preventDefault(); e && e.stopPropagation(); openInlineViewer(srcs, idx); };
                });
            }, 50);

            // Re-attach event listeners
            attachEditImageListeners();
        }

        // Attach event listeners for removing images in edit mode
        function attachEditImageListeners() {
            // Remove original images
            document.querySelectorAll('.remove-edit-image').forEach(btn => {
                btn.addEventListener('click', function() {
                    const idx = parseInt(this.dataset.index);
                    const originalImages = JSON.parse(postForm.dataset.originalImages || '[]');
                    originalImages.splice(idx, 1);
                    postForm.dataset.originalImages = JSON.stringify(originalImages);
                    reRenderEditImagePreviews();
                });
            });

            // Remove new images
            document.querySelectorAll('.remove-new-image').forEach(btn => {
                btn.addEventListener('click', function() {
                    const idx = parseInt(this.dataset.index);
                    selectedImages.splice(idx, 1);
                    reRenderEditImagePreviews();
                });
            });
        }

        // Initial render
        reRenderEditImagePreviews();

        // Store original renderImagePreviews function globally
        if (typeof window.originalRenderImagePreviews === 'undefined') {
            window.originalRenderImagePreviews = renderImagePreviews;
        }

        // Update renderImagePreviews to work in edit mode
        renderImagePreviews = function() {
            if (postForm.dataset.editingPostId) {
                reRenderEditImagePreviews();
            } else {
                if (window.originalRenderImagePreviews) {
                    window.originalRenderImagePreviews();
                }
            }
        };

        // Re-initialize photo/video button in edit mode
        setupPhotoVideoButton();
    }

    async function updatePostWithImages(post, posts, postId, content, location, originalImages, newImageUrls, postForm, postButton) {
        // Combine original (not removed) and new images
        const allImages = [...originalImages, ...newImageUrls];

        // Find the exact post to update
        const index = posts.findIndex(p => p.id === postId);
        if (index === -1) {
            showMessage('Post not found.', true);
            return;
        }

        // Update ONLY the specific post (don't create a new one) - preserve all properties
        const existingPost = posts[index];
        existingPost.content = content;
        existingPost.location = location;
        existingPost.images = allImages;
        existingPost.timestamp = new Date().toISOString(); // Update timestamp
        // Preserve other properties like likes, comments, likedBy, etc.

        await savePosts(posts);

        // Reset form
        const postFormModal = document.getElementById('post-form-modal');
        postForm.reset();
        delete postForm.dataset.editingPostId;
        delete postForm.dataset.originalImages;
        selectedImages = [];
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreviewGrid = document.getElementById('image-preview-grid');
        const locationInputContainer = document.getElementById('location-input-container');
        if (imagePreviewContainer) imagePreviewContainer.classList.add('hidden');
        if (imagePreviewGrid) imagePreviewGrid.innerHTML = '';
        if (locationInputContainer) locationInputContainer.classList.add('hidden');
        window.selectedPostLocation = null;
        window.selectedPostLocationType = null;
        if (postFormModal) postFormModal.classList.add('hidden');

        if (postButton) {
            postButton.disabled = false;
            postButton.textContent = 'Post';
            postButton.className = 'flex-1 bg-neon-cyan/20 border border-neon-cyan text-neon-cyan font-semibold py-3 rounded-2xl hover:bg-neon-cyan/30 hover:border-neon-cyan transition';
        }

        if (window.originalRenderImagePreviews) {
            renderImagePreviews = window.originalRenderImagePreviews; // Restore original function
        }

        renderAllPosts();
        showMessage('Post updated successfully.');
    }

    // Helper function to open image viewer from comments modal
    function openImageViewerFromModal(postId, index) {
        openImageViewer(postId, index);
    }
    window.openImageViewerFromModal = openImageViewerFromModal;

    // Open comments modal (loads posts with images)
    async function openCommentsModal(postId) {
        const modal = document.getElementById('comments-modal');
        const commentsList = document.getElementById('comments-list');
        const commentsForm = document.getElementById('comments-form');

        const posts = await loadPostsWithImages();
        const post = posts.find(p => p.id === postId);
        if (!post) {
            // Check example posts
            const examplePosts = createExamplePosts();
            const examplePost = examplePosts.find(p => p.id === postId);
            if (!examplePost) return;
            displayComments(examplePost, commentsList, commentsForm, modal, true);
            return;
        }

        // On small screens, move the modal into the page flow so scrolling is unified with the post feed.
        const isMobile = window.innerWidth <= 768;
        if (isMobile) {
            try {
                const postEl = document.querySelector(`[data-post-id="${postId}"]`);
                // Guard: only move modal if it's not already an ancestor/descendant of the post element
                if (postEl && !modal.contains(postEl) && !postEl.contains(modal)) {
                    // Create a placeholder at the original modal location so we can restore it later
                    if (!document.getElementById('comments-modal-placeholder')) {
                        const placeholder = document.createElement('div');
                        placeholder.id = 'comments-modal-placeholder';
                        if (modal.parentNode) modal.parentNode.insertBefore(placeholder, modal);
                    }

                    // Move modal element right after the post element
                    postEl.parentNode.insertBefore(modal, postEl.nextSibling);

                    // Remove overlay/fixed classes so it becomes part of the normal flow
                    modal.classList.remove('fixed', 'inset-0', 'items-center', 'justify-center', 'px-4', 'bg-black/70', 'backdrop-blur');
                    modal.classList.add('relative', 'mt-4');

                    // Expand inner card to natural height (disable max-height scroll)
                    const innerCard = modal.querySelector('.glass-card');
                    if (innerCard) {
                        innerCard.classList.remove('max-h-[90vh]');
                        innerCard.classList.remove('overflow-y-auto');
                        innerCard.style.maxHeight = 'none';
                    }

                    // Ensure body scroll is enabled (we want one unified scrollbar)
                    try { document.body.style.overflow = ''; } catch (e) {}

                    // Render comments into the modal as usual and scroll to it
                    displayComments(post, commentsList, commentsForm, modal, false);
                    setTimeout(() => {
                        modal.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 50);
                    return;
                }
            } catch (err) {
                console.error('Mobile inline comments fallback failed', err);
            }
        }

        // Default desktop/modal flow
        displayComments(post, commentsList, commentsForm, modal, false);
    }

    function displayComments(post, commentsList, commentsForm, modal, isExample) {
        // Display post content in modal
        const postContentDiv = document.getElementById('comments-post-content');
        const phTime = getPhilippinesTime(post.timestamp);
        let locationHtml = '';
        if (post.location) {
            if (typeof post.location === 'object' && post.location !== null) {
                const province = post.location.province || '';
                const city = post.location.city || '';
                const barangay = post.location.barangay || '';
                const address = post.location.address || '';
                const parts = [province, city, barangay, address].filter(p => p && String(p).trim());
                if (parts.length) {
                    locationHtml = `<p class="text-xs text-text-muted mt-1">📍 ${escapeHtml(parts.join(', '))}</p>`;
                }
            } else {
                locationHtml = `<p class="text-xs text-text-muted mt-1">📍 ${escapeHtml(String(post.location))}</p>`;
            }
        }

        let imagesHtml = '';
        if (post.images && post.images.length > 0) {
            let gridColsClass = 'sm:grid-cols-2';
            if (post.images.length === 1) {
                gridColsClass = 'sm:grid-cols-1';
            } else if (post.images.length >= 3) {
                gridColsClass = 'sm:grid-cols-3';
            }
            const mediaItems = post.images.map((img, idx) => {
                const isVideo = typeof img === 'string' && (img.includes('.mp4') || img.includes('video'));
                if (isVideo) {
                    return `<video src="${img}" class="comments-modal-media rounded-xl w-full h-40 object-cover border border-white/10 cursor-pointer" data-index="${idx}" data-post-id="${post.id}" controls></video>`;
                } else {
                    return `<img src="${img}" class="comments-modal-media rounded-xl w-full h-40 object-cover border border-white/10 cursor-pointer" data-index="${idx}" data-post-id="${post.id}" alt="Post image">`;
                }
            }).join('');
            imagesHtml = `<div class="grid grid-cols-2 mt-4 gap-3 ${gridColsClass}">${mediaItems}</div>`;
        }

        postContentDiv.innerHTML = `
            <div class="flex items-start space-x-3">
                ${getUserAvatarHtml('w-10 h-10', true)}
                <div class="flex-1">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white font-medium post-author-name">${post.userName || getDisplayName()}</p>
                            ${locationHtml}
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-text-muted">${phTime.date}</p>
                            <p class="text-xs text-text-muted">${phTime.time}</p>
                        </div>
                    </div>
                    <p class="text-text-muted mt-3 text-sm">${post.content}</p>
                    ${imagesHtml}
        </div>
    </div>
        `;

        // Make images in comments modal clickable
        setTimeout(() => {
            postContentDiv.querySelectorAll('.comments-modal-media').forEach((media) => {
                const idx = parseInt(media.dataset.index);
                media.addEventListener('click', () => {
                    openImageViewer(post.id, idx);
                });
            });
        }, 100);

        // Display comments with reply buttons
        commentsList.innerHTML = '';

        function ensureReactionFields(target) {
            if (typeof target.likes !== 'number') target.likes = 0;
            if (!Array.isArray(target.likedBy)) target.likedBy = [];
        }

        function toggleCommentLike(btn) {
            if (isExample) {
                showMessage('Cannot react on example posts.', true);
                return;
            }
            const commentId = btn.dataset.commentId;
            const posts = loadPosts();
            const postToUpdate = posts.find(p => p.id === commentsForm.dataset.postId);
            if (!postToUpdate) return;
            const comment = postToUpdate.comments.find(c => c.id === commentId);
            if (!comment) return;
            ensureReactionFields(comment);
            const userId = getUserId();
            const isLiked = comment.likedBy.includes(userId);
            const heartIcon = btn.querySelector('svg');

            if (isLiked) {
                comment.likes = Math.max(0, comment.likes - 1);
                comment.likedBy = comment.likedBy.filter(id => id !== userId);
                btn.classList.remove('text-red-500');
                if (!btn.classList.contains('text-text-muted')) btn.classList.add('text-text-muted');
                btn.dataset.liked = 'false';
                if (heartIcon) {
                    heartIcon.setAttribute('fill', 'none');
                    heartIcon.classList.remove('fill-current');
                }
            } else {
                comment.likes = (comment.likes || 0) + 1;
                comment.likedBy.push(userId);
                btn.classList.add('text-red-500');
                btn.classList.remove('text-text-muted');
                btn.dataset.liked = 'true';
                if (heartIcon) {
                    heartIcon.setAttribute('fill', 'currentColor');
                    heartIcon.classList.add('fill-current');
                }
            }

            const countEl = btn.querySelector('.comment-like-count');
            if (countEl) countEl.textContent = comment.likes;

            const index = posts.findIndex(p => p.id === postToUpdate.id);
            if (index !== -1) {
                posts[index] = postToUpdate;
                savePosts(posts);
            }
        }

        function toggleReplyLike(btn) {
            if (isExample) {
                showMessage('Cannot react on example posts.', true);
                return;
            }
            const replyId = btn.dataset.replyId;
            const commentId = btn.dataset.commentId;
            const posts = loadPosts();
            const postToUpdate = posts.find(p => p.id === commentsForm.dataset.postId);
            if (!postToUpdate) return;
            const comment = postToUpdate.comments.find(c => c.id === commentId);
            if (!comment) return;

            function findReplyById(replies, targetId) {
                if (!replies) return null;
                for (const reply of replies) {
                    if (reply.id === targetId) return reply;
                    if (reply.replies && reply.replies.length > 0) {
                        const found = findReplyById(reply.replies, targetId);
                        if (found) return found;
                    }
                }
                return null;
            }

            const reply = findReplyById(comment.replies, replyId);
            if (!reply) return;
            ensureReactionFields(reply);
            const userId = getUserId();
            const isLiked = reply.likedBy.includes(userId);
            const heartIcon = btn.querySelector('svg');

            if (isLiked) {
                reply.likes = Math.max(0, reply.likes - 1);
                reply.likedBy = reply.likedBy.filter(id => id !== userId);
                btn.classList.remove('text-red-500');
                if (!btn.classList.contains('text-text-muted')) btn.classList.add('text-text-muted');
                btn.dataset.liked = 'false';
                if (heartIcon) {
                    heartIcon.setAttribute('fill', 'none');
                    heartIcon.classList.remove('fill-current');
                }
            } else {
                reply.likes = (reply.likes || 0) + 1;
                reply.likedBy.push(userId);
                btn.classList.add('text-red-500');
                btn.classList.remove('text-text-muted');
                btn.dataset.liked = 'true';
                if (heartIcon) {
                    heartIcon.setAttribute('fill', 'currentColor');
                    heartIcon.classList.add('fill-current');
                }
            }

            const countEl = btn.querySelector('.reply-like-count');
            if (countEl) countEl.textContent = reply.likes;

            const index = posts.findIndex(p => p.id === postToUpdate.id);
            if (index !== -1) {
                posts[index] = postToUpdate;
                savePosts(posts);
            }
        }
        if (post.comments && post.comments.length > 0) {
            post.comments.forEach(comment => {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'rounded-2xl bg-white/5 border border-white/10 p-3';
                commentDiv.dataset.commentId = comment.id;

                // Helper function to render a single reply without container div
                function renderSingleReply(singleReply, commentId, replyParentAuthor, replyDepth, authorChain = []) {
                    const replyDate = new Date(singleReply.timestamp);
                    const replyFormattedDate = replyDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    const replyFormattedTime = replyDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    const replyInitial = singleReply.author ? singleReply.author.charAt(0).toUpperCase() : 'U';
                    const isOwnReply = singleReply.authorId === getUserId();

                    if (typeof singleReply.likes !== 'number') singleReply.likes = 0;
                    if (!Array.isArray(singleReply.likedBy)) singleReply.likedBy = [];
                    const replyLiked = singleReply.likedBy.includes(getUserId());
                    const replyReactionClass = replyLiked ? 'text-red-500' : 'text-text-muted hover:text-red-500';
                    const replySvgFill = replyLiked ? 'currentColor' : 'none';
                    const replySvgClass = replyLiked ? 'fill-current' : '';

                    const replyActor = isOwnReply ? 'You' : singleReply.author;
                    let repliedToLabel = '';
                    // Show only the immediate parent name (not the full chain). If replying to yourself, omit the "replied to" label.
                    let immediateParent = null;
                    if (Array.isArray(authorChain) && authorChain.length > 0) {
                        immediateParent = authorChain[authorChain.length - 1];
                    } else if (replyParentAuthor) {
                        immediateParent = replyParentAuthor;
                    }
                    if (immediateParent && immediateParent !== singleReply.author) {
                        const displayedParent = (immediateParent === getUserName()) ? 'You' : immediateParent;
                        repliedToLabel = `<span class="text-xs text-text-muted italic">${replyActor} replied to ${displayedParent}</span>`;
                    }

                    // Cap visual indentation at depth 2 (third-level). Replies at depth 1 and 2 share the same indent.
                    const visualDepth = Math.min(replyDepth, 2);
                    const containerClass = 'mt-2' + (visualDepth >= 1 ? ' ml-4' : '');

                    // Use profile photo if available for reply, otherwise show initial
                    const replyAvatarHtml = singleReply.authorPhoto
                        ? `<img src="${singleReply.authorPhoto}" alt="${singleReply.author}" class="w-6 h-6 rounded-full border border-neon-cyan/60 flex-shrink-0 object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                           <div class="w-6 h-6 rounded-full bg-neon-cyan/20 border border-neon-cyan/60 flex-shrink-0 hidden flex items-center justify-center text-neon-cyan font-bold text-xs">${replyInitial}</div>`
                        : `<div class="w-6 h-6 rounded-full bg-neon-cyan/20 border border-neon-cyan/60 flex-shrink-0 flex items-center justify-center text-neon-cyan font-bold text-xs">${replyInitial}</div>`;

                    return `
                        <div class="${containerClass}">
                            <div class="rounded-xl bg-white/5 border border-white/10 p-2" data-reply-id="${singleReply.id}" data-comment-id="${commentId}" data-depth="${replyDepth}">
                                <div class="flex items-start space-x-2">
                                    <div class="flex-shrink-0">
                                        ${replyAvatarHtml}
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2 text-xs text-text-muted">
                                                <span class="font-semibold text-white">${singleReply.author}</span>
                                                <span>${replyFormattedDate} at ${replyFormattedTime}</span>
                                                <span>• ${formatRelativeTime(singleReply.timestamp)}</span>
                                            </div>
                                            ${isOwnReply ? `
                                                <div class="relative">
                                                    <button class="reply-menu-btn text-text-muted hover:text-white text-sm" type="button" data-reply-id="${singleReply.id}" data-comment-id="${commentId}">⋯</button>
                                                    <div id="reply-menu-${singleReply.id}" class="hidden absolute right-0 top-6 glass-card rounded-xl border border-white/10 p-1 z-10">
                                                        <button class="edit-reply-btn w-full text-left px-3 py-1.5 text-xs text-white hover:bg-white/10 rounded-lg" data-reply-id="${singleReply.id}" data-comment-id="${commentId}">Edit</button>
                                                        <button class="delete-reply-btn w-full text-left px-3 py-1.5 text-xs text-red-300 hover:bg-red-500/20 rounded-lg" data-reply-id="${singleReply.id}" data-comment-id="${commentId}">Delete</button>
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                        ${repliedToLabel ? `<div class="mt-1">${repliedToLabel}</div>` : ''}
                                        <p class="text-sm text-white mt-1">${singleReply.text}</p>
                                        <div class="flex items-center space-x-3 mt-2">
                                            <button class="reply-like-btn flex items-center space-x-1 ${replyReactionClass}" data-reply-id="${singleReply.id}" data-comment-id="${commentId}" data-liked="${replyLiked ? 'true' : 'false'}">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ${replySvgClass}" fill="${replySvgFill}" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                                </svg>
                                                <span class="reply-like-count text-xs">${singleReply.likes}</span>
                                            </button>
                                            <button class="reply-to-reply-btn text-xs text-neon-cyan hover:underline" type="button" data-reply-id="${singleReply.id}" data-comment-id="${commentId}">Reply</button>
                                        </div>
                                        <div id="reply-to-reply-form-${singleReply.id}" class="hidden mt-2 flex space-x-2">
                                            <input type="text" id="reply-to-reply-input-${singleReply.id}" class="flex-1 rounded-xl bg-white/5 border border-white/10 px-3 py-1 text-sm focus:outline-none focus:border-neon-cyan text-white placeholder-text-muted" placeholder="Write a reply..." required>
                                            <button type="button" class="submit-reply-to-reply-btn px-3 rounded-xl border border-neon-cyan text-neon-cyan text-xs font-semibold" data-reply-id="${singleReply.id}" data-comment-id="${commentId}">Send</button>
                                            <button type="button" class="cancel-reply-to-reply-btn px-3 rounded-xl border border-white/20 text-white text-xs" data-reply-id="${singleReply.id}">Cancel</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Recursive function to render replies at any depth so replies always appear under their parent
                // Render replies recursively but avoid accumulating left margins by using a single outer thread wrapper.
                // The outer wrapper (depth === 0) provides the vertical border and left padding. Inner replies control their
                // indent via `replyDepth` and `visualDepth` inside `renderSingleReply`, which caps at 2.
                function renderRepliesRecursive(replies, commentId, parentAuthor = null, depth = 0, authorChain = []) {
                    if (!replies || replies.length === 0) return '';

                    let html = '';
                    // Only add the bordered left-thread wrapper at the top-level replies container
                    if (depth === 0) {
                        html += `<div class="mt-3 ml-6 space-y-2 border-l-2 border-white/10 pl-3">`;
                    } else {
                        // For deeper levels use a neutral container to avoid adding extra left margin wrappers
                        html += `<div class="space-y-2">`;
                    }

                    replies.forEach(reply => {
                        // Render the reply itself (renderSingleReply decides its own visual indentation capped at depth 2)
                        html += renderSingleReply(reply, commentId, parentAuthor, depth, authorChain);

                        // Render nested replies beneath this reply
                        if (reply.replies && reply.replies.length > 0) {
                            const nextAuthorChain = Array.isArray(authorChain) ? [...authorChain, reply.author] : [reply.author];
                            html += renderRepliesRecursive(reply.replies, commentId, reply.author, depth + 1, nextAuthorChain);
                        }
                    });

                    html += '</div>';
                    return html;
                }

                let repliesHtml = '';
                if (comment.replies && comment.replies.length > 0) {
                    repliesHtml = renderRepliesRecursive(comment.replies, comment.id, comment.author, 0, []);
                }
                let deepRepliesHtml = '';

                const isOwnComment = comment.authorId === getUserId();
                if (typeof comment.likes !== 'number') comment.likes = 0;
                if (!Array.isArray(comment.likedBy)) comment.likedBy = [];
                const commentLiked = comment.likedBy.includes(getUserId());
                const commentReactionClass = commentLiked ? 'text-red-500' : 'text-text-muted hover:text-red-500';
                const commentSvgFill = commentLiked ? 'currentColor' : 'none';
                const commentSvgClass = commentLiked ? 'fill-current' : '';
                const commentDate = new Date(comment.timestamp);
                const formattedDate = commentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const formattedTime = commentDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                const authorInitial = comment.author ? comment.author.charAt(0).toUpperCase() : 'U';

                // Use profile photo if available, otherwise show initial
                const avatarHtml = comment.authorPhoto
                    ? `<img src="${comment.authorPhoto}" alt="${comment.author}" class="w-8 h-8 rounded-full border border-neon-cyan/60 object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                       <div class="w-8 h-8 rounded-full bg-neon-cyan/20 border border-neon-cyan/60 flex-shrink-0 hidden flex items-center justify-center text-neon-cyan font-bold text-sm">${authorInitial}</div>`
                    : `<div class="w-8 h-8 rounded-full bg-neon-cyan/20 border border-neon-cyan/60 flex-shrink-0 flex items-center justify-center text-neon-cyan font-bold text-sm">${authorInitial}</div>`;

                commentDiv.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0">
                            ${avatarHtml}
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <span class="text-sm font-semibold text-white">${comment.author}</span>
                                    <span class="text-xs text-text-muted">${formattedDate} at ${formattedTime}</span>
                                    <span class="text-xs text-text-muted">• ${formatRelativeTime(comment.timestamp)}</span>
                                </div>
                                ${isOwnComment ? `
                                    <div class="relative">
                                        <button class="comment-menu-btn text-text-muted hover:text-white text-lg" data-comment-id="${comment.id}">⋯</button>
                                        <div id="comment-menu-${comment.id}" class="hidden absolute right-0 top-6 glass-card rounded-xl border border-white/10 p-1 z-10">
                                            <button class="edit-comment-btn w-full text-left px-3 py-1.5 text-xs text-white hover:bg-white/10 rounded-lg" data-comment-id="${comment.id}">Edit</button>
                                            <button class="delete-comment-btn w-full text-left px-3 py-1.5 text-xs text-red-300 hover:bg-red-500/20 rounded-lg" data-comment-id="${comment.id}">Delete</button>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            <p class="text-sm text-white mt-1">${comment.text}</p>
                            <div class="flex items-center space-x-4 mt-2">
                                <button class="comment-like-btn flex items-center space-x-1 ${commentReactionClass}" data-comment-id="${comment.id}" data-liked="${commentLiked ? 'true' : 'false'}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ${commentSvgClass}" fill="${commentSvgFill}" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                    </svg>
                                    <span class="comment-like-count text-xs">${comment.likes}</span>
                                </button>
                                <button class="reply-btn text-xs text-neon-cyan hover:underline" data-comment-id="${comment.id}">Reply</button>
                            </div>
                            ${repliesHtml}
                            <div id="reply-form-${comment.id}" class="hidden mt-2 flex space-x-2">
                                <input type="text" id="reply-input-${comment.id}" class="flex-1 rounded-xl bg-white/5 border border-white/10 px-3 py-1 text-sm focus:outline-none focus:border-neon-cyan text-white placeholder-text-muted" placeholder="Write a reply..." required>
                                <button type="button" class="submit-reply-btn px-3 rounded-xl border border-neon-cyan text-neon-cyan text-xs font-semibold" data-comment-id="${comment.id}">Send</button>
                                <button type="button" class="cancel-reply-btn px-3 rounded-xl border border-white/20 text-white text-xs" data-comment-id="${comment.id}">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
                commentsList.appendChild(commentDiv);

                // Add slide-down animation when comment is added and trigger scroll
                commentDiv.classList.add('comment-slide-animation');
                setTimeout(() => {
                    commentDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            });

            // Comment menu handlers - use event delegation for dynamically added elements
            // Remove any existing listener first to prevent duplicates
            if (window.commentsListClickHandler) {
                commentsList.removeEventListener('click', window.commentsListClickHandler);
                            }

            window.commentsListClickHandler = (e) => {
                // Handle comment menu button click
                const commentMenuBtn = e.target.closest('.comment-menu-btn');
                if (commentMenuBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    const commentId = commentMenuBtn.dataset.commentId;
                    const menu = document.getElementById(`comment-menu-${commentId}`);
                    // Close other menus
                    document.querySelectorAll('[id^="comment-menu-"]').forEach(m => {
                        if (m.id !== `comment-menu-${commentId}`) {
                            m.classList.add('hidden');
                        }
                    });
                    if (menu) {
                        menu.classList.toggle('hidden');
                    }
                    return; // Prevent further event handling
                }

                // Handle reply menu button click
                const replyMenuBtn = e.target.closest('.reply-menu-btn');
                if (replyMenuBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    const replyId = replyMenuBtn.dataset.replyId;
                    const menu = document.getElementById(`reply-menu-${replyId}`);
                    // Close other menus
                    document.querySelectorAll('[id^="reply-menu-"]').forEach(m => {
                        if (m.id !== `reply-menu-${replyId}`) {
                            m.classList.add('hidden');
                        }
                    });
                    if (menu) {
                        menu.classList.toggle('hidden');
                }
                    return; // Prevent further event handling
                }

                const commentLikeBtn = e.target.closest('.comment-like-btn');
                if (commentLikeBtn) {
                    e.stopPropagation();
                    toggleCommentLike(commentLikeBtn);
                    return;
                }

                const replyLikeBtn = e.target.closest('.reply-like-btn');
                if (replyLikeBtn) {
                    e.stopPropagation();
                    toggleReplyLike(replyLikeBtn);
                    return;
                }

                // Handle edit comment button click - using event delegation
                if (e.target.classList.contains('edit-comment-btn') || e.target.closest('.edit-comment-btn')) {
                    e.stopPropagation();
                    const btn = e.target.closest('.edit-comment-btn') || e.target;
                    const commentId = btn.dataset.commentId;
                    const posts = loadPosts();
                    const postToUpdate = posts.find(p => p.id === commentsForm.dataset.postId);
                    if (!postToUpdate) return;

                    const comment = postToUpdate.comments.find(c => c.id === commentId);
                    if (!comment) return;

                    const commentDiv = document.querySelector(`[data-comment-id="${commentId}"]`);
                    if (!commentDiv) return;
                    const commentText = commentDiv.querySelector('p.text-white');
                    if (!commentText) return;
                    const originalText = comment.text;

                    // Create edit input
                    const editInput = document.createElement('input');
                    editInput.type = 'text';
                    editInput.value = originalText;
                    editInput.className = 'w-full rounded-xl bg-white/5 border border-neon-cyan px-3 py-1.5 text-sm text-white focus:outline-none';

                    const saveBtn = document.createElement('button');
                    saveBtn.type = 'button';
                    saveBtn.className = 'mt-2 px-3 py-1 rounded-xl border border-neon-cyan text-neon-cyan text-xs font-semibold';
                    saveBtn.textContent = 'Save';

                    const cancelBtn = document.createElement('button');
                    cancelBtn.type = 'button';
                    cancelBtn.className = 'mt-2 ml-2 px-3 py-1 rounded-xl border border-white/20 text-white text-xs';
                    cancelBtn.textContent = 'Cancel';

                    const editContainer = document.createElement('div');
                    editContainer.className = 'mt-2';
                    editContainer.appendChild(editInput);
                    editContainer.appendChild(saveBtn);
                    editContainer.appendChild(cancelBtn);

                    commentText.style.display = 'none';
                    commentText.parentNode.insertBefore(editContainer, commentText.nextSibling);

                    // Close menu
                    const menu = document.getElementById(`comment-menu-${commentId}`);
                    if (menu) menu.classList.add('hidden');

                    saveBtn.addEventListener('click', () => {
                        const newText = editInput.value.trim();
                        if (!newText) {
                            showMessage('Comment cannot be empty.', true);
                            return;
                        }

                        comment.text = newText;
                        const index = posts.findIndex(p => p.id === postToUpdate.id);
                        if (index !== -1) {
                            posts[index] = postToUpdate;
                            savePosts(posts);
                        }

                        openCommentsModal(postToUpdate.id);
                        showMessage('Comment updated.');
                    });

                    cancelBtn.addEventListener('click', () => {
                        editContainer.remove();
                        commentText.style.display = 'block';
                    });
                }

                // Handle delete comment button click - using event delegation
                if (e.target.classList.contains('delete-comment-btn') || e.target.closest('.delete-comment-btn')) {
                    e.stopPropagation();
                    if (isExample) {
                        showMessage('Cannot delete comments on example posts.', true);
                        return;
                    }
                    const btn = e.target.closest('.delete-comment-btn') || e.target;
                    const commentId = btn.dataset.commentId;

                    showConfirmModal({
                        title: 'Delete Comment',
                        message: 'Are you sure you want to delete this comment? This action cannot be undone.',
                        confirmText: 'Delete',
                        onConfirm: () => {
                    const posts = loadPosts();
                    const postToUpdate = posts.find(p => p.id === commentsForm.dataset.postId);
                    if (!postToUpdate) return;

                    postToUpdate.comments = postToUpdate.comments.filter(c => c.id !== commentId);

                    const index = posts.findIndex(p => p.id === postToUpdate.id);
                    if (index !== -1) {
                        posts[index] = postToUpdate;
                        savePosts(posts);
                    }

                    openCommentsModal(postToUpdate.id);
                    showMessage('Comment deleted.');
                        }
                    });
                    return;
                }

                // Handle edit reply button click - using event delegation
                if (e.target.classList.contains('edit-reply-btn') || e.target.closest('.edit-reply-btn')) {
                    e.stopPropagation();
                    const btn = e.target.closest('.edit-reply-btn') || e.target;
                    const replyId = btn.dataset.replyId;
                    const commentId = btn.dataset.commentId;
                    const posts = loadPosts();
                    const postToUpdate = posts.find(p => p.id === commentsForm.dataset.postId);
                    if (!postToUpdate) return;

                    const comment = postToUpdate.comments.find(c => c.id === commentId);
                    if (!comment) return;

                    // Recursive function to find reply in nested structure
                    function findReply(replies, replyId) {
                        if (!replies) return null;
                        for (let reply of replies) {
                            if (reply.id === replyId) return reply;
                            if (reply.replies && reply.replies.length > 0) {
                                const found = findReply(reply.replies, replyId);
                                if (found) return found;
                            }
                        }
                        return null;
                    }

                    const reply = findReply(comment.replies, replyId);
                    if (!reply) return;

                    const replyDiv = document.querySelector(`[data-reply-id="${replyId}"]`);
                    if (!replyDiv) return;
                    const replyText = replyDiv.querySelector('p.text-white');
                    if (!replyText) return;
                    const originalText = reply.text;

                    // Create edit input
                    const editInput = document.createElement('input');
                    editInput.type = 'text';
                    editInput.value = originalText;
                    editInput.className = 'w-full rounded-xl bg-white/5 border border-neon-cyan px-3 py-1.5 text-sm text-white focus:outline-none';

                    const saveBtn = document.createElement('button');
                    saveBtn.type = 'button';
                    saveBtn.className = 'mt-2 px-3 py-1 rounded-xl border border-neon-cyan text-neon-cyan text-xs font-semibold';
                    saveBtn.textContent = 'Save';

                    const cancelBtn = document.createElement('button');
                    cancelBtn.type = 'button';
                    cancelBtn.className = 'mt-2 ml-2 px-3 py-1 rounded-xl border border-white/20 text-white text-xs';
                    cancelBtn.textContent = 'Cancel';

                    const editContainer = document.createElement('div');
                    editContainer.className = 'mt-2';
                    editContainer.appendChild(editInput);
                    editContainer.appendChild(saveBtn);
                    editContainer.appendChild(cancelBtn);

                    replyText.style.display = 'none';
                    replyText.parentNode.insertBefore(editContainer, replyText.nextSibling);

                    // Close menu
                    const menu = document.getElementById(`reply-menu-${replyId}`);
                    if (menu) menu.classList.add('hidden');

                    saveBtn.addEventListener('click', () => {
                        const newText = editInput.value.trim();
                        if (!newText) {
                            showMessage('Reply cannot be empty.', true);
                            return;
                        }

                        reply.text = newText;
                        const index = posts.findIndex(p => p.id === postToUpdate.id);
                        if (index !== -1) {
                            posts[index] = postToUpdate;
                            savePosts(posts);
                        }

                        openCommentsModal(postToUpdate.id);
                        showMessage('Reply updated.');
                    });

                    cancelBtn.addEventListener('click', () => {
                        editContainer.remove();
                        replyText.style.display = 'block';
                    });
                }

                // Handle delete reply button click - using event delegation
                if (e.target.classList.contains('delete-reply-btn') || e.target.closest('.delete-reply-btn')) {
                    e.stopPropagation();
                    if (isExample) {
                        showMessage('Cannot delete replies on example posts.', true);
                        return;
                    }
                    const btn = e.target.closest('.delete-reply-btn') || e.target;
                    const replyId = btn.dataset.replyId;
                    const commentId = btn.dataset.commentId;

                    showConfirmModal({
                        title: 'Delete Reply',
                        message: 'Are you sure you want to delete this reply? This action cannot be undone.',
                        confirmText: 'Delete',
                        onConfirm: () => {
                    const posts = loadPosts();
                    const postToUpdate = posts.find(p => p.id === commentsForm.dataset.postId);
                    if (!postToUpdate) return;

                    const comment = postToUpdate.comments.find(c => c.id === commentId);
                    if (!comment) return;

                    // Recursive function to remove reply from nested structure
                            function removeReply(replies, targetId) {
                                if (!replies) return [];
                        return replies.filter(r => {
                                    if (r.id === targetId) return false;
                            if (r.replies && r.replies.length > 0) {
                                        r.replies = removeReply(r.replies, targetId);
                            }
                            return true;
                        });
                    }

                    comment.replies = removeReply(comment.replies, replyId);

                    const index = posts.findIndex(p => p.id === postToUpdate.id);
                    if (index !== -1) {
                        posts[index] = postToUpdate;
                        savePosts(posts);
                    }

                    openCommentsModal(postToUpdate.id);
                    showMessage('Reply deleted.');
                        }
                    });
                    return;
                }

                // Handle reply button click - using event delegation
                if (e.target.classList.contains('reply-btn') || e.target.closest('.reply-btn')) {
                    e.stopPropagation();
                    const btn = e.target.closest('.reply-btn') || e.target;
                    const commentId = btn.dataset.commentId;
                    const replyForm = document.getElementById(`reply-form-${commentId}`);
                    if (replyForm) {
                        replyForm.classList.remove('hidden');
                        const input = document.getElementById(`reply-input-${commentId}`);
                        if (input) input.focus();
                    }
                }

                // Handle submit reply button click - using event delegation
                if (e.target.classList.contains('submit-reply-btn') || e.target.closest('.submit-reply-btn')) {
                    e.stopPropagation();
                    const btn = e.target.closest('.submit-reply-btn') || e.target;
                    const commentId = btn.dataset.commentId;
                    const input = document.getElementById(`reply-input-${commentId}`);
                    if (!input) return;
                    const text = input.value.trim();
                    if (!text) return;

                    const isExample = commentsForm.dataset.postId === 'example-post-1' || commentsForm.dataset.postId === 'example-post-2';
                    if (isExample) {
                        showMessage('Cannot reply to example posts.', true);
                        return;
                    }

                    const posts = loadPosts();
                    const postToUpdate = posts.find(p => p.id === commentsForm.dataset.postId);
                    if (!postToUpdate) return;

                    const comment = postToUpdate.comments.find(c => c.id === commentId);
                    if (!comment) return;

                    if (!comment.replies) comment.replies = [];
                    comment.replies.push({
                        id: 'r' + Date.now(),
                        author: getUserName(),
                        authorId: getUserId(),
                        authorPhoto: getProfilePhoto(),
                        text: text,
                        timestamp: new Date().toISOString(),
                        replies: [],
                        likes: 0,
                        likedBy: []
                    });

                    const index = posts.findIndex(p => p.id === postToUpdate.id);
                    if (index !== -1) {
                        posts[index] = postToUpdate;
                        savePosts(posts);
                    }

                    input.value = '';
                    const replyForm = document.getElementById(`reply-form-${commentId}`);
                    if (replyForm) replyForm.classList.add('hidden');
                    openCommentsModal(postToUpdate.id);
                    showMessage('Reply added.');
                }

                // Handle cancel reply button click - using event delegation
                if (e.target.classList.contains('cancel-reply-btn') || e.target.closest('.cancel-reply-btn')) {
                    e.stopPropagation();
                    const btn = e.target.closest('.cancel-reply-btn') || e.target;
                    const commentId = btn.dataset.commentId;
                    const replyForm = document.getElementById(`reply-form-${commentId}`);
                    if (replyForm) replyForm.classList.add('hidden');
                    const input = document.getElementById(`reply-input-${commentId}`);
                    if (input) input.value = '';
                }

                // Handle reply to reply button click - using event delegation
                if (e.target.classList.contains('reply-to-reply-btn') || e.target.closest('.reply-to-reply-btn')) {
                    e.stopPropagation();
                    const btn = e.target.closest('.reply-to-reply-btn') || e.target;
                    const replyId = btn.dataset.replyId;
                    const replyForm = document.getElementById(`reply-to-reply-form-${replyId}`);
                    if (replyForm) {
                        replyForm.classList.remove('hidden');
                        const input = document.getElementById(`reply-to-reply-input-${replyId}`);
                        if (input) input.focus();
                    }
                }

                // Handle submit reply to reply button click - using event delegation
                if (e.target.classList.contains('submit-reply-to-reply-btn') || e.target.closest('.submit-reply-to-reply-btn')) {
                    e.stopPropagation();
                    const btn = e.target.closest('.submit-reply-to-reply-btn') || e.target;
                    const replyId = btn.dataset.replyId;
                    const commentId = btn.dataset.commentId;
                    const input = document.getElementById(`reply-to-reply-input-${replyId}`);
                    if (!input) return;
                    const text = input.value.trim();
                    if (!text) return;

                    const isExample = commentsForm.dataset.postId === 'example-post-1' || commentsForm.dataset.postId === 'example-post-2';
                    if (isExample) {
                        showMessage('Cannot reply to example posts.', true);
                        return;
                    }

                    const posts = loadPosts();
                    const postToUpdate = posts.find(p => p.id === commentsForm.dataset.postId);
                    if (!postToUpdate) return;

                    const comment = postToUpdate.comments.find(c => c.id === commentId);
                    if (!comment) return;

                    // Recursive function to find reply and check depth
                    function findReplyAndDepth(replies, replyId, currentDepth = 0) {
                        if (!replies) return null;
                        for (let reply of replies) {
                            if (reply.id === replyId) {
                                return { reply: reply, depth: currentDepth };
                            }
                            if (reply.replies && reply.replies.length > 0) {
                                const found = findReplyAndDepth(reply.replies, replyId, currentDepth + 1);
                                if (found) return found;
                            }
                        }
                        return null;
                    }

                    const result = findReplyAndDepth(comment.replies, replyId);
                    if (!result) return;

                    const parentReply = result.reply;
                    const parentDepth = result.depth;

                    // Allow replies up to depth 2 (which creates 4th level - will be shown in first comment container)
                    // Depth 0 = 2nd level, Depth 1 = 3rd level, Depth 2 = 4th level
                    // We don't prevent any depth - deeper replies will be collected and shown in first comment container

                    if (!parentReply.replies) parentReply.replies = [];
                    parentReply.replies.push({
                        id: 'rr' + Date.now(),
                        author: getUserName(),
                        authorId: getUserId(),
                        authorPhoto: getProfilePhoto(),
                        text: text,
                        timestamp: new Date().toISOString(),
                        replies: [],
                        likes: 0,
                        likedBy: []
                    });

                    const index = posts.findIndex(p => p.id === postToUpdate.id);
                    if (index !== -1) {
                        posts[index] = postToUpdate;
                        savePosts(posts);
                    }

                    input.value = '';
                    const replyForm = document.getElementById(`reply-to-reply-form-${replyId}`);
                    if (replyForm) replyForm.classList.add('hidden');
                    openCommentsModal(postToUpdate.id);
                    showMessage('Reply added.');
                }

                // Handle cancel reply to reply button click - using event delegation
                if (e.target.classList.contains('cancel-reply-to-reply-btn') || e.target.closest('.cancel-reply-to-reply-btn')) {
                    e.stopPropagation();
                    const btn = e.target.closest('.cancel-reply-to-reply-btn') || e.target;
                    const replyId = btn.dataset.replyId;
                    const replyForm = document.getElementById(`reply-to-reply-form-${replyId}`);
                    if (replyForm) replyForm.classList.add('hidden');
                    const input = document.getElementById(`reply-to-reply-input-${replyId}`);
                    if (input) input.value = '';
                }

            };

            // Attach the event listener
            commentsList.addEventListener('click', window.commentsListClickHandler);

            // Close comment/reply menus when clicking outside (only once, not re-attached each time)
            // Close comment/reply menus when clicking outside
            // Use a stored reference so we can remove it properly
            if (!window.commentMenuOutsideClickHandler) {
                window.commentMenuOutsideClickHandler = (e) => {
                    // Don't close if clicking on menu button, menu itself, or edit/delete buttons
                    if (e.target.closest('.comment-menu-btn') ||
                        e.target.closest('[id^="comment-menu-"]') ||
                        e.target.closest('.edit-comment-btn') ||
                        e.target.closest('.delete-comment-btn')) {
                        return;
                }
                    if (e.target.closest('.reply-menu-btn') ||
                        e.target.closest('[id^="reply-menu-"]') ||
                        e.target.closest('.edit-reply-btn') ||
                        e.target.closest('.delete-reply-btn')) {
                        return;
                    }
                    // Close all menus
                    document.querySelectorAll('[id^="comment-menu-"]').forEach(m => m.classList.add('hidden'));
                    document.querySelectorAll('[id^="reply-menu-"]').forEach(m => m.classList.add('hidden'));
                };
                document.addEventListener('click', window.commentMenuOutsideClickHandler);
                }
        } else {
            commentsList.innerHTML = '<p class="text-text-muted text-center text-sm">No comments yet.</p>';
        }

        commentsForm.onsubmit = (e) => {
            e.preventDefault();
            if (isExample) {
                showMessage('Cannot comment on example posts.', true);
                return;
            }
            const input = document.getElementById('comment-input');
            const text = input.value.trim();
            if (!text) return;

            const posts = loadPosts();
            const postToUpdate = posts.find(p => p.id === commentsForm.dataset.postId);
            if (!postToUpdate) return;

            if (!postToUpdate.comments) postToUpdate.comments = [];
            postToUpdate.comments.push({
                id: 'c' + Date.now(),
                author: getUserName(),
                authorId: getUserId(),
                authorPhoto: getProfilePhoto() || null,
                text: text,
                timestamp: new Date().toISOString(),
                replies: [],
                likes: 0,
                likedBy: []
            });

            const index = posts.findIndex(p => p.id === postToUpdate.id);
            if (index !== -1) {
                posts[index] = postToUpdate;
                savePosts(posts);
            }

            input.value = '';
            openCommentsModal(postToUpdate.id);
            showMessage('Comment added.');
        };

        commentsForm.dataset.postId = post.id;
        modal.classList.remove('hidden');
        // Prevent background scrolling when comments modal is open (single scrollbar on mobile)
        try { document.body.style.overflow = 'hidden'; } catch (e) { /* ignore */ }
    }

    // Open image viewer
    async function openImageViewer(postId, startIndex = 0) {
        const modal = document.getElementById('image-viewer-modal');
        const img = document.getElementById('image-viewer-img');
        const video = document.getElementById('image-viewer-video');
        const counter = document.getElementById('image-viewer-counter');

        const posts = await loadPostsWithImages();
        let post = posts.find(p => p.id === postId);
        if (!post) {
            const examplePosts = createExamplePosts();
            post = examplePosts.find(p => p.id === postId);
        }
        if (!post || !post.images || post.images.length === 0) return;

        currentViewerImages = post.images;
        currentViewerIndex = startIndex;

        function showMedia(index) {
            const mediaUrl = currentViewerImages[index];
            const isVideo = typeof mediaUrl === 'string' && (mediaUrl.includes('.mp4') || mediaUrl.includes('video'));

            if (isVideo) {
                img.classList.add('hidden');
                video.classList.remove('hidden');
                video.src = mediaUrl;
            } else {
                video.classList.add('hidden');
                img.classList.remove('hidden');
                img.src = mediaUrl;
            }

            counter.textContent = `${index + 1} / ${currentViewerImages.length}`;
        }

        showMedia(startIndex);

        const nextBtn = document.getElementById('image-viewer-next');
        const prevBtn = document.getElementById('image-viewer-prev');
        const closeBtn = document.getElementById('image-viewer-close');

        if (nextBtn) {
            nextBtn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                currentViewerIndex = (currentViewerIndex + 1) % currentViewerImages.length;
                showMedia(currentViewerIndex);
            };
        }

        if (prevBtn) {
            prevBtn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                currentViewerIndex = (currentViewerIndex - 1 + currentViewerImages.length) % currentViewerImages.length;
                showMedia(currentViewerIndex);
            };
        }

        if (closeBtn) {
            closeBtn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                modal.classList.add('hidden');
            };
        }

        let touchStartX = 0;
        let touchEndX = 0;

        img.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        });

        img.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            if (touchEndX < touchStartX - 50) {
                currentViewerIndex = (currentViewerIndex + 1) % currentViewerImages.length;
                showMedia(currentViewerIndex);
            }
            if (touchEndX > touchStartX + 50) {
                currentViewerIndex = (currentViewerIndex - 1 + currentViewerImages.length) % currentViewerImages.length;
                showMedia(currentViewerIndex);
            }
        });

        modal.classList.remove('hidden');
    }

    // Attach form submit handler - clone to remove old listeners
    if (postForm && postForm.parentNode) {
        const newPostForm = postForm.cloneNode(true);
        postForm.parentNode.replaceChild(newPostForm, postForm);

        newPostForm.addEventListener('submit', handlePost);

        // Update global reference
        window.postFormElement = newPostForm;
    }

    // Make handlePost globally available
    window.handlePost = handlePost;

    // Initialize emoji picker with ALL emojis
    function initEmojiPicker() {
        const emojiBtn = document.getElementById('emoji-picker-btn');
        const emojiModal = document.getElementById('emoji-picker-modal');
        const emojiContainer = document.getElementById('emoji-picker-container');
        const emojiGrid = document.getElementById('emoji-grid');
        const postContent = document.getElementById('post-content');

        if (!emojiBtn || !emojiModal || !emojiContainer || !emojiGrid || !postContent) return;

        // Clone button to remove old listeners
        const newEmojiBtn = emojiBtn.cloneNode(true);
        emojiBtn.parentNode.replaceChild(newEmojiBtn, emojiBtn);

        // Set initial emoji button text
        newEmojiBtn.textContent = '😊';
        newEmojiBtn.className = 'absolute bottom-4 right-4 text-2xl hover:scale-110 transition cursor-pointer';

        // Comprehensive emoji list - ALL emojis
        const emojis = [
            // Smileys & People
            '😀', '😃', '😄', '😁', '😆', '😅', '🤣', '😂', '🙂', '🙃', '😉', '😊', '😇', '🥰', '😍', '🤩', '😘', '😗', '😚', '😙', '😋', '😛', '😜', '🤪', '😝', '🤑', '🤗', '🤭', '🤫', '🤔', '🤐', '🤨', '😐', '😑', '😶', '😏', '😒', '🙄', '😬', '🤥', '😌', '😔', '😪', '🤤', '😴', '😷', '🤒', '🤕', '🤢', '🤮', '🤧', '🥵', '🥶', '😵', '🤯', '🤠', '🥳', '😎', '🤓', '🧐', '😕', '😟', '🙁', '☹️', '😮', '😯', '😲', '😳', '🥺', '😦', '😧', '😨', '😰', '😥', '😢', '😭', '😱', '😖', '😣', '😞', '😓', '😩', '😫', '🥱', '😤', '😡', '😠', '🤬', '😈', '👿', '💀', '☠️', '💩', '🤡', '👹', '👺', '👻', '👽', '👾', '🤖', '😺', '😸', '😹', '😻', '😼', '😽', '🙀', '😿', '😾',
            // Gestures
            '👋', '🤚', '🖐️', '✋', '🖖', '👌', '🤏', '✌️', '🤞', '🤟', '🤘', '🤙', '👈', '👉', '👆', '🖕', '👇', '☝️', '👍', '👎', '✊', '👊', '🤛', '🤜', '👏', '🙌', '👐', '🤲', '🤝', '🙏', '✍️', '💪', '🦾', '🦿', '🦵', '🦶', '👂', '🦻', '👃', '🧠', '🦷', '🦴', '👀', '👁️', '👅', '👄',
            // People
            '👶', '🧒', '👦', '👧', '🧑', '👱', '👨', '🧔', '👨‍🦰', '👨‍🦱', '👨‍🦳', '👨‍🦲', '👩', '👩‍🦰', '👩‍🦱', '👩‍🦳', '👩‍🦲', '🧓', '👴', '👵', '🙍', '🙍‍♂️', '🙍‍♀️', '🙎', '🙎‍♂️', '🙎‍♀️', '🙅', '🙅‍♂️', '🙅‍♀️', '🙆', '🙆‍♂️', '🙆‍♀️', '💁', '💁‍♂️', '💁‍♀️', '🙋', '🙋‍♂️', '🙋‍♀️', '🧏', '🧏‍♂️', '🧏‍♀️', '🤦', '🤦‍♂️', '🤦‍♀️', '🤷', '🤷‍♂️', '🤷‍♀️', '🙇', '🙇‍♂️', '🙇‍♀️',
            // Hearts & Emotions
            '💋', '💌', '💘', '💝', '💖', '💗', '💓', '💞', '💕', '💟', '❣️', '💔', '❤️', '🧡', '💛', '💚', '💙', '💜', '🖤', '🤍', '🤎', '💯', '💢', '💥', '💫', '💦', '💨', '🕳️', '💣', '💬', '👁️‍🗨️', '🗣️', '👤', '👥',
            // Animals & Nature
            '🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼', '🐨', '🐯', '🦁', '🐮', '🐷', '🐽', '🐸', '🐵', '🙈', '🙉', '🙊', '🐒', '🐔', '🐧', '🐦', '🐤', '🐣', '🐥', '🦆', '🦅', '🦉', '🦇', '🐺', '🐗', '🐴', '🦄', '🐝', '🐛', '🦋', '🐌', '🐞', '🐜', '🦟', '🦗', '🕷️', '🦂', '🐢', '🐍', '🦎', '🦖', '🦕', '🐙', '🦑', '🦐', '🦞', '🦀', '🐡', '🐠', '🐟', '🐬', '🐳', '🐋', '🦈', '🐊', '🐅', '🐆', '🦓', '🦍', '🦧', '🐘', '🦛', '🦏', '🐪', '🐫', '🦒', '🦘', '🦡', '🐾', '🐉', '🐲',
            // Food & Drink
            '🍏', '🍎', '🍐', '🍊', '🍋', '🍌', '🍉', '🍇', '🍓', '🍈', '🍒', '🍑', '🥭', '🍍', '🥥', '🥝', '🍅', '🍆', '🥑', '🥦', '🥬', '🥒', '🌶️', '🌽', '🥕', '🥔', '🍠', '🥐', '🥯', '🍞', '🥖', '🥨', '🧀', '🥚', '🍳', '🥞', '🥓', '🥩', '🍗', '🍖', '🦴', '🌭', '🍔', '🍟', '🍕', '🥪', '🥙', '🌮', '🌯', '🥗', '🥘', '🥫', '🍝', '🍜', '🍲', '🍛', '🍣', '🍱', '🥟', '🦪', '🍤', '🍙', '🍚', '🍘', '🍥', '🥠', '🥮', '🍢', '🍡', '🍧', '🍨', '🍦', '🥧', '🧁', '🍰', '🎂', '🍮', '🍭', '🍬', '🍫', '🍿', '🍩', '🍪', '🌰', '🥜', '🍯', '🥛', '🍼', '☕️', '🍵', '🧃', '🥤', '🍶', '🍺', '🍻', '🥂', '🍷', '🥃', '🍸', '🍹', '🧉', '🍾', '🧊',
            // Activities & Sports
            '⚽️', '🏀', '🏈', '⚾️', '🥎', '🎾', '🏐', '🏉', '🥏', '🎱', '🏓', '🏸', '🥅', '🏒', '🏑', '🏏', '🥍', '🏹', '🎣', '🥊', '🥋', '🎽', '🛹', '🛷', '⛸️', '🥌', '🎿', '⛷️', '🏂', '🏋️', '🤼', '🤸', '🤺', '⛹️', '🤾', '🏌️', '🏇', '🧘', '🏄', '🏊', '🚣', '🧗', '🚵', '🚴', '🏆', '🥇', '🥈', '🥉', '🏅', '🎖', '🏵', '🎗', '🎫', '🎟', '🎪', '🤹', '🎭', '🩰', '🎨', '🎬', '🎤', '🎧', '🎼', '🎹', '🥁', '🎷', '🎺', '🎸', '🪕', '🎻', '🎲', '♟️', '🎯', '🎳', '🎮', '🎰', '🧩',
            // Travel & Places
            '🚗', '🚕', '🚙', '🚌', '🚎', '🏎', '🚓', '🚑', '🚒', '🚐', '🚚', '🚛', '🚜', '🛴', '🚲', '🛵', '🏍', '🛺', '🚨', '🚔', '🚍', '🚘', '🚖', '🚡', '🚠', '🚟', '🚃', '🚋', '🚞', '🚝', '🚄', '🚅', '🚈', '🚂', '🚆', '🚇', '🚊', '🚉', '✈️', '🛫', '🛬', '🛩', '💺', '🚁', '🚟', '🚀', '🛸', '🚤', '🛥', '🛳', '⛴', '🚢', '⚓', '⛽', '🚧', '🚦', '🚥', '🗺', '🗿', '🗽', '🗼', '🏰', '🏯', '🏟', '🎡', '🎢', '🎠', '⛲', '⛱', '🏖', '🏝', '🏜', '🌋', '⛰', '🏔', '🗻', '🏕', '⛺', '🏠', '🏡', '🏘', '🏚', '🏗', '🏭', '🏢', '🏬', '🏣', '🏤', '🏥', '🏦', '🏨', '🏪', '🏫', '🏩', '💒', '🏛', '⛪', '🕌', '🕍', '🕋', '⛩', '🛤', '🛣', '🗾', '🎑', '🏞', '🌅', '🌄', '🌠', '🎇', '🎆', '🌇', '🌆', '🏙', '🌃', '🌌', '🌉', '🌁',
            // Objects
            '⌚', '📱', '📲', '💻', '⌨️', '🖥', '🖨', '🖱', '🖲', '🕹', '🗜', '💾', '💿', '📀', '📼', '📷', '📸', '📹', '🎥', '📽', '🎞', '📞', '☎️', '📟', '📠', '📺', '📻', '🎙', '🎚', '🎛', '⏱', '⏲', '⏰', '🕰', '⌛', '⏳', '📡', '🔋', '🔌', '💡', '🔦', '🕯', '🧯', '🛢', '💸', '💵', '💴', '💶', '💷', '💰', '💳', '💎', '⚖️', '🧰', '🔧', '🔨', '⚒', '🛠', '⛏', '🔩', '⚙️', '🧱', '⛓', '🧲', '🔫', '💣', '🧨', '🔪', '🗡', '⚔️', '🛡', '🚬', '⚰️', '⚱️', '🏺', '🔮', '📿', '🧿', '💈', '⚗️', '🔭', '🔬', '🕳', '🩹', '🩺', '💊', '💉', '🩸', '🧬', '🦠', '🧫', '🧪', '🌡', '🧹', '🪠', '🧺', '🧻', '🚽', '🚰', '🚿', '🛁', '🛀', '🧼', '🪒', '🧽', '🪣', '🧴', '🛎', '🔑', '🗝', '🚪', '🪑', '🛋', '🛏', '🛌', '🧸', '🪆', '🖼', '🪞', '🪟', '🛍', '🛒', '🎁', '🎈', '🎏', '🎀', '🪄', '🪅', '🪡', '🧶', '🧵', '🪢', '👓', '🕶', '🥽', '🥼', '🦺', '👔', '👕', '👖', '🧣', '🧤', '🧥', '🧦', '👗', '👘', '🥻', '🩱', '🩲', '🩳', '👙', '👚', '👛', '👜', '👝', '🛍', '🎒', '👞', '👟', '🥾', '🥿', '👠', '👡', '🩰', '👢', '🪖', '⛑', '🎩', '🎓', '🧢', '👒',
            // Symbols
            '❤️', '🧡', '💛', '💚', '💙', '💜', '🖤', '🤍', '🤎', '💔', '❣️', '💕', '💞', '💓', '💗', '💖', '💘', '💝', '💟', '☮️', '✝️', '☪️', '🕉', '☸️', '✡️', '🔯', '🕎', '☯️', '☦️', '🛐', '⛎', '♈', '♉', '♊', '♋', '♌', '♍', '♎', '♏', '♐', '♑', '♒', '♓', '🆔', '⚛️', '🉑', '☢️', '☣️', '📴', '📳', '🈶', '🈚', '🈸', '🈺', '🈷️', '✴️', '🆚', '💮', '🉐', '㊙️', '㊗️', '🈴', '🈵', '🈹', '🈲', '🅰️', '🅱️', '🆎', '🆑', '🅾️', '🆘', '❌', '⭕', '🛑', '⛔', '📛', '🚫', '💯', '💢', '♨️', '🚷', '🚯', '🚳', '🚱', '🔞', '📵', '🚭', '❗', '❓', '❕', '❔', '‼️', '⁉️', '🔅', '🔆', '〽️', '⚠️', '🚸', '🔱', '⚜️', '🔰', '♻️', '✅', '🈯', '💹', '❇️', '✳️', '❎', '🌐', '💠', 'Ⓜ️', '🌀', '💤', '🏧', '🚾', '♿', '🅿️', '🈳', '🈂️', '🛂', '🛃', '🛄', '🛅', '🚹', '🚺', '🚼', '🚻', '🚮', '🎦', '📶', '🈁', '🔣', 'ℹ️', '🔤', '🔡', '🔠', '🆖', '🆗', '🆙', '🆒', '🆕', '🆓', '0️⃣', '1️⃣', '2️⃣', '3️⃣', '4️⃣', '5️⃣', '6️⃣', '7️⃣', '8️⃣', '9️⃣', '🔟', '🔢', '#️⃣', '*️⃣', '⏏️', '▶️', '⏸', '⏯', '⏹', '⏺', '⏭', '⏮', '⏩', '⏪', '⏫', '⏬', '◀️', '🔼', '🔽', '➡️', '⬅️', '⬆️', '⬇️', '↗️', '↘️', '↙️', '↖️', '↕️', '↔️', '↪️', '↩️', '⤴️', '⤵️', '🔀', '🔁', '🔂', '🔄', '🔃', '🎵', '🎶', '➕', '➖', '➗', '✖️', '💲', '💱', '™️', '©️', '®️', '〰️', '➰', '➿', '🔚', '🔙', '🔛', '🔜', '🔝', '✔️', '☑️', '🔘', '⚪', '⚫', '🔴', '🔵', '🟠', '🟡', '🟢', '🟣', '🟤', '⚫', '🔶', '🔷', '🔸', '🔹', '🔺', '🔻', '💠', '🔘', '🔳', '🔲', '▪️', '▫️', '◾', '◽', '◼️', '◻️', '🟥', '🟧', '🟨', '🟩', '🟦', '🟪', '🟫', '⬛', '⬜', '🔈', '🔇', '🔉', '🔊', '🔔', '🔕', '📣', '📢', '👁️‍🗨️', '💬', '💭', '🗯', '♠️', '♣️', '♥️', '♦️', '🃏', '🎴', '🀄', '🕐', '🕑', '🕒', '🕓', '🕔', '🕕', '🕖', '🕗', '🕘', '🕙', '🕚', '🕛', '🕜', '🕝', '🕞', '🕟', '🕠', '🕡', '🕢', '🕣', '🕤', '🕥', '🕦', '🕧'
        ];

        // Get emoji modal close button
        const emojiModalClose = document.getElementById('emoji-modal-close');

        // Populate emoji grid
        emojiGrid.className = 'grid grid-cols-8 gap-2';
        emojiGrid.innerHTML = ''; // Clear existing

        emojis.forEach(emoji => {
            const emojiBtnEl = document.createElement('button');
            emojiBtnEl.type = 'button';
            emojiBtnEl.className = 'text-2xl hover:scale-125 transition p-2 rounded-lg hover:bg-white/10';
            emojiBtnEl.textContent = emoji;
            emojiBtnEl.addEventListener('click', () => {
                const cursorPos = postContent.selectionStart;
                const textBefore = postContent.value.substring(0, cursorPos);
                const textAfter = postContent.value.substring(cursorPos);
                postContent.value = textBefore + emoji + textAfter;
                postContent.focus();
                postContent.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);
                // Keep emoji modal open so user can insert multiple emojis quickly
                // Do not call emojiModal.classList.add('hidden');
                // Show a small toast so the user knows the emoji was inserted
                try { showMessage(`${emoji} added`, 'info'); } catch (e) { /* ignore if showMessage missing */ }
            });
            emojiGrid.appendChild(emojiBtnEl);
        });

        // Toggle emoji picker modal - use the new button reference
        newEmojiBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            emojiModal.classList.remove('hidden');
        });

        // Close emoji modal
        if (emojiModalClose) {
            emojiModalClose.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                emojiModal.classList.add('hidden');
            });
        }

        // Close emoji picker when clicking outside modal
        emojiModal.addEventListener('click', (e) => {
            if (e.target === emojiModal) {
                emojiModal.classList.add('hidden');
            }
        });
    }

    // Clear student_deleted_posts to free up localStorage space
    try {
        const deletedPostsSize = (localStorage.getItem('student_deleted_posts') || '').length;
        console.log('student_deleted_posts size:', deletedPostsSize, 'bytes');
        if (deletedPostsSize > 10000) {
            console.log('Clearing student_deleted_posts to free up space');
            localStorage.removeItem('student_deleted_posts');
        }
    } catch (err) {
        console.log('Error checking student_deleted_posts:', err);
        try {
            localStorage.removeItem('student_deleted_posts');
        } catch (e) {
            console.log('Could not remove student_deleted_posts');
        }
    }

    // Initialize posts on page load
    renderAllPosts();

    // Refresh posts when profile photo is updated
    document.addEventListener('profileUpdated', () => {
        if (document.getElementById('post-feed')) {
            renderAllPosts();
        }
    });

    // Initialize emoji picker
    initEmojiPicker();

    // Modal close handlers - use event delegation for all clicks
    document.addEventListener('click', (e) => {
        // Handle comments modal close - check if clicked element is the close button or its child
        if (e.target && (e.target.id === 'comments-close' || e.target.closest && e.target.closest('#comments-close'))) {
            e.preventDefault();
            e.stopPropagation();
            const modal = document.getElementById('comments-modal');
            if (modal) {
                // If the modal was moved into the document flow for mobile, restore it to its original location
                const placeholder = document.getElementById('comments-modal-placeholder');
                if (placeholder) {
                    // Move modal back to placeholder position
                    placeholder.parentNode.insertBefore(modal, placeholder);
                    placeholder.remove();
                    // Restore classes removed for mobile inline mode
                    modal.classList.remove('relative', 'mt-4');
                    modal.classList.add('fixed', 'inset-0', 'items-center', 'justify-center', 'px-4', 'bg-black/70', 'backdrop-blur');
                    const innerCard = modal.querySelector('.glass-card');
                    if (innerCard) {
                        innerCard.classList.add('max-h-[90vh]');
                        innerCard.classList.add('overflow-y-auto');
                        innerCard.style.maxHeight = '';
                    }
                }
                modal.classList.add('hidden');
            }
            try { document.body.style.overflow = ''; } catch (e) { }
        }
        // Handle image viewer modal close
        if (e.target && (e.target.id === 'image-viewer-close' || (e.target.closest && e.target.closest('#image-viewer-close')))) {
            e.preventDefault();
            e.stopPropagation();
            const modal = document.getElementById('image-viewer-modal');
            if (modal) modal.classList.add('hidden');
        }
    });

    // Also attach direct listeners for existing elements as backup
    const commentsClose = document.getElementById('comments-close');
    if (commentsClose) {
        commentsClose.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('comments-modal')?.classList.add('hidden');
            try { document.body.style.overflow = ''; } catch (err) {}
        });
    }

    const imageViewerClose = document.getElementById('image-viewer-close');
    if (imageViewerClose) {
        imageViewerClose.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('image-viewer-modal')?.classList.add('hidden');
        });
    }

    // Keyboard navigation for image viewer
    document.addEventListener('keydown', (e) => {
        const modal = document.getElementById('image-viewer-modal');
        if (modal.classList.contains('hidden')) return;

        if (e.key === 'ArrowRight') {
            document.getElementById('image-viewer-next').click();
        } else if (e.key === 'ArrowLeft') {
            document.getElementById('image-viewer-prev').click();
        } else if (e.key === 'Escape') {
            document.getElementById('image-viewer-close').click();
        }
    });

    // Trash link handler
    document.getElementById('trash-link')?.addEventListener('click', (e) => {
        e.preventDefault();
        const posts = loadPosts();
        if (posts.length === 0) {
            showMessage('Trash is empty.', false);
            return;
        }
        if (confirm(`Delete all ${posts.length} post(s)? This cannot be undone.`)) {
            localStorage.removeItem('student_posts');
            renderAllPosts();
            showMessage('All posts deleted.');
        }
    });

    // Photo/Video button handler - setup function
    function setupPhotoVideoButton() {
        const photoVideoBtn = document.getElementById('photo-video-btn');
        const imageInput = document.getElementById('image-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreviewGrid = document.getElementById('image-preview-grid');

        if (photoVideoBtn && imageInput) {
            // Clone to remove old listeners
            const newPhotoVideoBtn = photoVideoBtn.cloneNode(true);
            photoVideoBtn.parentNode.replaceChild(newPhotoVideoBtn, photoVideoBtn);

            newPhotoVideoBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                imageInput.click();
            });

            // Setup image input handler - clone to remove old listeners
            const newImageInput = imageInput.cloneNode(true);
            imageInput.parentNode.replaceChild(newImageInput, imageInput);

            newImageInput.addEventListener('change', (e) => {
                const newFiles = Array.from(e.target.files);
                if (newFiles.length === 0) return;

                // Check if we're in edit mode
                const postForm = document.getElementById('post-form');
                const isEditMode = postForm && postForm.dataset.editingPostId;

                if (isEditMode && window.reRenderEditImagePreviews) {
                    // In edit mode, add to selectedImages and re-render
                    newFiles.forEach(file => {
                        selectedImages.push(file);
                    });
                    // Force re-render to show new images immediately
                    setTimeout(() => {
                        if (window.reRenderEditImagePreviews) {
                            window.reRenderEditImagePreviews();
                        }
                    }, 50);
                } else {
                    // In create mode, append new files to selectedImages and use the
                    // centralized renderImagePreviews() so indexing/keys stay consistent.
                    newFiles.forEach(file => selectedImages.push(file));

                    // Render using the shared preview renderer which handles
                    // showing/hiding the container and creating stable object URLs.
                    renderImagePreviews();
                }

                // Reset input to allow selecting the same files again if needed
                e.target.value = '';
            });
        }
    }

    // Initial setup
    setupPhotoVideoButton();

    // Remove image handler - for create mode
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-image')) {
            const index = parseInt(e.target.dataset.index);
            const postForm = document.getElementById('post-form');
            const isEditMode = postForm && postForm.dataset.editingPostId;

            if (isEditMode) {
                // In edit mode, this shouldn't happen - use remove-edit-image or remove-new-image
                return;
            }

            // In create mode, remove from selectedImages and re-render using
            // the shared renderer to keep indexes/keys consistent.
            selectedImages.splice(index, 1);
            renderImagePreviews();
        }
    });

    // Function to reinitialize form buttons (photo/video, location, emoji)
    function reinitializeFormButtons() {
        setupPhotoVideoButton();
        setupLocationButton();
        initEmojiPicker();
    }

    // Function to setup location button handler - SIMPLIFIED VERSION
    function setupLocationButton() {
        const locationBtn = document.getElementById('location-btn');
        const locationInputContainer = document.getElementById('location-input-container');
        const locationProfileBtn = document.getElementById('location-profile-btn');
        const locationAutoDetectBtn = document.getElementById('location-auto-detect-btn');
        const locationProfileSelector = document.getElementById('location-profile-selector');
        const locationAutoDetectInput = document.getElementById('location-auto-detect-input');
        const locationDropdown = document.getElementById('location-dropdown');
        const locationAutoText = document.getElementById('location-auto-text');

        if (!locationBtn || !locationInputContainer) return;

        // Store selected location globally
        window.selectedPostLocation = null;
        window.selectedPostLocationType = null;

        // Get profile locations from localStorage
        function loadLocations() {
            const userId = '{{ user.id|default:"user_"|escapejs }}';
            const key = `student_profile_settings_${userId}`;
            try {
                const data = JSON.parse(localStorage.getItem(key) || '{}');
                return data.locations || [];
            } catch (e) {
                return [];
            }
        }

        // Populate dropdown with locations
        function populateDropdown() {
            const locations = loadLocations();
            locationDropdown.innerHTML = '<option value="">-- Select a saved location --</option>';

            if (!locations.length) {
                const opt = document.createElement('option');
                opt.textContent = '-- No saved locations --';
                opt.disabled = true;
                locationDropdown.appendChild(opt);
                return;
            }

            locations.forEach((loc, idx) => {
                if (loc && typeof loc === 'object') {
                    const opt = document.createElement('option');
                    opt.value = idx;
                    const label = loc.label || `Location ${idx + 1}`;
                    const parts = [label];
                    if (loc.province) parts.push(loc.province);
                    if (loc.city) parts.push(loc.city);
                    if (loc.barangay) parts.push(loc.barangay);
                    opt.textContent = parts.join(' | ');
                    locationDropdown.appendChild(opt);
                }
            });
        }

        // Clone Check In button to remove old listeners
        if (locationBtn && locationBtn.parentNode) {
            const newLocationBtn = locationBtn.cloneNode(true);
            locationBtn.parentNode.replaceChild(newLocationBtn, locationBtn);

            newLocationBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                locationInputContainer.classList.toggle('hidden');

                if (!locationInputContainer.classList.contains('hidden')) {
                    const profileBtn = document.getElementById('location-profile-btn');
                    if (profileBtn) profileBtn.click();
                }
            });
        }

        // Clone My Location button to remove old listeners
        if (locationProfileBtn && locationProfileBtn.parentNode) {
            const newProfileBtn = locationProfileBtn.cloneNode(true);
            locationProfileBtn.parentNode.replaceChild(newProfileBtn, locationProfileBtn);

            newProfileBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();

                locationProfileSelector.classList.remove('hidden');
                locationAutoDetectInput.classList.add('hidden');

                newProfileBtn.classList.remove('bg-white/5', 'border-white/10', 'text-text-muted');
                newProfileBtn.classList.add('bg-neon-cyan/20', 'border-neon-cyan/60', 'text-neon-cyan');

                const autoBtn = document.getElementById('location-auto-detect-btn');
                if (autoBtn) {
                    autoBtn.classList.remove('bg-neon-cyan/20', 'border-neon-cyan/60', 'text-neon-cyan');
                    autoBtn.classList.add('bg-white/5', 'border-white/10', 'text-text-muted');
                }

                // Get fresh dropdown reference
                const dropdown = document.getElementById('location-dropdown');
                if (dropdown) {
                    dropdown.value = '';

                    // Auto-select first location if available
                    const locations = loadLocations();
                    if (locations.length > 0) {
                        dropdown.value = '0';
                        dropdown.dispatchEvent(new Event('change'));
                    }
                }
            });
        }

        // Clone Auto Detect button to remove old listeners
        if (locationAutoDetectBtn && locationAutoDetectBtn.parentNode) {
            const newAutoBtn = locationAutoDetectBtn.cloneNode(true);
            locationAutoDetectBtn.parentNode.replaceChild(newAutoBtn, locationAutoDetectBtn);

            newAutoBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();

                window.selectedPostLocation = null;
                window.selectedPostLocationType = 'auto-detect';

                locationProfileSelector.classList.add('hidden');
                locationAutoDetectInput.classList.remove('hidden');

                newAutoBtn.classList.remove('bg-white/5', 'border-white/10', 'text-text-muted');
                newAutoBtn.classList.add('bg-neon-cyan/20', 'border-neon-cyan/60', 'text-neon-cyan');

                const profileBtn = document.getElementById('location-profile-btn');
                if (profileBtn) {
                    profileBtn.classList.remove('bg-neon-cyan/20', 'border-neon-cyan/60', 'text-neon-cyan');
                    profileBtn.classList.add('bg-white/5', 'border-white/10', 'text-text-muted');
                }

                // Get fresh reference to the text input
                const autoTextInput = document.getElementById('location-auto-text');
                const autoDetectContainer = document.getElementById('location-auto-detect-input');

                // Get current location
                if (navigator.geolocation) {
                    autoTextInput.value = 'Getting your location...';
                    autoTextInput.disabled = true;
                    console.log('[AUTO-DETECT] Requesting geolocation...');

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            console.log('[AUTO-DETECT] Got position:', lat, lng);

                            let mapsContainer = autoDetectContainer.querySelector('.maps-container');
                            if (!mapsContainer) {
                                mapsContainer = document.createElement('div');
                                mapsContainer.className = 'maps-container mt-3 space-y-2';
                                autoDetectContainer.appendChild(mapsContainer);
                            }
                            mapsContainer.innerHTML = `
                                <a href="https://www.google.com/maps/search/?api=1&query=${lat},${lng}" target="_blank" class="inline-flex items-center space-x-1 px-3 py-1.5 rounded-xl bg-neon-cyan/10 border border-neon-cyan/40 text-neon-cyan text-xs font-semibold hover:bg-neon-cyan/20 transition">
                                    <span>📍</span> <span>Edit in Google Maps</span>
                                </a>
                                <p class="text-xs text-text-muted">Click to edit location</p>
                            `;

                            // Get address from coordinates
                            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
                                .then(r => r.json())
                                .then(data => {
                                    const address = data.display_name || `${lat}, ${lng}`;
                                    autoTextInput.value = address;
                                    autoTextInput.disabled = false;
                                    window.selectedPostLocation = { address: address };
                                    console.log('[AUTO-DETECT] Address:', address);
                                })
                                .catch(err => {
                                    const address = `${lat}, ${lng}`;
                                    autoTextInput.value = address;
                                    autoTextInput.disabled = false;
                                    window.selectedPostLocation = { address: address };
                                    console.log('[AUTO-DETECT] Using coordinates:', address);
                                });
                        },
                        (err) => {
                            console.log('[AUTO-DETECT] Geolocation error:', err.code, err.message);
                            autoTextInput.value = '';
                            autoTextInput.disabled = false;
                            autoTextInput.placeholder = 'Enter your location manually';
                            showMessage('Location access denied. Please enter location manually.', 'error');
                        },
                        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                    );
                } else {
                    console.log('[AUTO-DETECT] Geolocation not supported');
                    autoTextInput.disabled = false;
                    autoTextInput.placeholder = 'Enter your location manually';
                    showMessage('Geolocation not supported. Please enter location manually.', 'error');
                }
            });
        }

        // Clone dropdown to remove old listeners
        if (locationDropdown && locationDropdown.parentNode) {
            const newDropdown = locationDropdown.cloneNode(true);
            locationDropdown.parentNode.replaceChild(newDropdown, locationDropdown);

            // Populate the NEW cloned dropdown with locations
            const locations = loadLocations();
            newDropdown.innerHTML = '<option value="">-- Select a saved location --</option>';

            if (locations.length > 0) {
                locations.forEach((loc, idx) => {
                    if (loc && typeof loc === 'object') {
                        const opt = document.createElement('option');
                        opt.value = idx;
                        const label = loc.label || `Location ${idx + 1}`;
                        const parts = [label];
                        if (loc.province) parts.push(loc.province);
                        if (loc.city) parts.push(loc.city);
                        if (loc.barangay) parts.push(loc.barangay);
                        opt.textContent = parts.join(' | ');
                        newDropdown.appendChild(opt);
                    }
                });
            }

            newDropdown.addEventListener('change', (e) => {
                const idx = parseInt(e.target.value);

                if (isNaN(idx) || idx === '') {
                    window.selectedPostLocation = null;
                    return;
                }

                const locations = loadLocations();
                const loc = locations[idx];

                if (loc) {
                    window.selectedPostLocation = {
                        province: loc.province || '',
                        city: loc.city || '',
                        barangay: loc.barangay || '',
                        address: loc.address || ''
                    };
                    console.log('[LOCATION] Selected:', loc.label, window.selectedPostLocation);
                }
            });
        }

        // Clone auto-detect text input to remove old listeners
        if (locationAutoText && locationAutoText.parentNode) {
            const newAutoText = locationAutoText.cloneNode(true);
            locationAutoText.parentNode.replaceChild(newAutoText, locationAutoText);

            newAutoText.addEventListener('input', (e) => {
                if (e.target.value.trim()) {
                    window.selectedPostLocation = { address: e.target.value.trim() };
                }
            });
        }
    }

    // Initial setup for location button
    setupLocationButton();

    document.querySelectorAll('.comment-form').forEach(form => {
        form.addEventListener('submit', (evt) => {
            evt.preventDefault();
            const input = form.querySelector('input[name="comment"]');
            if (!input.value.trim()) return;
            const wrapper = document.createElement('div');
            wrapper.className = 'rounded-2xl bg-white/5 border border-white/10 p-3 mt-3';
            wrapper.innerHTML = `
                <div class="flex items-center justify-between text-xs text-text-muted">
                    <span>You</span><span>now</span>
                </div>
                <p class="text-sm text-white mt-1">${input.value.trim()}</p>
            `;
            form.insertAdjacentElement('beforebegin', wrapper);
            input.value = '';
            showMessage('Comment posted.');
        });
    });

    const boarderSearch = document.getElementById('boarder-search');
    if (boarderSearch) {
        boarderSearch.addEventListener('input', () => {
            const term = boarderSearch.value.toLowerCase();
            document.querySelectorAll('.boarder-row').forEach(row => {
                row.classList.toggle('hidden', !row.textContent.toLowerCase().includes(term));
            });
        });
    }

    document.querySelectorAll('.message-boarder').forEach(btn => {
        btn.addEventListener('click', () => {
            document.getElementById('chat-recipient').textContent = btn.dataset.name;
            document.getElementById('chat-modal').classList.remove('hidden');
        });
    });
});
</script>
{% elif section == 'profile' %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const ownerPropsDataEl = document.getElementById('owner-properties-data');
    let ownerProperties = [];
    if (ownerPropsDataEl) {
        try {
            ownerProperties = JSON.parse(ownerPropsDataEl.textContent) || [];
        } catch (err) {
            ownerProperties = [];
        }
    }

    const phLocationMatrix = {
        'Caraga (Region XIII)': {
            provinces: {
                'Agusan del Norte': {
                    cities: {
                        'Butuan City': ['Poblacion', 'Ampayon', 'Bancasi', 'Libertad', 'Bading', 'Baan', 'Banza', 'Basag', 'Bitan-agan', 'Buenavista', 'Cabadbaran City', 'Carmen', 'Jabonga', 'Kitcharao', 'Las Nieves'],
                        'Quezon City': ['Ambatag', 'Bagbag', 'Bagong Pag-asa', 'Bagong Silang', 'Bahay Toro', 'Bakehan', 'Baloogan', 'Balingasa', 'Balintawak', 'Bambang', 'Barangka', 'Batasan', 'Culiat', 'Diliman', 'Kamuning'],
                        'Makati City': ['Bangkal', 'Bawang', 'Cembo', 'Comembo', 'Dasmarinas', 'East Rembo', 'Guadalupe Nuevo', 'Guadalupe Viejo', 'La Paz', 'Magallanes', 'Pembo', 'Pitogo', 'Poblacion', 'San Antonio', 'San Isidro'],
                        'Pasig City': ['Bagong Ilog', 'Bagong Pagasa', 'Bagong Silang', 'Barangka', 'Barangka Ibaba', 'Barangka Ilaya', 'Barubay', 'Binong Bato', 'Camias', 'Caniogan', 'Caruncho', 'Damayang Lagi', 'Dapithapon', 'Dollores', 'Ermitaño'],
                        'Mandaluyong City': ['Barangka', 'Barangka Ibaba', 'Barangka Ilaya', 'Baruti', 'Boni Serrano', 'Buayang Bato', 'Bulacao Uno', 'Bulacao Dos', 'Hagdang Bato Ilaya', 'Hagdang Bato Ibaba', 'Highway Hills', 'Mabini', 'Mauway', 'New Zaniga', 'Old Zaniga'],
                        'Taguig City': ['Bagumbayan', 'Bambang', 'Calero', 'Central Bicutan', 'Fort Bonifacio', 'Katuparan', 'Lower Bicutan', 'Maharlika', 'Napindan', 'Palingon', 'Pembo', 'Pinagsama', 'Pinagbuhatan', 'Pitogo', 'Rizal'],
                        'Pasay City': ['Baclaran', 'Barangay 1', 'Barangay 2-10', 'Malibay', 'San Isidro', 'Tambo', 'Villamor'],
                        'Las Piñas City': ['Almanza Uno', 'Almanza Dos', 'Almanza Tres', 'Angelis', 'Anilao', 'Asinan', 'Ayala', 'Ayala Alabang', 'Bacoor', 'Banaba', 'Banlat', 'Barangay 1-3'],
                        'Parañaque City': ['Baclaran', 'Barangay 1-10', 'Bicutan', 'Boni Serrano', 'Buncangan', 'Caltabellota'],
                        'Muntinlupa City': ['Alabang', 'Alabang Heights', 'Ayala Alabang', 'Ayala Heights', 'Ayala Southvale', 'Barangka', 'Bayan-Bayanan', 'Bayanihan', 'Bayanan', 'Buli', 'Casile', 'Cupang', 'Filinvest', 'Madrigal', 'Poblacion'],
                        'Marikina City': ['Angono', 'Barangka', 'Barangka Ibaba', 'Barangka Ilaya', 'Barangka Totolan', 'Baruti', 'Bayview', 'Calumpang', 'Camachile', 'Concepcion Uno', 'Concepcion Dos', 'Concepcion Tres', 'Damayang Lagi', 'Fejavi', 'Forest Hills'],
                        'Valenzuela City': ['Addasan', 'Akala', 'Alagaan', 'Anibling', 'Anod', 'Arkong Bato', 'Arugsaan', 'Asinan', 'Avaña', 'Aviles', 'Awangdaon', 'Ayusan', 'Bahay Toro', 'Bailagtasan', 'Balangkas'],
                        'Malabon City': ['Acacia', 'Baritan', 'Bayan-Bayanan', 'Catmon', 'Concepcion', 'Dampalit', 'Flores', 'Hulong Duhat', 'Ibaba', 'Ilong Laya', 'Kalookan', 'Konkong', 'Laya', 'Libis', 'Longos'],
                        'Navotas City': ['Bagumbayan North', 'Bagumbayan South', 'Bangculasi', 'Daanghari', 'Kaunlaran', 'Navotas', 'North Bay Boulevard North', 'North Bay Boulevard South', 'San Jose', 'San Rafael', 'Sipac-Almacen', 'Tagumpay', 'Tangos'],
                        'San Juan City': ['Addition Hills', 'Apolonio Samson', 'Balong-Bato', 'Batasan', 'Batasan Hills', 'Batisan', 'Corazon de Jesus', 'Ermitaño', 'Fernandez', 'Greenland', 'Greenhills', 'Isabelita', 'Kabayanan', 'Karangahan'],
                        'Caloocan City': ['Amparo', 'Baesa', 'Bagbag', 'Bagbaguin', 'Bagong Barrio', 'Bagong Ilog', 'Bagong Pag-asa', 'Bagong Silang', 'Bahay Toro', 'Balintawak', 'Banaba', 'Banadilla', 'Bancal', 'Bancoro', 'Baneg']
                    }
                }
            }
        },
        'Cordillera Administrative Region (CAR)': {
            provinces: {
                'Abra': {
                    cities: {
                        'Bangued': ['Alutin', 'Angaki', 'Balili', 'Bantay', 'Bayabas', 'Bayag', 'Bued', 'Buquiao', 'Calaban', 'Calao', 'Calinog', 'Calumbayan', 'Caramutan', 'Casiguran', 'Catbang'],
                        'Vigan City': ['Bantay', 'Cabatangan', 'Calinog', 'Daguiwang', 'Danglag', 'Kasiwaan', 'Malapad', 'Manganao', 'Naguili', 'Paeng', 'Pangpang', 'Rosario', 'San Nicolas', 'Santa Clara', 'Talugtug']
                    }
                },
                'Apayao': {
                    cities: {
                        'Kabugao': ['Badduat', 'Balooc', 'Buluan', 'Calanasan', 'Calang', 'Dagara', 'Dangoy', 'Langangen', 'Lettac', 'Luttuacan', 'Madatag', 'Magabta', 'Musimut', 'Nagbabalayan', 'Poblacion'],
                        'Conner': ['Allacapan', 'Bangla', 'Calanasan', 'Dipaling', 'Magasang', 'Magsaysay', 'Pangalawang', 'Poblacion', 'Rosario', 'San Juan', 'Sevilla', 'Tagac', 'Tamvanan', 'Tubao', 'Villafuerte']
                    }
                },
                'Benguet': {
                    cities: {
                        'Baguio City': ['Aurora Hill', 'Bakakeng Central', 'Bakakeng North', 'Bakakeng South', 'Balsigan', 'Brookside', 'Camp 1', 'Camp 7', 'Camp 8', 'Crystal Cave', 'Dagsian', 'Dizon Subdivision', 'Grovehill', 'Independence Hill', 'Loakan'],
                        'La Trinidad': ['Alapang', 'Alno', 'Ambiong', 'Bahong', 'Balili', 'Banengbeng', 'Beckel', 'Betag', 'Bineng', 'Botiwtiw', 'Cruz', 'Ibaloi', 'Lubas', 'Pico', 'Poblacion'],
                        'Tublay': ['Amlimay', 'Balangbang', 'Balili', 'Betang', 'Buguias', 'Cabangbang', 'Calatonga', 'Kapangan', 'Kayapa', 'Mulagbag', 'Natonin', 'Pasdong', 'Poblacion', 'Tawangan', 'Timpla']
                    }
                },
                'Ifugao': {
                    cities: {
                        'Lagawe': ['Ablan', 'Ambato', 'Anaba', 'Asin', 'Boliwong', 'Brgy. Ifugao', 'Burnay', 'Caba', 'Cudog', 'Dulao', 'Hapao', 'Hingyon', 'Hungduan', 'Kiangan', 'Lagawe']
                    }
                },
                'Kalinga': {
                    cities: {
                        'Tabuk City': ['Agbannawag', 'Appas', 'Bantay', 'Bato', 'Balong', 'Bulo', 'Bulanao', 'Butig', 'Cagaluan', 'Calanan', 'Gabu', 'Ilalim', 'Ileb', 'Lacnog', 'Laya'],
                        'Banaue': ['Alab', 'Aguinaldo', 'Bacolor', 'Bacun', 'Balayan', 'Banaue', 'Basid', 'Bayombong', 'Butbut', 'Cabanglasan', 'Cabatuan', 'Calaocan', 'Calagayan', 'Calanagan', 'Calanasan']
                    }
                },
                'Mountain Province': {
                    cities: {
                        'Bontoc': ['Alab', 'Aguid', 'Antadao', 'Ambasing', 'Baculon', 'Balbalang', 'Bato', 'Biao', 'Bontoc Ili', 'Bontoc Poblacion', 'Botoan', 'Bugnay', 'Calutit', 'Cann-eo', 'Dalican'],
                        'Banawe': ['Alab', 'Aguinaldo', 'Ayangan', 'Bacolor', 'Bacun', 'Balayan', 'Banawe', 'Basid', 'Bayombong', 'Butbut', 'Cabanglasan', 'Cabatuan', 'Calaocan', 'Calagayan', 'Calanagan']
                    }
                }
            }
        },
        'Ilocos Region (Region I)': {
            provinces: {
                'Ilocos Norte': {
                    cities: {
                        'Laoag City': ['Balatong', 'Barit', 'Bacsil North', 'Bacsil South', 'Calaoagan', 'Caballuyasan', 'Cabaruan', 'Calayab', 'Calipay', 'Camaril', 'Camarines', 'Camaryocan', 'Capataan', 'Casili', 'Cavid'],
                        'Batac City': ['Amulung', 'Andres Blanco', 'Bangui', 'Bantay', 'Batac', 'Bung', 'Cabugao', 'Cabuagan', 'Cabunututan', 'Cadacad', 'Caiga', 'Calamagui', 'Calapatan', 'Caliguan', 'Camaril'],
                        'Paoay': ['Aguinaldo', 'Agtang', 'Alag', 'Alas-As', 'Banauad', 'Banzon', 'Barrio', 'Batangan', 'Batingal', 'Bayag', 'Biga', 'Binad', 'Bincalanan', 'Bintacan', 'Buaya']
                    }
                },
                'Ilocos Sur': {
                    cities: {
                        'Vigan City': ['Ayusan Norte', 'Ayusan Sur', 'Baay-Bayoan', 'Barangay I', 'Barangay II', 'Barangay III', 'Barangay IV', 'Barangay V', 'Barangay VI', 'Barangay VII', 'Barangay VIII', 'Barangay IX', 'Caoayan', 'Capangpangan', 'Cordova'],
                        'Candon City': ['Agtugao', 'Alingal', 'Alipaon', 'Alog', 'Amang', 'Ambag', 'Ambong', 'Amila', 'Amingal', 'Amoyo', 'Ampil', 'Ampolid', 'Andi', 'Andianon', 'Anduang']
                    }
                },
                'La Union': {
                    cities: {
                        'San Fernando City': ['Abangan', 'Abutin', 'Acop', 'Afga', 'Aglao', 'Aglubang', 'Agno', 'Agnew', 'Agpalban', 'Agpal', 'Aguis', 'Aitan', 'Alabel', 'Alibagu', 'Alindog'],
                        'Dagupan City': ['Bacayao Norte', 'Bacayao Sur', 'Balingasay', 'Baluyot', 'Bangkerohan', 'Bonuan Binday', 'Bonuan Gueset', 'Bonuan Sibonia', 'Bonuan Tondalian', 'Calasiao', 'Calmay', 'Carael', 'Catanghalan', 'Cataogan', 'Coliseum']
                    }
                },
                'Pangasinan': {
                    cities: {
                        'Dagupan City': ['Bacayao Norte', 'Bacayao Sur', 'Bonuan Binday', 'Bonuan Gueset', 'Bonuan Sibonia', 'Bonuan Tondalian', 'Burlas', 'Calmay', 'Calasiao', 'Carael', 'Catanghalan', 'Cataogan', 'Coliseum', 'De los Reyes', 'Dolooy'],
                        'San Carlos City': ['Anonas', 'Bacnar', 'Balayang', 'Balococ', 'Bani', 'Bantog', 'Banton', 'Baoy', 'Barangay 1', 'Barangay 2', 'Barangay 3', 'Barangay 4', 'Barangay 5', 'Barangay 6', 'Barangay 7'],
                        'Urdaneta City': ['Balintawak', 'Balite', 'Balungis', 'Banaoang', 'Banasahan', 'Banawe', 'Bangar', 'Bangga', 'Banisilon', 'Bano', 'Baoayan', 'Barasan', 'Baras', 'Baratiang', 'Barbaza']
                    }
                }
            }
        },
        'Cagayan Valley (Region II)': {
            provinces: {
                'Batanes': {
                    cities: {
                        'Basco': ['Babuyan', 'Calagiao', 'Chavayan', 'Itbayat', 'Ivaña', 'Mahatao', 'Sabtang', 'San Vicente', 'Uyugan']
                    }
                },
                'Cagayan': {
                    cities: {
                        'Tuguegarao City': ['Bagay', 'Buntun', 'Carig', 'Cataggaman', 'Gosi Norte', 'Gosi Sur', 'Larion Alto', 'Larion Bajo', 'Leonarda', 'Libag Norte', 'Libag Sur', 'Namabbalan Norte', 'Namabbalan Sur', 'Penablanca', 'Piat'],
                        'Aparri': ['Alunan', 'Angadanan', 'Angat', 'Aparri', 'Cabagan', 'Cabayugan', 'Calavite', 'Camalig', 'Campanaan', 'Dalog', 'Dinglasan', 'Dumabac', 'Gattaran', 'Iguig', 'Lal-lo']
                    }
                },
                'Isabela': {
                    cities: {
                        'Ilagan City': ['Alicia', 'Angadanan', 'Aurora', 'Benito Soliven', 'Burgos', 'Cabagan', 'Cabatuan', 'Cauayan City', 'Cordon', 'Delfin Albano', 'Divilacan', 'Echague', 'Gamu', 'Graceville', 'Iguig'],
                        'Santiago City': ['Alicia', 'Angadanan', 'Aurora', 'Benito Soliven', 'Burgos', 'Cabagan', 'Cabatuan', 'Cauayan City', 'Cordon', 'Delfin Albano', 'Divilacan', 'Echague', 'Gamu', 'Graceville', 'Iguig']
                    }
                },
                'Nueva Vizcaya': {
                    cities: {
                        'Bayombong': ['Alangalang', 'Ambaguio', 'Aritao', 'Bagabag', 'Bambang', 'Bayombong', 'Diadi', 'Dupax del Norte', 'Dupax del Sur', 'Kasibu', 'Kayapa', 'Quezon', 'Santa Fe', 'Solano', 'Villaverde']
                    }
                },
                'Quirino': {
                    cities: {
                        'Cabarroguis': ['Aglipay', 'Cabarroguis', 'Diffun', 'Maddela', 'Nagtipunan', 'Saguday']
                    }
                }
            }
        },
        'Central Luzon (Region III)': {
            provinces: {
                'Aurora': {
                    cities: {
                        'Baler': ['Poblacion', 'Baler', 'Casiguran', 'Dilasag', 'Dinalungan', 'Dingalan', 'Dipaculao', 'Maria Aurora', 'San Luis', 'Baler', 'Casiguran', 'Dilasag', 'Dinalungan', 'Dingalan', 'Dipaculao']
                    }
                },
                'Bataan': {
                    cities: {
                        'Balanga City': ['Poblacion', 'Abucay', 'Bagac', 'Dinalupihan', 'Hermosa', 'Limay', 'Mariveles', 'Morong', 'Orani', 'Orion', 'Pilar', 'Samal', 'Abucay', 'Bagac', 'Dinalupihan']
                    }
                },
                'Bulacan': {
                    cities: {
                        'Malolos City': ['Poblacion', 'Angat', 'Balagtas', 'Baliuag', 'Bocaue', 'Bulakan', 'Bustos', 'Calumpit', 'Doña Remedios Trinidad', 'Guiguinto', 'Hagonoy', 'Marilao', 'Meycauayan City', 'Norzagaray', 'Obando'],
                        'San Jose del Monte City': ['Poblacion', 'Bagong Silang', 'Bancal', 'Bancal', 'Bancal', 'Bancal', 'Bancal', 'Bancal', 'Bancal', 'Bancal', 'Bancal', 'Bancal', 'Bancal', 'Bancal', 'Bancal']
                    }
                },
                'Nueva Ecija': {
                    cities: {
                        'Cabanatuan City': ['Poblacion', 'Aliaga', 'Bongabon', 'Cabiao', 'Carranglan', 'Cuyapo', 'Gabaldon', 'General Mamerto Natividad', 'General Tinio', 'Guimba', 'Jaen', 'Laur', 'Licab', 'Llanera', 'Lupao'],
                        'Palayan City': ['Poblacion', 'Aurora', 'Bongabon', 'Cabiao', 'Carranglan', 'Cuyapo', 'Gabaldon', 'General Mamerto Natividad', 'General Tinio', 'Guimba', 'Jaen', 'Laur', 'Licab', 'Llanera', 'Lupao']
                    }
                },
                'Pampanga': {
                    cities: {
                        'Angeles City': ['Poblacion', 'Amsic', 'Anunas', 'Balibago', 'Capaya', 'Cutcut', 'Cutud', 'Malabanias', 'Malino', 'Mining', 'Pampang', 'Pandan', 'Pulungbulu', 'Pulung Cacutud', 'Pulung Maragul'],
                        'San Fernando City': ['Poblacion', 'Alasas', 'Baliti', 'Bulaon', 'Calulut', 'Del Carmen', 'Del Pilar', 'Del Rosario', 'Dolores', 'Lara', 'Maimpis', 'Malino', 'Malpitic', 'Pandaras', 'Panipuan']
                    }
                },
                'Tarlac': {
                    cities: {
                        'Tarlac City': ['Poblacion', 'Anao', 'Bamban', 'Camiling', 'Capas', 'Concepcion', 'Gerona', 'La Paz', 'Mayantoc', 'Moncada', 'Paniqui', 'Pura', 'Ramos', 'San Clemente', 'San Jose']
                    }
                },
                'Zambales': {
                    cities: {
                        'Olongapo City': ['Poblacion', 'Asinan', 'Banicain', 'Barretto', 'East Bajac-Bajac', 'Gordon Heights', 'Kalaklan', 'Mabayuan', 'New Cabalan', 'New Ilalim', 'New Kababae', 'New Kalalake', 'Old Cabalan', 'Pag-asa', 'Santa Rita']
                    }
                }
            }
        },
        'Calabarzon (Region IV-A)': {
            provinces: {
                'Batangas': {
                    cities: {
                        'Batangas City': ['Poblacion', 'Alitagtag', 'Balayan', 'Balete', 'Bauan', 'Calaca', 'Calatagan', 'Cuenca', 'Ibaan', 'Laurel', 'Lemery', 'Lian', 'Lipa City', 'Lobo', 'Mabini'],
                        'Lipa City': ['Poblacion', 'Anilao', 'Balete', 'Bauan', 'Calaca', 'Calatagan', 'Cuenca', 'Ibaan', 'Laurel', 'Lemery', 'Lian', 'Lipa City', 'Lobo', 'Mabini', 'Malvar']
                    }
                },
                'Cavite': {
                    cities: {
                        'Cavite City': ['Poblacion', 'Bacoor', 'Carmona', 'Dasmariñas City', 'General Mariano Alvarez', 'General Trias', 'Imus', 'Indang', 'Kawit', 'Magallanes', 'Maragondon', 'Mendez', 'Naic', 'Noveleta', 'Rosario'],
                        'Tagaytay City': ['Poblacion', 'Aguinaldo', 'Alfonso', 'Amadeo', 'Bacoor', 'Carmona', 'Dasmariñas City', 'General Mariano Alvarez', 'General Trias', 'Imus', 'Indang', 'Kawit', 'Magallanes', 'Maragondon', 'Mendez']
                    }
                },
                'Laguna': {
                    cities: {
                        'Calamba City': ['Poblacion', 'Alaminos', 'Bay', 'Biñan City', 'Cabuyao', 'Calauan', 'Cavinti', 'Famy', 'Kalayaan', 'Liliw', 'Los Baños', 'Luisiana', 'Lumban', 'Mabitac', 'Magdalena'],
                        'San Pablo City': ['Poblacion', 'Alaminos', 'Bay', 'Biñan City', 'Cabuyao', 'Calauan', 'Cavinti', 'Famy', 'Kalayaan', 'Liliw', 'Los Baños', 'Luisiana', 'Lumban', 'Mabitac', 'Magdalena']
                    }
                },
                'Quezon': {
                    cities: {
                        'Lucena City': ['Poblacion', 'Agdangan', 'Alabat', 'Atimonan', 'Buenavista', 'Burdeos', 'Calauag', 'Candelaria', 'Catanauan', 'Dolores', 'General Luna', 'General Nakar', 'Guinayangan', 'Gumaca', 'Infanta']
                    }
                },
                'Rizal': {
                    cities: {
                        'Antipolo City': ['Poblacion', 'Angono', 'Baras', 'Binangonan', 'Cainta', 'Cardona', 'Jalajala', 'Morong', 'Pililla', 'Rodriguez', 'San Mateo', 'Tanay', 'Taytay', 'Teresa', 'Antipolo City']
                    }
                }
            }
        },
        'Mimaropa (Region IV-B)': {
            provinces: {
                'Marinduque': {
                    cities: {
                        'Boac': ['Poblacion', 'Buenavista', 'Gasan', 'Mogpog', 'Santa Cruz', 'Torrijos', 'Buenavista', 'Gasan', 'Mogpog', 'Santa Cruz', 'Torrijos', 'Buenavista', 'Gasan', 'Mogpog', 'Santa Cruz']
                    }
                },
                'Occidental Mindoro': {
                    cities: {
                        'Mamburao': ['Poblacion', 'Abra de Ilog', 'Calintaan', 'Lubang', 'Magsaysay', 'Paluan', 'Rizal', 'Sablayan', 'San Jose', 'Santa Cruz', 'Abra de Ilog', 'Calintaan', 'Lubang', 'Magsaysay', 'Paluan']
                    }
                },
                'Oriental Mindoro': {
                    cities: {
                        'Calapan City': ['Poblacion', 'Baco', 'Bansud', 'Bongabong', 'Bulalacao', 'Gloria', 'Mansalay', 'Naujan', 'Pinamalayan', 'Pola', 'Puerto Galera', 'Roxas', 'San Teodoro', 'Socorro', 'Victoria']
                    }
                },
                'Palawan': {
                    cities: {
                        'Puerto Princesa City': ['Poblacion', 'Aborlan', 'Agutaya', 'Araceli', 'Balabac', 'Bataraza', 'Brooke\'s Point', 'Busuanga', 'Cagayancillo', 'Coron', 'Culion', 'Cuyo', 'Dumaran', 'El Nido', 'Kalayaan']
                    }
                },
                'Romblon': {
                    cities: {
                        'Romblon': ['Poblacion', 'Alcantara', 'Banton', 'Cajidiocan', 'Calatrava', 'Concepcion', 'Corcuera', 'Ferrol', 'Looc', 'Magdiwang', 'Odiongan', 'San Agustin', 'San Andres', 'San Fernando', 'Santa Fe']
                    }
                }
            }
        },
        'Bicol Region (Region V)': {
            provinces: {
                'Albay': {
                    cities: {
                        'Legazpi City': ['Poblacion', 'Bacacay', 'Camalig', 'Daraga', 'Guinobatan', 'Jovellar', 'Libon', 'Ligao City', 'Malilipot', 'Malinao', 'Manito', 'Oas', 'Pio Duran', 'Polangui', 'Rapu-Rapu']
                    }
                },
                'Camarines Norte': {
                    cities: {
                        'Daet': ['Poblacion', 'Basud', 'Capalonga', 'Daet', 'Jose Panganiban', 'Labo', 'Mercedes', 'Paracale', 'San Lorenzo Ruiz', 'San Vicente', 'Santa Elena', 'Talisay', 'Vinzons', 'Basud', 'Capalonga']
                    }
                },
                'Camarines Sur': {
                    cities: {
                        'Naga City': ['Poblacion', 'Baao', 'Balatan', 'Bato', 'Bombon', 'Buhi', 'Bula', 'Cabusao', 'Calabanga', 'Camaligan', 'Canaman', 'Caramoan', 'Del Gallego', 'Gainza', 'Garchitorena'],
                        'Iriga City': ['Poblacion', 'Baao', 'Balatan', 'Bato', 'Bombon', 'Buhi', 'Bula', 'Cabusao', 'Calabanga', 'Camaligan', 'Canaman', 'Caramoan', 'Del Gallego', 'Gainza', 'Garchitorena']
                    }
                },
                'Catanduanes': {
                    cities: {
                        'Virac': ['Poblacion', 'Bagamanoc', 'Baras', 'Bato', 'Caramoran', 'Gigmoto', 'Pandan', 'Panganiban', 'San Andres', 'San Miguel', 'Viga', 'Bagamanoc', 'Baras', 'Bato', 'Caramoran']
                    }
                },
                'Masbate': {
                    cities: {
                        'Masbate City': ['Poblacion', 'Aroroy', 'Baleno', 'Balud', 'Batuan', 'Cataingan', 'Cawayan', 'Claveria', 'Dimasalang', 'Esperanza', 'Mandaon', 'Milagros', 'Mobo', 'Monreal', 'Palanas']
                    }
                },
                'Sorsogon': {
                    cities: {
                        'Sorsogon City': ['Poblacion', 'Barcelona', 'Bulan', 'Bulusan', 'Casiguran', 'Castilla', 'Donsol', 'Gubat', 'Irosin', 'Juban', 'Magallanes', 'Matnog', 'Pilar', 'Prieto Diaz', 'Santa Magdalena']
                    }
                }
            }
        },
        'Western Visayas (Region VI)': {
            provinces: {
                'Aklan': {
                    cities: {
                        'Kalibo': ['Poblacion', 'Altavas', 'Balete', 'Banga', 'Batan', 'Buruanga', 'Ibajay', 'Lezo', 'Libacao', 'Madalag', 'Makato', 'Malay', 'Malinao', 'Nabas', 'New Washington']
                    }
                },
                'Antique': {
                    cities: {
                        'San Jose': ['Poblacion', 'Anini-y', 'Barbaza', 'Belison', 'Bugasong', 'Caluya', 'Culasi', 'Hamtic', 'Laua-an', 'Libertad', 'Pandan', 'Patnongon', 'San Jose', 'San Remigio', 'Sebaste']
                    }
                },
                'Capiz': {
                    cities: {
                        'Roxas City': ['Poblacion', 'Cuartero', 'Dao', 'Dumalag', 'Dumarao', 'Ivisan', 'Jamindan', 'Ma-ayon', 'Mambusao', 'Panay', 'Panitan', 'Pilar', 'Pontevedra', 'President Roxas', 'Sapi-an']
                    }
                },
                'Guimaras': {
                    cities: {
                        'Jordan': ['Poblacion', 'Buenavista', 'Jordan', 'Nueva Valencia', 'San Lorenzo', 'Sibunag', 'Buenavista', 'Jordan', 'Nueva Valencia', 'San Lorenzo', 'Sibunag', 'Buenavista', 'Jordan', 'Nueva Valencia', 'San Lorenzo']
                    }
                },
                'Iloilo': {
                    cities: {
                        'Iloilo City': ['Poblacion', 'Ajuy', 'Alimodian', 'Anilao', 'Badiangan', 'Balasan', 'Banate', 'Barotac Nuevo', 'Barotac Viejo', 'Bingawan', 'Cabatuan', 'Calinog', 'Carles', 'Concepcion', 'Dingle'],
                        'Passi City': ['Poblacion', 'Ajuy', 'Alimodian', 'Anilao', 'Badiangan', 'Balasan', 'Banate', 'Barotac Nuevo', 'Barotac Viejo', 'Bingawan', 'Cabatuan', 'Calinog', 'Carles', 'Concepcion', 'Dingle']
                    }
                },
                'Negros Occidental': {
                    cities: {
                        'Bacolod City': ['Poblacion', 'Bago City', 'Binalbagan', 'Calatrava', 'Candoni', 'Cauayan', 'Enrique B. Magalona', 'Himamaylan City', 'Hinigaran', 'Hinoba-an', 'Ilog', 'Isabela', 'La Carlota City', 'La Castellana', 'La Libertad']
                    }
                }
            }
        },
        'Central Visayas (Region VII)': {
            provinces: {
                'Bohol': {
                    cities: {
                        'Tagbilaran City': ['Poblacion', 'Alburquerque', 'Alicia', 'Anda', 'Antequera', 'Baclayon', 'Balilihan', 'Batuan', 'Bien Unido', 'Bilar', 'Buenavista', 'Calape', 'Candijay', 'Carmen', 'Catigbian']
                    }
                },
                'Cebu': {
                    cities: {
                        'Cebu City': ['Poblacion', 'Alcantara', 'Alcoy', 'Alegria', 'Aloguinsan', 'Argao', 'Asturias', 'Badian', 'Balamban', 'Bantayan', 'Barili', 'Bogo City', 'Boljoon', 'Borbon', 'Carcar City'],
                        'Lapu-Lapu City': ['Poblacion', 'Alcantara', 'Alcoy', 'Alegria', 'Aloguinsan', 'Argao', 'Asturias', 'Badian', 'Balamban', 'Bantayan', 'Barili', 'Bogo City', 'Boljoon', 'Borbon', 'Carcar City'],
                        'Mandaue City': ['Poblacion', 'Alcantara', 'Alcoy', 'Alegria', 'Aloguinsan', 'Argao', 'Asturias', 'Badian', 'Balamban', 'Bantayan', 'Barili', 'Bogo City', 'Boljoon', 'Borbon', 'Carcar City']
                    }
                },
                'Negros Oriental': {
                    cities: {
                        'Dumaguete City': ['Poblacion', 'Amlan', 'Ayungon', 'Bacong', 'Bais City', 'Basay', 'Bayawan City', 'Bindoy', 'Canlaon City', 'Dauin', 'Guihulngan City', 'Jimalalud', 'La Libertad', 'Mabinay', 'Manjuyod']
                    }
                },
                'Siquijor': {
                    cities: {
                        'Siquijor': ['Poblacion', 'Enrique Villanueva', 'Larena', 'Lazi', 'Maria', 'San Juan', 'Siquijor', 'Enrique Villanueva', 'Larena', 'Lazi', 'Maria', 'San Juan', 'Siquijor', 'Enrique Villanueva', 'Larena']
                    }
                }
            }
        },
        'Eastern Visayas (Region VIII)': {
            provinces: {
                'Biliran': {
                    cities: {
                        'Naval': ['Poblacion', 'Almeria', 'Biliran', 'Cabucgayan', 'Caibiran', 'Culaba', 'Kawayan', 'Maripipi', 'Naval', 'Almeria', 'Biliran', 'Cabucgayan', 'Caibiran', 'Culaba', 'Kawayan']
                    }
                },
                'Eastern Samar': {
                    cities: {
                        'Borongan City': ['Poblacion', 'Arteche', 'Balangiga', 'Balangkayan', 'Can-avid', 'Dolores', 'General MacArthur', 'Giporlos', 'Guiuan', 'Hernani', 'Jipapad', 'Lawaan', 'Llorente', 'Maslog', 'Maydolong']
                    }
                },
                'Leyte': {
                    cities: {
                        'Tacloban City': ['Poblacion', 'Abuyog', 'Alangalang', 'Albuera', 'Babatngon', 'Barugo', 'Bato', 'Baybay City', 'Burauen', 'Calubian', 'Capoocan', 'Carigara', 'Dagami', 'Dulag', 'Hilongos'],
                        'Ormoc City': ['Poblacion', 'Abuyog', 'Alangalang', 'Albuera', 'Babatngon', 'Barugo', 'Bato', 'Baybay City', 'Burauen', 'Calubian', 'Capoocan', 'Carigara', 'Dagami', 'Dulag', 'Hilongos']
                    }
                },
                'Northern Samar': {
                    cities: {
                        'Catarman': ['Poblacion', 'Allen', 'Biri', 'Bobon', 'Capul', 'Catarman', 'Catubig', 'Gamay', 'Laoang', 'Lapinig', 'Las Navas', 'Lavezares', 'Mapanas', 'Mondragon', 'Palapag']
                    }
                },
                'Samar': {
                    cities: {
                        'Catbalogan City': ['Poblacion', 'Almagro', 'Basey', 'Calbayog City', 'Calbiga', 'Daram', 'Gandara', 'Hinabangan', 'Jiabong', 'Marabut', 'Matuguinao', 'Motiong', 'Pinabacdao', 'San Jorge', 'San Jose de Buan']
                    }
                },
                'Southern Leyte': {
                    cities: {
                        'Maasin City': ['Poblacion', 'Anahawan', 'Bontoc', 'Hinunangan', 'Hinundayan', 'Libagon', 'Liloan', 'Limasawa', 'Macrohon', 'Malitbog', 'Padre Burgos', 'Pintuyan', 'Saint Bernard', 'San Francisco', 'San Juan']
                    }
                }
            }
        },
        'Zamboanga Peninsula (Region IX)': {
            provinces: {
                'Zamboanga del Norte': {
                    cities: {
                        'Dipolog City': ['Poblacion', 'Bacungan', 'Baliguian', 'Dapitan City', 'Gutalac', 'Jose Dalman', 'Kalawit', 'Katipunan', 'La Libertad', 'Labason', 'Liloy', 'Manukan', 'Mutia', 'Piñan', 'Polanco']
                    }
                },
                'Zamboanga del Sur': {
                    cities: {
                        'Pagadian City': ['Poblacion', 'Aurora', 'Bayog', 'Dimataling', 'Dinas', 'Dumalinao', 'Dumingag', 'Guipos', 'Josefina', 'Kumalarang', 'Labangan', 'Lakewood', 'Lapuyan', 'Mahayag', 'Margosatubig']
                    }
                },
                'Zamboanga Sibugay': {
                    cities: {
                        'Ipil': ['Poblacion', 'Alicia', 'Buug', 'Diplahan', 'Imelda', 'Ipil', 'Kabasalan', 'Mabuhay', 'Malangas', 'Naga', 'Olutanga', 'Payao', 'Roseller Lim', 'Siay', 'Talusan']
                    }
                }
            }
        },
        'Northern Mindanao (Region X)': {
            provinces: {
                'Bukidnon': {
                    cities: {
                        'Malaybalay City': ['Poblacion', 'Baungon', 'Cabanglasan', 'Damulog', 'Dangcagan', 'Don Carlos', 'Impasugong', 'Kadingilan', 'Kalilangan', 'Kibawe', 'Kitaotao', 'Lantapan', 'Libona', 'Malitbog', 'Manolo Fortich']
                    }
                },
                'Camiguin': {
                    cities: {
                        'Mambajao': ['Poblacion', 'Catarman', 'Guinsiliban', 'Mahinog', 'Mambajao', 'Sagay', 'Catarman', 'Guinsiliban', 'Mahinog', 'Mambajao', 'Sagay', 'Catarman', 'Guinsiliban', 'Mahinog', 'Mambajao']
                    }
                },
                'Lanao del Norte': {
                    cities: {
                        'Tubod': ['Poblacion', 'Bacolod', 'Baloi', 'Baroy', 'Kapatagan', 'Kauswagan', 'Kolambugan', 'Lala', 'Linamon', 'Magsaysay', 'Maigo', 'Matungao', 'Munai', 'Nunungan', 'Pantao Ragat']
                    }
                },
                'Misamis Occidental': {
                    cities: {
                        'Oroquieta City': ['Poblacion', 'Aloran', 'Baliangao', 'Bonifacio', 'Calamba', 'Clarin', 'Concepcion', 'Jimenez', 'Lopez Jaena', 'Panaon', 'Plaridel', 'Sapang Dalaga', 'Sinacaban', 'Tangub City', 'Tudela']
                    }
                },
                'Misamis Oriental': {
                    cities: {
                        'Cagayan de Oro City': ['Poblacion', 'Alubijid', 'Balingasag', 'Balingoan', 'Binuangan', 'Claveria', 'El Salvador City', 'Gingoog City', 'Gitagum', 'Initao', 'Jasaan', 'Kinoguitan', 'Lagonglong', 'Laguindingan', 'Libertad']
                    }
                }
            }
        },
        'Davao Region (Region XI)': {
            provinces: {
                'Davao del Norte': {
                    cities: {
                        'Tagum City': ['Poblacion', 'Asuncion', 'Braulio E. Dujali', 'Carmen', 'Kapalong', 'New Corella', 'Panabo City', 'Samal City', 'San Isidro', 'Santo Tomas', 'Talaingod', 'Asuncion', 'Braulio E. Dujali', 'Carmen', 'Kapalong']
                    }
                },
                'Davao del Sur': {
                    cities: {
                        'Davao City': ['Poblacion', 'Bansalan', 'Davao City', 'Digos City', 'Hagonoy', 'Kiblawan', 'Magsaysay', 'Malalag', 'Matanao', 'Padada', 'Santa Cruz', 'Sulop', 'Bansalan', 'Davao City', 'Digos City']
                    }
                },
                'Davao Occidental': {
                    cities: {
                        'Malita': ['Poblacion', 'Don Marcelino', 'Jose Abad Santos', 'Malita', 'Santa Maria', 'Sarangani', 'Don Marcelino', 'Jose Abad Santos', 'Malita', 'Santa Maria', 'Sarangani', 'Don Marcelino', 'Jose Abad Santos', 'Malita', 'Santa Maria']
                    }
                },
                'Davao Oriental': {
                    cities: {
                        'Mati City': ['Poblacion', 'Baganga', 'Banaybanay', 'Boston', 'Caraga', 'Cateel', 'Governor Generoso', 'Lupon', 'Manay', 'Mati City', 'San Isidro', 'Tarragona', 'Baganga', 'Banaybanay', 'Boston']
                    }
                }
            }
        },
        'Soccsksargen (Region XII)': {
            provinces: {
                'Cotabato': {
                    cities: {
                        'Kidapawan City': ['Poblacion', 'Alamada', 'Aleosan', 'Antipas', 'Arakan', 'Banisilan', 'Carmen', 'Kabacan', 'Kidapawan City', 'Libungan', 'M\'lang', 'Magpet', 'Makilala', 'Matalam', 'Midsayap']
                    }
                },
                'Sarangani': {
                    cities: {
                        'Alabel': ['Poblacion', 'Alabel', 'Glan', 'Kiamba', 'Maasim', 'Maitum', 'Malapatan', 'Malungon', 'Alabel', 'Glan', 'Kiamba', 'Maasim', 'Maitum', 'Malapatan', 'Malungon']
                    }
                },
                'South Cotabato': {
                    cities: {
                        'Koronadal City': ['Poblacion', 'Banga', 'General Santos City', 'Koronadal City', 'Lake Sebu', 'Norala', 'Polomolok', 'Santo Niño', 'Surallah', 'T\'boli', 'Tampakan', 'Tantangan', 'Tupi', 'Banga', 'General Santos City']
                    }
                },
                'Sultan Kudarat': {
                    cities: {
                        'Isulan': ['Poblacion', 'Bagumbayan', 'Columbio', 'Esperanza', 'Isulan', 'Kalamansig', 'Lambayong', 'Lebak', 'Lutayan', 'Palimbang', 'President Quirino', 'Senator Ninoy Aquino', 'Tacurong City', 'Bagumbayan', 'Columbio']
                    }
                }
            }
        },
        'Caraga (Region XIII)': {
            provinces: {
                'Agusan del Norte': {
                    cities: {
                        'Butuan City': ['Poblacion', 'Ampayon', 'Bancasi', 'Libertad', 'Bading', 'Baan', 'Banza', 'Basag', 'Bitan-agan', 'Buenavista', 'Cabadbaran City', 'Carmen', 'Jabonga', 'Kitcharao', 'Las Nieves'],
                        'Cabadbaran City': ['Poblacion', 'Barangay 4', 'New Pandan', 'Ampayon', 'Bancasi', 'Libertad', 'Bading', 'Baan', 'Banza', 'Basag', 'Bitan-agan', 'Buenavista', 'Carmen', 'Jabonga', 'Kitcharao']
                    }
                },
                'Agusan del Sur': {
                    cities: {
                        'Prosperidad': ['Poblacion', 'Bunawan', 'Esperanza', 'La Paz', 'Loreto', 'Prosperidad', 'Rosario', 'San Francisco', 'San Luis', 'Santa Josefa', 'Sibagat', 'Talacogon', 'Trento', 'Veruela', 'Bunawan']
                    }
                },
                'Dinagat Islands': {
                    cities: {
                        'San Jose': ['Poblacion', 'Basilisa', 'Cagdianao', 'Dinagat', 'Libjo', 'Loreto', 'San Jose', 'Tubajon', 'Basilisa', 'Cagdianao', 'Dinagat', 'Libjo', 'Loreto', 'San Jose', 'Tubajon']
                    }
                },
                'Surigao del Norte': {
                    cities: {
                        'Surigao City': ['Poblacion', 'Taft', 'Washington', 'San Juan', 'Rizal', 'Canlanipa', 'Aurora', 'Bacuag', 'Burgos', 'Claver', 'Dapa', 'Del Carmen', 'General Luna', 'Gigaquit', 'Libjo'],
                        'Butuan City': ['Poblacion', 'Aclimon', 'Ampayon', 'Bancasi', 'Barangay 1', 'Barangay 2', 'Barangay 3', 'Barangay 4', 'Barangay 5', 'Barangay 6', 'Barangay 7', 'Barangay 8', 'Barangay 9', 'Barangay 10', 'Barangay 11'],
                        'Alegria': ['Poblacion', 'San Pedro', 'Camp Edward', 'Talacogon', 'Patrocinio', 'San Isidro', 'Andap', 'Cabadbaran', 'Caraga', 'Centerville', 'Esperanza', 'Lalawigan', 'San Antonio', 'San Luis', 'San Vicente'],
                        'Claver': ['Poblacion', 'Imbang', 'Malinao', 'San Carlos', 'Banibaniahan', 'Bugta', 'Camarines', 'Catadman', 'Daanlungsod', 'Garing', 'Guinlo', 'Libas', 'Mabago', 'Magpet', 'Mainit'],
                        'Gigaquit': ['Poblacion', 'Barangay 1', 'Barangay 2', 'Barangay 3', 'Barangay 4', 'Barangay 5', 'Barangay 6', 'Barangay 7', 'Barangay 8', 'Barangay 9', 'Barangay 10', 'Barangay 11', 'Barangay 12', 'Barangay 13', 'Barangay 14'],
                        'Mainit': ['Poblacion', 'Barangay 1', 'Barangay 2', 'Barangay 3', 'Barangay 4', 'Barangay 5', 'Barangay 6', 'Barangay 7', 'Barangay 8', 'Barangay 9', 'Barangay 10', 'Barangay 11', 'Barangay 12', 'Barangay 13', 'Barangay 14'],
                        'Placer': ['Poblacion', 'Barangay 1', 'Barangay 2', 'Barangay 3', 'Barangay 4', 'Barangay 5', 'Barangay 6', 'Barangay 7', 'Barangay 8', 'Barangay 9', 'Barangay 10', 'Barangay 11', 'Barangay 12', 'Barangay 13', 'Barangay 14'],
                        'Tagana-an': ['Poblacion', 'Barangay 1', 'Barangay 2', 'Barangay 3', 'Barangay 4', 'Barangay 5', 'Barangay 6', 'Barangay 7', 'Barangay 8', 'Barangay 9', 'Barangay 10', 'Barangay 11', 'Barangay 12', 'Barangay 13', 'Barangay 14'],
                        'Tandag': ['Poblacion', 'Barangay 1', 'Barangay 2', 'Barangay 3', 'Barangay 4', 'Barangay 5', 'Barangay 6', 'Barangay 7', 'Barangay 8', 'Barangay 9', 'Barangay 10', 'Barangay 11', 'Barangay 12', 'Barangay 13', 'Barangay 14'],
                        'Tubay': ['Poblacion', 'Barangay 1', 'Barangay 2', 'Barangay 3', 'Barangay 4', 'Barangay 5', 'Barangay 6', 'Barangay 7', 'Barangay 8', 'Barangay 9', 'Barangay 10', 'Barangay 11', 'Barangay 12', 'Barangay 13', 'Barangay 14']
                    }
                },
                'Surigao del Sur': {
                    cities: {
                        'Tandag City': ['Poblacion', 'Barobo', 'Bayabas', 'Bislig City', 'Cagwait', 'Cantilan', 'Carmen', 'Carrascal', 'Cortes', 'Hinatuan', 'Lanuza', 'Lianga', 'Lingig', 'Madrid', 'Marihatag']
                    }
                }
            }
        },
        'Bangsamoro Autonomous Region in Muslim Mindanao (BARMM)': {
            provinces: {
                'Basilan': {
                    cities: {
                        'Isabela City': ['Poblacion', 'Akbar', 'Al-Barka', 'Hadji Mohammad Ajul', 'Hadji Muhtamad', 'Isabela City', 'Lamitan City', 'Lantawan', 'Maluso', 'Sumisip', 'Tabuan-Lasa', 'Tipo-Tipo', 'Tuburan', 'Ungkaya Pukan', 'Akbar']
                    }
                },
                'Lanao del Sur': {
                    cities: {
                        'Marawi City': ['Poblacion', 'Ampatuan', 'Barira', 'Buldon', 'Buluan', 'Datu Abdullah Sangki', 'Datu Anggal Midtimbang', 'Datu Blah T. Sinsuat', 'Datu Hoffer Ampatuan', 'Datu Montawal', 'Datu Odin Sinsuat', 'Datu Paglas', 'Datu Piang', 'Datu Salibo', 'Datu Saudi-Ampatuan']
                    }
                },
                'Maguindanao': {
                    cities: {
                        'Cotabato City': ['Poblacion', 'Ampatuan', 'Barira', 'Buldon', 'Buluan', 'Datu Abdullah Sangki', 'Datu Anggal Midtimbang', 'Datu Blah T. Sinsuat', 'Datu Hoffer Ampatuan', 'Datu Montawal', 'Datu Odin Sinsuat', 'Datu Paglas', 'Datu Piang', 'Datu Salibo', 'Datu Saudi-Ampatuan']
                    }
                },
                'Sulu': {
                    cities: {
                        'Jolo': ['Poblacion', 'Banguingui', 'Hadji Panglima Tahil', 'Indanan', 'Jolo', 'Kalingalan Caluang', 'Lugus', 'Luuk', 'Maimbung', 'Old Panamao', 'Omar', 'Pandami', 'Panglima Estino', 'Pangutaran', 'Parang']
                    }
                },
                'Tawi-Tawi': {
                    cities: {
                        'Bongao': ['Poblacion', 'Bongao', 'Cagayan de Tawi-Tawi', 'Languyan', 'Mapun', 'Panglima Sugala', 'Sapa-Sapa', 'Sibutu', 'Simunul', 'Sitangkai', 'South Ubian', 'Tandubas', 'Turtle Islands', 'Bongao', 'Cagayan de Tawi-Tawi']
                    }
                }
            }
        }
    };

    const profileUser = {
        id: '{{ user.id|default:"local" }}',
        name: '{{ user.get_full_name|default:user.username|escapejs }}',
        email: '{{ user.email|escapejs }}',
        phone: '{{ user.profile.phone|default:""|escapejs }}',
        role: '{{ user.profile.get_role_display|default:user.profile.role|capfirst|escapejs }}',
        school: '{{ user.profile.school.name|default:"Independent Owner"|escapejs }}',
        joined: '{{ user.date_joined|date:"M d, Y"|escapejs }}'
    };

    const profileStateKey = `student_profile_settings_${profileUser.id}`;
    let profileState = {};
    try {
        profileState = JSON.parse(localStorage.getItem(profileStateKey)) || {};
    } catch (err) {
        profileState = {};
    }
    // Expose draft profile state for live previews across the page (not yet persisted until Save)
    try { window._ownerProfileDraft = profileState; } catch (e) { /* ignore */ }

    if (!Array.isArray(profileState.locations)) {
        profileState.locations = ownerProperties.map((prop, index) => ({
            id: prop.id || `prop-${index}`,
            label: prop.name || `Boarding House ${index + 1}`,
            region: '',
            province: prop.province || '',
            city: prop.city || '',
            barangay: '',
            address: prop.address || ''
        }));
    }

    if (!profileState.locations || !profileState.locations.length) {
        profileState.locations = [{
            id: 'loc-' + Date.now(),
            label: 'Primary Boarding House',
            region: '',
            province: '',
            city: '',
            barangay: '',
            address: ''
        }];
    }

    profileState.phone = profileState.phone || profileUser.phone || '';
    profileState.bio = profileState.bio || '';
    profileState.fullName = profileState.fullName || profileUser.name;
    profileState.photo = profileState.photo || '';

    const fullNameInput = document.getElementById('profile-full-name');
    const phoneInput = document.getElementById('profile-phone');
    const bioInput = document.getElementById('profile-bio');
    const saveBtn = document.getElementById('profile-save-btn');
    const photoPreview = document.getElementById('profile-photo-preview');
    const photoInput = document.getElementById('profile-photo-input');
    const photoRemoveBtn = document.getElementById('profile-photo-remove');
    const locationsWrapper = document.getElementById('location-entries');
    const addLocationBtn = document.getElementById('add-location-btn');

    if (fullNameInput) fullNameInput.value = profileState.fullName || '';
    if (phoneInput) phoneInput.value = profileState.phone || '';
    if (bioInput) bioInput.value = profileState.bio || '';

    function saveProfileState(showToast = false, persist = false) {
        // Persist to localStorage only when explicitly requested via `persist=true`.
        if (persist) {
            localStorage.setItem(profileStateKey, JSON.stringify(profileState));
        }
        // Dispatch custom event to update profile button in navigation (updates UI preview).
        document.dispatchEvent(new CustomEvent('profileUpdated'));
        if (showToast) {
            showMessage('Profile preferences saved.', persist ? 'success' : 'info');
        }
    }

    function updatePhotoPreview() {
        if (!photoPreview) return;
        if (profileState.photo) {
            photoPreview.src = profileState.photo;
            photoPreview.classList.remove('opacity-60');
        } else {
            photoPreview.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(profileState.fullName || profileUser.name)}&background=0D1117&color=00FFFF`;
            photoPreview.classList.add('opacity-60');
        }
    }

    updatePhotoPreview();

    if (photoInput) {
        photoInput.addEventListener('change', (event) => {
            const file = event.target.files && event.target.files[0];
            if (!file) return;
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                showMessage('Please choose an image under 10MB.', true);
                return;
            }
            const reader = new FileReader();
            reader.onload = () => {
                // Show crop modal
                const cropModal = document.getElementById('image-crop-modal');
                const cropImage = document.getElementById('crop-image');
                const cropPreviewImage = document.getElementById('crop-preview-image');
                cropImage.src = reader.result;
                cropPreviewImage.src = reader.result;
                cropModal.classList.remove('hidden');

                // Store temporary image data
                window.tempPhotoData = reader.result;
            };
            reader.readAsDataURL(file);
        });
    }

    if (photoRemoveBtn) {
        photoRemoveBtn.addEventListener('click', () => {
            profileState.photo = '';
            if (photoInput) photoInput.value = '';
            updatePhotoPreview();
            saveProfileState();
        });
    }

    // Crop Modal Functionality (uses Cropper.js for interactive cropping)
    // Add Cropper.js assets (CDN)
    const cropperCssLink = document.createElement('link');
    cropperCssLink.rel = 'stylesheet';
    cropperCssLink.href = 'https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css';
    document.head.appendChild(cropperCssLink);

    const cropperScript = document.createElement('script');
    cropperScript.src = 'https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js';
    document.head.appendChild(cropperScript);

    const cropModal = document.getElementById('image-crop-modal');
    const cropImage = document.getElementById('crop-image');
    const cropPreviewImage = document.getElementById('crop-preview-image');
    const cropModalClose = document.getElementById('crop-modal-close');
    const cropCancelBtn = document.getElementById('crop-cancel-btn');
    const cropConfirmBtn = document.getElementById('crop-confirm-btn');
    let cropper = null;

    function closeCropModal() {
        cropModal.classList.add('hidden');
        window.tempPhotoData = null;
        if (cropper) {
            try { cropper.destroy(); } catch (e) {}
            cropper = null;
        }
    }

    function updateCropPreview() {
        if (cropper && cropPreviewImage) {
            try {
                const canvas = cropper.getCroppedCanvas({ width: 250, height: 250 });
                cropPreviewImage.src = canvas.toDataURL('image/png');
            } catch (e) {
                // fallback
                cropPreviewImage.src = cropImage.src;
            }
        } else if (cropImage && cropPreviewImage) {
            cropPreviewImage.src = cropImage.src;
        }
    }

    if (cropModalClose) cropModalClose.addEventListener('click', closeCropModal);
    if (cropCancelBtn) cropCancelBtn.addEventListener('click', closeCropModal);

    // When a temporary image is loaded into the modal, instantiate Cropper
    function initCropperWhenReady() {
        // Wait until Cropper library is loaded
        if (typeof Cropper === 'undefined') {
            setTimeout(initCropperWhenReady, 100);
            return;
        }

        if (cropper) {
            try { cropper.destroy(); } catch (e) {}
            cropper = null;
        }

        cropper = new Cropper(cropImage, {
            aspectRatio: 1,
            viewMode: 1,
            background: false,
            autoCropArea: 1,
            movable: true,
            zoomable: true,
            responsive: true,
            crop() { updateCropPreview(); }
        });
        updateCropPreview();
    }

    if (cropConfirmBtn) {
        cropConfirmBtn.addEventListener('click', () => {
            if (cropper) {
                try {
                    const canvas = cropper.getCroppedCanvas({ width: 400, height: 400 });
                    profileState.photo = canvas.toDataURL('image/jpeg', 0.9);
                    updatePhotoPreview();
                    saveProfileState();
                    showMessage('✓ Profile photo updated!');
                } catch (e) {
                    showMessage('Could not crop the image. Please try a different file.', true);
                }
                closeCropModal();
            } else if (window.tempPhotoData) {
                // fallback to center-crop if cropper not available
                const img = new Image();
                img.onload = () => {
                    const size = Math.min(img.width, img.height);
                    const x = (img.width - size) / 2;
                    const y = (img.height - size) / 2;
                    const canvas = document.createElement('canvas');
                    canvas.width = size; canvas.height = size;
                    canvas.getContext('2d').drawImage(img, x, y, size, size, 0, 0, size, size);
                    profileState.photo = canvas.toDataURL('image/jpeg', 0.9);
                    updatePhotoPreview();
                    saveProfileState();
                    showMessage('✓ Profile photo updated!');
                    closeCropModal();
                };
                img.src = window.tempPhotoData;
            }
        });
    }

    if (cropModal) {
        cropModal.addEventListener('click', (e) => { if (e.target === cropModal) closeCropModal(); });
    }

    // When a file is selected, the existing change handler sets window.tempPhotoData and opens the modal.
    // Hook into that flow by observing changes to cropImage.src to initialize the cropper.
    const observer = new MutationObserver((mutations) => {
        for (const m of mutations) {
            if (m.type === 'attributes' && m.attributeName === 'src') {
                // Initialize cropper when cropImage has a new src
                if (cropImage.src) initCropperWhenReady();
            }
        }
    });
    if (cropImage) observer.observe(cropImage, { attributes: true });

    const regionOptions = Object.keys(phLocationMatrix);

    function populateSelect(selectEl, options, placeholder) {
        if (!selectEl) return;
        selectEl.innerHTML = `<option value="">${placeholder}</option>`;
        options.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option;
            opt.textContent = option;
            selectEl.appendChild(opt);
        });
    }

    function getProvinces(region) {
        if (!region || !phLocationMatrix[region]) return [];
        return Object.keys(phLocationMatrix[region].provinces || {});
    }

    function getCities(region, province) {
        if (!region || !province || !phLocationMatrix[region]) return [];
        const provinceData = phLocationMatrix[region].provinces || {};
        if (!provinceData[province]) return [];
        return Object.keys(provinceData[province].cities || {});
    }

    function getBarangays(region, province, city) {
        if (!region || !province || !city || !phLocationMatrix[region]) return [];
        const provinceData = phLocationMatrix[region].provinces || {};
        const cityData = provinceData[province] ? provinceData[province].cities || {} : {};
        return cityData[city] || [];
    }

    function updateLocation(locationId, changes) {
        const target = profileState.locations.find(loc => loc.id === locationId);
        if (!target) return;
        Object.assign(target, changes);
        saveProfileState();
    }

    function buildLocationEntry(location) {
        const template = document.getElementById('location-entry-template');
        if (!template) return document.createDocumentFragment();
        const fragment = template.content.cloneNode(true);
        const entryEl = fragment.querySelector('.location-entry');
        entryEl.dataset.locationId = location.id;

        const labelDisplay = entryEl.querySelector('.location-label-display');
        const labelInput = entryEl.querySelector('.location-label');
        const addressInput = entryEl.querySelector('.location-address');
        const regionSelect = entryEl.querySelector('.location-region');
        const provinceSelect = entryEl.querySelector('.location-province');
        const citySelect = entryEl.querySelector('.location-city');
        const barangaySelect = entryEl.querySelector('.location-barangay');
        const removeBtn = entryEl.querySelector('.remove-location-btn');

        const syncLabelDisplay = (value) => {
            labelDisplay.textContent = value ? `(${value})` : '';
        };

        if (labelInput) {
            labelInput.value = location.label || '';
            syncLabelDisplay(labelInput.value);
            labelInput.addEventListener('input', () => {
                updateLocation(location.id, { label: labelInput.value });
                syncLabelDisplay(labelInput.value);
            });
        }

        if (addressInput) {
            addressInput.value = location.address || '';
            addressInput.addEventListener('input', () => updateLocation(location.id, { address: addressInput.value }));
        }

        populateSelect(regionSelect, regionOptions, 'Select region');
        if (regionSelect) regionSelect.value = location.region || '';
        populateSelect(provinceSelect, getProvinces(location.region), 'Select province');
        if (provinceSelect) provinceSelect.value = location.province || '';
        populateSelect(citySelect, getCities(location.region, location.province), 'Select city');
        if (citySelect) citySelect.value = location.city || '';

        // Populate barangay with options based on selected city
        const barangayOptions = getBarangays(location.region, location.province, location.city);
        populateSelect(barangaySelect, barangayOptions, 'Select barangay');
        if (barangaySelect) barangaySelect.value = location.barangay || '';

        if (regionSelect) {
            regionSelect.addEventListener('change', () => {
                updateLocation(location.id, { region: regionSelect.value, province: '', city: '', barangay: '' });
                populateSelect(provinceSelect, getProvinces(regionSelect.value), 'Select province');
                populateSelect(citySelect, [], 'Select city');
                populateSelect(barangaySelect, [], 'Select barangay');
                if (barangaySelect) barangaySelect.value = '';
            });
        }

        if (provinceSelect) {
            provinceSelect.addEventListener('change', () => {
                updateLocation(location.id, { province: provinceSelect.value, city: '', barangay: '' });
                populateSelect(citySelect, getCities(regionSelect.value, provinceSelect.value), 'Select city');
                populateSelect(barangaySelect, [], 'Select barangay');
                if (citySelect) citySelect.value = '';
                if (barangaySelect) barangaySelect.value = '';
            });
        }

        if (citySelect) {
            citySelect.addEventListener('change', () => {
                updateLocation(location.id, { city: citySelect.value, barangay: '' });
                const newBarangays = getBarangays(regionSelect.value, provinceSelect.value, citySelect.value);
                populateSelect(barangaySelect, newBarangays, 'Select barangay');
                if (barangaySelect) barangaySelect.value = '';
            });
        }

        if (barangaySelect) {
            barangaySelect.addEventListener('change', () => {
                updateLocation(location.id, { barangay: barangaySelect.value });
            });
        }

        if (removeBtn) {
            removeBtn.addEventListener('click', () => {
                profileState.locations = profileState.locations.filter(loc => loc.id !== location.id);
                if (!profileState.locations.length) {
                    profileState.locations.push({
                        id: 'loc-' + Date.now(),
                        label: '',
                        region: '',
                        province: '',
                        city: '',
                        barangay: '',
                        address: ''
                    });
                }
                saveProfileState();
                renderLocations();
            });
        }

        return fragment;
    }

    function renderLocations() {
        if (!locationsWrapper) return;
        locationsWrapper.innerHTML = '';
        profileState.locations.forEach(location => {
            locationsWrapper.appendChild(buildLocationEntry(location));
        });
    }

    renderLocations();

    let isSaving = false; // Prevent multiple simultaneous saves

    if (addLocationBtn) {
        addLocationBtn.addEventListener('click', () => {
            profileState.locations.push({
                id: 'loc-' + Date.now(),
                label: '',
                region: '',
                province: '',
                city: '',
                barangay: '',
                address: ''
            });
            saveProfileState();
            renderLocations();
            showMessage('Location slot added.');
        });
    }

    if (saveBtn) {
        saveBtn.addEventListener('click', () => {
            // Prevent multiple simultaneous saves
            if (isSaving) return;
            isSaving = true;

            try {
                // Update fullName
                const priorFullName = profileState.fullName || profileUser.name;
                const newFullName = (fullNameInput?.value || profileUser.name).trim();
                profileState.fullName = newFullName;

                // Update other fields
                if (phoneInput) profileState.phone = phoneInput.value.trim();
                if (bioInput) profileState.bio = bioInput.value.trim();

                // Record name change time if name changed
                if (newFullName !== priorFullName) {
                    const lastNameChangeKey = `last_name_change_time_${userId}`;
                    localStorage.setItem(lastNameChangeKey, Date.now().toString());
                }

                // Save locations - add error handling
                try {
                    const locationEntries = document.querySelectorAll('.location-entry');
                    const updatedLocations = [];
                    locationEntries.forEach((entry, index) => {
                        try {
                            const location = profileState.locations[index] || { id: 'loc-' + Date.now() };
                            location.label = entry.querySelector('.location-label')?.value || location.label || '';
                            location.region = entry.querySelector('.location-region')?.value || location.region || '';
                            location.province = entry.querySelector('.location-province')?.value || location.province || '';
                            location.city = entry.querySelector('.location-city')?.value || location.city || '';
                            location.barangay = entry.querySelector('.location-barangay')?.value || location.barangay || '';
                            location.address = entry.querySelector('.location-address')?.value || location.address || '';
                            updatedLocations.push(location);
                        } catch (err) {
                            console.warn('Error processing location entry:', err);
                        }
                    });
                    profileState.locations = updatedLocations;
                } catch (err) {
                    console.warn('Error saving locations:', err);
                    // Continue saving even if locations have issues
                }

                // Save the profile state
                saveProfileState(true, true);

                // Visual feedback
                if (saveBtn) {
                    saveBtn.classList.add('opacity-75');
                    const originalText = saveBtn.textContent;
                    saveBtn.textContent = '✓ Saved';

                    setTimeout(() => {
                        if (saveBtn) {
                            saveBtn.classList.remove('opacity-75');
                            saveBtn.textContent = originalText;
                            saveBtn.disabled = false;
                        }
                        isSaving = false;
                        // Refresh page to ensure all data is saved and displayed
                        location.reload();
                    }, 1500);
                }
            } catch (error) {
                console.error('Error saving profile:', error);
                if (saveBtn) {
                    saveBtn.textContent = 'Save Profile';
                    saveBtn.disabled = false;
                    saveBtn.classList.remove('opacity-75');
                }
                isSaving = false;
                // Show a clear error message and keep the form open so the user can correct inputs
                try {
                    showMessage('Could not save profile — please review highlighted fields and try again.', 'error');
                } catch (e) {
                    // Fallback toast
                    console.warn('showMessage not available to display profile save error.');
                }
                // Do not reload the page — preserve user input so they can fix and retry
            }
        });
    }


    // ================================================================
    // BOARDING HOUSE KEY MANAGEMENT
    // ================================================================
    function initBoardingKeys() {
        const boardingKeyAutoInput = document.getElementById('boarding-key-auto');
        const boardingKeyCustomInput = document.getElementById('boarding-key-custom');
        const boardingKeyGenerateBtn = document.getElementById('boarding-key-generate');
        const boardingKeySetCustomBtn = document.getElementById('boarding-key-set-custom');
        const boardingKeyCopyAutoBtn = document.getElementById('boarding-key-copy-auto');
        const boardingKeyCopyCustomBtn = document.getElementById('boarding-key-copy-custom');
        const boardingKeyRemoveAutoBtn = document.getElementById('boarding-key-remove-auto');
        const boardingKeyRemoveCustomBtn = document.getElementById('boarding-key-remove-custom');

        // Modal elements
        const confirmModal = document.getElementById('boarding-key-confirm-modal');
        const removeModal = document.getElementById('boarding-key-remove-modal');
        const modalTitle = document.getElementById('boarding-key-modal-title');
        const modalMessage = document.getElementById('boarding-key-modal-message');
        const modalClose = document.getElementById('boarding-key-modal-close');
        const cancelBtn = document.getElementById('boarding-key-cancel-btn');
        const confirmBtn = document.getElementById('boarding-key-confirm-btn');

        const removeKeyModalClose = document.getElementById('remove-key-modal-close');
        const removeKeyCancelBtn = document.getElementById('remove-key-cancel-btn');
        const removeKeyConfirmBtn = document.getElementById('remove-key-confirm-btn');
        const removeKeyModalTitle = document.getElementById('remove-key-modal-title');
        const removeKeyModalMessage = document.getElementById('remove-key-modal-message');

        if (!boardingKeyAutoInput) {
            return;
        }

        const userId = '{{ user.id|default:"user_"|escapejs }}';
        const boardingKeyStateKey = `boarding_house_key_${userId}`;
        let pendingAction = null; // To track what action is pending
        let pendingRemoveType = null; // To track which key to remove

        function generateRandomKey(length = 8) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let key = '';
            for (let i = 0; i < length; i++) {
                key += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return key;
        }

        function loadBoardingKeys() {
            try {
                const saved = localStorage.getItem(boardingKeyStateKey);
                return saved ? JSON.parse(saved) : { autoKey: '', customKey: '' };
            } catch (err) {
                return { autoKey: '', customKey: '' };
            }
        }

        function saveBoardingKeys(keys) {
            localStorage.setItem(boardingKeyStateKey, JSON.stringify(keys));
        }

        function displayBoardingKeys() {
            const keys = loadBoardingKeys();
            boardingKeyAutoInput.value = keys.autoKey || '';
            boardingKeyCustomInput.value = keys.customKey || '';
        }

        function showToast(message) {
            if (typeof showMessage === 'function') {
                showMessage(message);
            } else {
                console.log(message);
            }
        }

        function showBoardingConfirmModal(title, message, action) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            pendingAction = action;
            confirmModal.classList.remove('hidden');
        }

        function hideBoardingConfirmModal() {
            confirmModal.classList.add('hidden');
            pendingAction = null;
        }

        function showRemoveModal(title, message, type) {
            removeKeyModalTitle.textContent = title;
            removeKeyModalMessage.textContent = message;
            pendingRemoveType = type;
            removeModal.classList.remove('hidden');
        }

        function hideRemoveModal() {
            removeModal.classList.add('hidden');
            pendingRemoveType = null;
        }

        function copyToClipboard(text) {
            if (!text) {
                showToast('No key to copy');
                return;
            }
            navigator.clipboard.writeText(text).then(() => {
                showToast('✓ Key copied to clipboard!');
            }).catch(() => {
                showToast('Failed to copy to clipboard');
            });
        }

        // Initialize keys on load
        displayBoardingKeys();

        // Confirm Modal close button
        if (modalClose) {
            modalClose.addEventListener('click', hideBoardingConfirmModal);
        }

        // Confirm Modal cancel button
        if (cancelBtn) {
            cancelBtn.addEventListener('click', hideBoardingConfirmModal);
        }

        // Confirm Modal confirm button
        if (confirmBtn) {
            confirmBtn.addEventListener('click', () => {
                if (pendingAction === 'generate') {
                    const newKey = generateRandomKey(8);
                    const keys = loadBoardingKeys();
                    keys.autoKey = newKey;
                    saveBoardingKeys(keys);
                    displayBoardingKeys();
                    showToast('✓ New boarding house key generated!');
                    hideBoardingConfirmModal();
                } else if (pendingAction === 'saveCustom') {
                    const customKey = boardingKeyCustomInput.value.trim();
                    if (!customKey) {
                        showToast('Please enter a custom key');
                        return;
                    }
                    const keys = loadBoardingKeys();
                    keys.customKey = customKey;
                    saveBoardingKeys(keys);
                    showToast('✓ Custom boarding house key saved!');
                    hideBoardingConfirmModal();
                }
            });
        }

        // Remove Modal close button
        if (removeKeyModalClose) {
            removeKeyModalClose.addEventListener('click', hideRemoveModal);
        }

        // Remove Modal cancel button
        if (removeKeyCancelBtn) {
            removeKeyCancelBtn.addEventListener('click', hideRemoveModal);
        }

        // Remove Modal confirm button
        if (removeKeyConfirmBtn) {
            removeKeyConfirmBtn.addEventListener('click', () => {
                const keys = loadBoardingKeys();
                if (pendingRemoveType === 'auto') {
                    keys.autoKey = '';
                    showToast('✓ Auto-generated key removed!');
                } else if (pendingRemoveType === 'custom') {
                    keys.customKey = '';
                    showToast('✓ Custom key removed!');
                }
                saveBoardingKeys(keys);
                displayBoardingKeys();
                hideRemoveModal();
            });
        }

        // Generate new auto key - show modal
        if (boardingKeyGenerateBtn) {
            boardingKeyGenerateBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                showBoardingConfirmModal(
                    'Generate New Key?',
                    'This will generate a new 8-character boarding house key. Your old key will be replaced.',
                    'generate'
                );
            });
        }

        // Save custom key - show modal
        if (boardingKeySetCustomBtn) {
            boardingKeySetCustomBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const customKey = boardingKeyCustomInput.value.trim();
                if (!customKey) {
                    showToast('Please enter a custom key first');
                    return;
                }
                showBoardingConfirmModal(
                    'Save Custom Key?',
                    `Are you sure you want to save "${customKey}" as your boarding house key?`,
                    'saveCustom'
                );
            });
        }

        // Remove auto key - show modal
        if (boardingKeyRemoveAutoBtn) {
            boardingKeyRemoveAutoBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const keys = loadBoardingKeys();
                if (!keys.autoKey) {
                    showToast('No auto-generated key to remove');
                    return;
                }
                showRemoveModal(
                    'Remove Auto-Generated Key?',
                    `Remove the key "${keys.autoKey}"? Students won't be able to use it anymore.`,
                    'auto'
                );
            });
        }

        // Remove custom key - show modal
        if (boardingKeyRemoveCustomBtn) {
            boardingKeyRemoveCustomBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const keys = loadBoardingKeys();
                if (!keys.customKey) {
                    showToast('No custom key to remove');
                    return;
                }
                showRemoveModal(
                    'Remove Custom Key?',
                    `Remove the key "${keys.customKey}"? Students won't be able to use it anymore.`,
                    'custom'
                );
            });
        }

        // Copy auto key - no modal, just toast
        if (boardingKeyCopyAutoBtn) {
            boardingKeyCopyAutoBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                copyToClipboard(boardingKeyAutoInput.value);
            });
        }

        // Copy custom key - no modal, just toast
        if (boardingKeyCopyCustomBtn) {
            boardingKeyCopyCustomBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                copyToClipboard(boardingKeyCustomInput.value);
            });
        }

        // Close modals when clicking outside
        if (confirmModal) {
            confirmModal.addEventListener('click', (e) => {
                if (e.target === confirmModal) {
                    hideConfirmModal();
                }
            });
        }

        if (removeModal) {
            removeModal.addEventListener('click', (e) => {
                if (e.target === removeModal) {
                    hideRemoveModal();
                }
            });
        }
    }

    // Name Change Cooldown Modal Handlers
    const nameCooldownModal = document.getElementById('name-cooldown-modal');
    const nameCooldownClose = document.getElementById('name-cooldown-close');
    const nameCooldownOkBtn = document.getElementById('name-cooldown-ok-btn');

    if (nameCooldownClose) {
        nameCooldownClose.addEventListener('click', () => {
            if (nameCooldownModal) nameCooldownModal.classList.add('hidden');
        });
    }

    if (nameCooldownOkBtn) {
        nameCooldownOkBtn.addEventListener('click', () => {
            if (nameCooldownModal) nameCooldownModal.classList.add('hidden');
        });
    }

    if (nameCooldownModal) {
        nameCooldownModal.addEventListener('click', (e) => {
            if (e.target === nameCooldownModal) {
                nameCooldownModal.classList.add('hidden');
            }
        });
    }

    // Initialize boarding keys
    if (document.getElementById('boarding-key-auto')) {
        initBoardingKeys();
    }
});
</script>
{% endif %}
{% endblock %}
