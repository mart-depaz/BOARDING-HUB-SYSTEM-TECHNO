{% extends 'base.html' %}

{% block title %}Boarding Student Management - Boarding Hub{% endblock %}

{% block header_title %}Safety Management Panel{% endblock %}
{% block current_view_title %}Boarding Student Management{% endblock %}

{% block sidebar %}
{% include 'admin_panel/_sidebar.html' %}
{% endblock %}

{% block content %}
<style>
    /* Custom scrollbar for students container - only shows on hover */
    #students-container::-webkit-scrollbar {
        width: 8px;
    }
    
    #students-container::-webkit-scrollbar-track {
        background: transparent;
    }
    
    #students-container::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 4px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    #students-container:hover::-webkit-scrollbar-thumb {
        opacity: 1;
    }
    
    #students-container::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
    }
    
    /* Firefox scrollbar */
    #students-container {
        scrollbar-color: transparent transparent;
        scrollbar-width: thin;
    }
    
    #students-container:hover {
        scrollbar-color: #cbd5e0 transparent;
    }
</style>

<header class="mb-8">
    <h2 class="text-4xl font-bold text-gray-900">Manage Students</h2>
    <p class="text-gray-500 mt-1">Full student registry organized by department and program.</p>
</header>

<div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
    <h3 class="text-2xl font-semibold text-gray-800 mb-4">Student Filters</h3>
    
    <form method="get" action="{% url 'admin_panel:students' %}" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div>
            <label for="search" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
            <input type="text" id="search" name="search" value="{{ search_query }}" placeholder="Search by name or ID..." 
                   class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        
        <div>
            <label for="department" class="block text-sm font-medium text-gray-700 mb-1">Department</label>
            <select id="department" name="department" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500">
                <option value="">All Departments</option>
                {% for dept in departments %}
                <option value="{{ dept.id }}" {% if selected_department == dept.id|stringformat:"s" %}selected{% endif %}>{{ dept.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div>
            <label for="program" class="block text-sm font-medium text-gray-700 mb-1">Program</label>
            <select id="program" name="program" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500">
                <option value="">All Programs</option>
                {% for prog in programs %}
                <option value="{{ prog.id }}" data-department="{{ prog.department.id }}" {% if selected_program == prog.id|stringformat:"s" %}selected{% endif %}>{{ prog.code|default:prog.name }} ({% if prog.department %}{{ prog.department.code|default:prog.department.name }}{% else %}â€”{% endif %})</option>
                {% endfor %}
            </select>
            <p id="program-help" class="text-xs text-gray-400 mt-1">Select a department first to pick a program.</p>
        </div>
        
        <div class="flex items-end">
            <button type="submit" class="w-full p-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition duration-300">
                Filter
            </button>
        </div>
    </form>
    
    <div class="mb-4 flex justify-between items-center">
        <div>
            <a href="{% url 'admin_panel:manage_departments' %}" class="text-indigo-600 hover:text-indigo-800 font-medium text-sm">
                <i class="fas fa-building mr-1"></i> Manage Departments
            </a>
            <span class="mx-2 text-gray-300">|</span>
            <a href="{% url 'admin_panel:manage_programs' %}" class="text-indigo-600 hover:text-indigo-800 font-medium text-sm">
                <i class="fas fa-graduation-cap mr-1"></i> Manage Programs
            </a>
        </div>
        <div class="text-sm text-gray-500">
            Total: {{ students|length }} student{{ students|length|pluralize }}
        </div>
    </div>
    
    <div class="overflow-x-auto" id="students-container" style="max-height: 600px; overflow-y: auto;">
        {% if students %}
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Name</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Program</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for student in students %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ student.user.get_full_name|default:student.user.username }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ student.student_id }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {% if student.department %}
                            <span class="px-2 py-1 bg-indigo-100 text-indigo-800 rounded-full text-xs">{{ student.department.code|default:student.department.name }}</span>
                        {% else %}
                            <span class="text-gray-400">Not assigned</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {% if student.program %}
                            <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">{{ student.program.code|default:student.program.name }}</span>
                        {% else %}
                            <span class="text-gray-400">Not assigned</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ student.user.email }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="text-center py-10 text-gray-500">
            <i class="fas fa-user-graduate text-4xl mb-4 text-gray-300"></i>
            <p>No students found matching your filters.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const deptSelect = document.getElementById('department');
    const progSelect = document.getElementById('program');
    const help = document.getElementById('program-help');

    function updateProgramOptions() {
        const deptVal = deptSelect.value;
        let anyEnabled = false;

        for (const opt of progSelect.options) {
            const optDept = opt.getAttribute('data-department') || '';

            // Keep the default "All Programs" option visible and enabled
            if (!opt.value) {
                opt.hidden = false;
                opt.disabled = false;
                continue;
            }

            if (!deptVal) {
                // Hide/disable program options when no department selected
                opt.hidden = true;
                opt.disabled = true;
            } else if (optDept === deptVal) {
                opt.hidden = false;
                opt.disabled = false;
                anyEnabled = true;
            } else {
                opt.hidden = true;
                opt.disabled = true;
            }
        }

        // Disable the select itself if there are no enabled program options or no department
        progSelect.disabled = !deptVal || !anyEnabled;

        // If the currently selected option became disabled, reset selection to default
        const selected = progSelect.value;
        const selOption = progSelect.querySelector('option[value="' + selected + '"]');
        if (!selected || (selOption && selOption.disabled)) {
            progSelect.value = '';
        }

        // Update help text visibility
        if (!deptVal) {
            help.style.display = 'block';
        } else {
            help.style.display = 'none';
        }
    }

    deptSelect.addEventListener('change', updateProgramOptions);

    // Initialize state on page load
    updateProgramOptions();
});
</script>

{% endblock %}
