{% extends 'base.html' %}

{% block title %}Survey Details - Boarding Hub{% endblock %}

{% block header_title %}Safety Management Panel{% endblock %}
{% block current_view_title %}Survey Details{% endblock %}

{% block sidebar %}
{% include 'admin_panel/_sidebar.html' %}
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto overflow-x-hidden">
    <header class="mb-4 relative">
        <div class="flex justify-between items-start gap-4">
            <div class="flex-1 min-w-0">
                <h2 class="text-xl font-bold text-gray-900 break-words">{{ survey.title }}</h2>
                <p class="text-sm text-gray-500 mt-1 break-words word-wrap" style="word-break: break-word; overflow-wrap: break-word; max-width: 100%;">{{ survey.description }}</p>
            </div>
            <a href="{% url 'admin_panel:survey_list' %}" class="px-3 py-1.5 bg-gray-200 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-300 transition">
                <i class="fas fa-arrow-left mr-1"></i>Back
            </a>
        </div>
    </header>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
    <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-indigo-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-xs text-gray-600 mb-1">Total Responses</p>
                <p class="text-xl font-bold text-indigo-600">{{ response_count }}</p>
            </div>
            <i class="fas fa-reply text-2xl text-indigo-200"></i>
        </div>
    </div>
    
    <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-yellow-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-xs text-gray-600 mb-1">Pending Review</p>
                <p class="text-xl font-bold text-yellow-600">{{ pending_count }}</p>
            </div>
            <i class="fas fa-clock text-2xl text-yellow-200"></i>
        </div>
    </div>
    
    <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-green-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-xs text-gray-600 mb-1">Approved</p>
                <p class="text-xl font-bold text-green-600">{{ approved_count }}</p>
            </div>
            <i class="fas fa-check-circle text-2xl text-green-200"></i>
        </div>
    </div>
    
    <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-blue-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-xs text-gray-600 mb-1">Registered</p>
                <p class="text-xl font-bold text-blue-600">{{ registered_count }}</p>
            </div>
            <i class="fas fa-user-check text-2xl text-blue-200"></i>
        </div>
    </div>
</div>

<div class="bg-white p-4 rounded-xl shadow-lg mb-4 overflow-hidden">
    <h3 class="text-lg font-bold text-gray-900 mb-3 break-words">Survey Information</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
            <p class="text-sm text-gray-600 mb-1">Status</p>
            <p class="font-semibold">
                <span class="px-3 py-1 rounded-full text-sm {% if survey.status == 'active' %}bg-green-100 text-green-700{% elif survey.status == 'draft' %}bg-yellow-100 text-yellow-700{% else %}bg-gray-100 text-gray-700{% endif %}">
                    {{ survey.get_status_display }}
                </span>
            </p>
        </div>
        <div>
            <p class="text-sm text-gray-600 mb-1">Category</p>
            <p class="font-semibold text-gray-900 break-words">{{ survey.category }}</p>
        </div>
        <div>
            <p class="text-sm text-gray-600 mb-1">Email Validation</p>
            <p class="font-semibold text-gray-900 break-words">{{ survey.get_email_validation_display }}</p>
        </div>
        <div>
            <p class="text-sm text-gray-600 mb-1">Property Info Required</p>
            <p class="font-semibold text-gray-900 break-words">{% if survey.require_property_info %}Yes{% else %}No{% endif %}</p>
        </div>
        <div>
            <p class="text-sm text-gray-600 mb-1">Unique Code</p>
            <p class="font-semibold text-gray-900 font-mono break-all">{{ survey.unique_code }}</p>
        </div>
        <div>
            <p class="text-sm text-gray-600 mb-1">Created</p>
            <p class="font-semibold text-gray-900">{{ survey.created_at|date:"M d, Y" }}</p>
        </div>
    </div>
</div>

<div class="bg-white p-4 rounded-xl shadow-lg mb-4 overflow-hidden">
    <h3 class="text-lg font-bold text-gray-900 mb-3 break-words">Shareable Survey Link</h3>
    <div class="flex items-center space-x-2">
        <input type="text" id="survey-link" value="{{ shareable_link }}" readonly 
               class="flex-1 p-2 border border-gray-300 rounded-lg bg-gray-50 font-mono text-xs min-w-0" style="overflow-x: auto; word-break: break-all;">
        <button onclick="copySurveyLink()" class="px-3 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-lg hover:bg-indigo-700 transition">
            <i class="fas fa-copy mr-1"></i>Copy
        </button>
    </div>
    <p class="text-xs text-gray-500 mt-2">Share this link with students to fill out the survey.</p>
</div>

<!-- Survey Layout Preview -->
<div class="bg-white p-4 rounded-xl shadow-lg mb-4 overflow-hidden">
    <h3 class="text-lg font-bold text-gray-900 mb-3 break-words">Survey Layout</h3>
    <p class="text-sm text-gray-600 mb-4 break-words">Preview of the survey structure with all sections and questions.</p>
    
    {% if sections %}
    <div class="space-y-4">
        {% for section in sections %}
        <div class="border-l-4 border-indigo-500 pl-4 overflow-hidden">
            <h4 class="text-base font-bold text-indigo-700 mb-3 break-words" style="word-break: break-word; overflow-wrap: break-word;">{{ forloop.counter }}. {{ section.title }}</h4>
            <div class="space-y-2">
                {% for question in section.questions.all %}
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 overflow-hidden">
                    <div class="flex items-start justify-between mb-1 gap-2">
                        <p class="text-sm font-semibold text-gray-800 break-words flex-1 min-w-0" style="word-break: break-word; overflow-wrap: break-word;">{{ forloop.parentloop.counter }}.{{ forloop.counter }}. {{ question.text }}</p>
                        {% if question.is_required %}
                        <span class="px-1.5 py-0.5 bg-red-100 text-red-700 rounded text-xs font-semibold ml-2">Required</span>
                        {% endif %}
                    </div>
                    <div class="flex items-center space-x-2 mt-1.5">
                        <span class="text-xs text-gray-500">Type:</span>
                        <span class="px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded text-xs font-semibold">
                            {% if question.question_type == 'text_short' %}Text (Short Answer)
                            {% elif question.question_type == 'text_long' %}Paragraph (Long Answer)
                            {% elif question.question_type == 'multiple_choice' %}Multiple Choice (Single Select)
                            {% elif question.question_type == 'checkbox' %}Select Multiple (Checkboxes)
                            {% elif question.question_type == 'rating' %}Rating (1-5 Stars)
                            {% else %}{{ question.question_type }}{% endif %}
                        </span>
                    </div>
                    {% if question.options %}
                    <div class="mt-2">
                        <p class="text-xs text-gray-600 mb-1">Options:</p>
                        <ul class="list-disc list-inside text-xs text-gray-700 space-y-0.5">
                            {% for option in question.options %}
                            <li>{{ option }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
                {% empty %}
                <p class="text-gray-400 italic text-xs">No questions in this section.</p>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-6 text-gray-500">
        <i class="fas fa-clipboard-list text-3xl mb-3 text-gray-300"></i>
        <p class="text-sm">No sections or questions added yet.</p>
        <a href="{% url 'admin_panel:survey_create' %}?id={{ survey.id }}" class="inline-block mt-3 px-3 py-1.5 bg-indigo-600 text-white text-sm font-semibold rounded-lg hover:bg-indigo-700 transition">
            <i class="fas fa-edit mr-1"></i>Edit Survey
        </a>
    </div>
    {% endif %}
</div>

<div class="flex space-x-2">
    <a href="{% url 'admin_panel:survey_responses' survey.id %}" class="px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-lg hover:bg-indigo-700 transition">
        <i class="fas fa-list mr-1"></i>View Responses
    </a>
    <a href="{% url 'admin_panel:survey_create' %}?id={{ survey.id }}" class="px-4 py-2 bg-gray-200 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-300 transition">
        <i class="fas fa-edit mr-1"></i>Edit
    </a>
</div>
</div>

<script>
function copySurveyLink() {
    const linkInput = document.getElementById('survey-link');
    linkInput.select();
    linkInput.setSelectionRange(0, 99999); // For mobile devices
    document.execCommand('copy');
    
    // Show feedback
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check mr-2"></i>Copied!';
    button.classList.add('bg-green-600');
    button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('bg-green-600');
        button.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
    }, 2000);
}
</script>
{% endblock %}

