{% extends 'base.html' %}

{% block title %}Manage Programs - Boarding Hub{% endblock %}

{% block header_title %}Safety Management Panel{% endblock %}
{% block current_view_title %}Manage Programs{% endblock %}

{% block sidebar %}
{% include 'admin_panel/_sidebar.html' %}
{% endblock %}

{% block back_button %}
<a href="{% url 'admin_panel:students' %}" class="mb-4 text-xs text-gray-500 hover:text-indigo-600 transition duration-200 flex items-center space-x-1 group inline-block">
    <i class="fas fa-arrow-left text-xs"></i>
    <span>Back to Students</span>
</a>
{% endblock %}

{% block content %}
<header class="mb-4">
    <h2 class="text-xl font-bold text-gray-900">Manage Programs</h2>
    <p class="text-sm text-gray-500 mt-1">Add, edit, and manage academic programs for your departments.</p>
</header>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
    <!-- Add Program Form -->
    <div class="bg-white p-4 rounded-xl shadow-lg">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Add New Program</h3>
        
        <form method="post" action="{% url 'admin_panel:manage_programs' %}">
            {% csrf_token %}
            <input type="hidden" name="action" value="add">
            
            <div class="space-y-3">
                <div>
                    <label for="department_id" class="block text-xs font-medium text-gray-700 mb-1">Department *</label>
                    <select id="department_id" name="department_id" required 
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        <option value="">Select Department</option>
                        {% for dept in departments %}
                        <option value="{{ dept.id }}">{{ dept.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="name" class="block text-xs font-medium text-gray-700 mb-1">Program Name *</label>
                    <input type="text" id="name" name="name" required 
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm"
                           placeholder="e.g., Bachelor of Science in Computer Science">
                </div>
                
                <div>
                    <label for="code" class="block text-xs font-medium text-gray-700 mb-1">Program Code</label>
                    <input type="text" id="code" name="code" maxlength="20"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm"
                           placeholder="e.g., BSCS">
                </div>
                
                <div>
                    <label for="description" class="block text-xs font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="description" name="description" rows="3"
                              class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm"
                              placeholder="Optional description..."></textarea>
                </div>
                
                <button type="submit" class="w-full p-2 bg-indigo-600 text-white text-sm font-semibold rounded-lg hover:bg-indigo-700 transition">
                    <i class="fas fa-plus mr-1"></i> Add Program
                </button>
            </div>
        </form>
    </div>
    
    <!-- Programs List -->
    <div class="bg-white p-4 rounded-xl shadow-lg">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Existing Programs</h3>
        
        {% if programs %}
        <div class="space-y-2 max-h-[600px] overflow-y-auto">
            {% for prog in programs %}
            <div class="border border-gray-200 rounded-lg p-3 {% if not prog.is_active %}opacity-60{% endif %}">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h4 class="text-sm font-semibold text-gray-900">{{ prog.name }}</h4>
                        <p class="text-xs text-indigo-600 mt-1">
                            <i class="fas fa-building mr-1 text-xs"></i> {{ prog.department.name }}
                        </p>
                        {% if prog.code %}
                        <p class="text-xs text-gray-500">Code: {{ prog.code }}</p>
                        {% endif %}
                        {% if prog.description %}
                        <p class="text-xs text-gray-600 mt-1">{{ prog.description }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-400 mt-1.5">
                            <i class="fas fa-users mr-1 text-xs"></i> {{ prog.students.count }} student{{ prog.students.count|pluralize }}
                        </p>
                    </div>
                    <div class="flex items-center">
                        {% if not prog.is_active %}
                        <span class="px-1.5 py-0.5 bg-gray-100 text-gray-600 rounded text-xs">Inactive</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="flex space-x-1.5 mt-2">
                    <form method="post" action="{% url 'admin_panel:manage_programs' %}" class="inline">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="toggle">
                        <input type="hidden" name="program_id" value="{{ prog.id }}">
                        <button type="submit" class="text-xs px-2 py-1 rounded {% if prog.is_active %}bg-yellow-100 text-yellow-700 hover:bg-yellow-200{% else %}bg-green-100 text-green-700 hover:bg-green-200{% endif %} transition">
                            {% if prog.is_active %}<i class="fas fa-eye-slash mr-0.5"></i> Deactivate{% else %}<i class="fas fa-eye mr-0.5"></i> Activate{% endif %}
                        </button>
                    </form>
                    
                    <button onclick="editProgram({{ prog.id }}, {{ prog.department.id }}, '{{ prog.name }}', '{{ prog.code }}', '{{ prog.description|escapejs }}')" 
                            class="text-xs px-2 py-1 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition">
                        <i class="fas fa-edit mr-0.5"></i> Edit
                    </button>
                    
                    <form method="post" action="{% url 'admin_panel:manage_programs' %}" class="inline" 
                          onsubmit="return confirm('Are you sure you want to delete this program? This action cannot be undone.');">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="delete">
                        <input type="hidden" name="program_id" value="{{ prog.id }}">
                        <button type="submit" class="text-xs px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 transition">
                            <i class="fas fa-trash mr-0.5"></i> Delete
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-6 text-gray-500">
            <i class="fas fa-graduation-cap text-3xl mb-3 text-gray-300"></i>
            <p class="text-sm">No programs added yet.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-xl p-4 max-w-md w-full mx-4">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Edit Program</h3>
        
        <form method="post" action="{% url 'admin_panel:manage_programs' %}">
            {% csrf_token %}
            <input type="hidden" name="action" value="edit">
            <input type="hidden" name="program_id" id="edit_prog_id">
            
            <div class="space-y-3">
                <div>
                    <label for="edit_department_id" class="block text-xs font-medium text-gray-700 mb-1">Department *</label>
                    <select id="edit_department_id" name="department_id" required 
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        {% for dept in departments %}
                        <option value="{{ dept.id }}">{{ dept.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="edit_name" class="block text-xs font-medium text-gray-700 mb-1">Program Name *</label>
                    <input type="text" id="edit_name" name="name" required 
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                </div>
                
                <div>
                    <label for="edit_code" class="block text-xs font-medium text-gray-700 mb-1">Program Code</label>
                    <input type="text" id="edit_code" name="code" maxlength="20"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                </div>
                
                <div>
                    <label for="edit_description" class="block text-xs font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="edit_description" name="description" rows="3"
                              class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm"></textarea>
                </div>
                
                <div class="flex space-x-2">
                    <button type="submit" class="flex-1 p-2 bg-indigo-600 text-white text-sm font-semibold rounded-lg hover:bg-indigo-700 transition">
                        Save Changes
                    </button>
                    <button type="button" onclick="closeEditModal()" class="flex-1 p-2 bg-gray-200 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-300 transition">
                        Cancel
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
function editProgram(id, deptId, name, code, description) {
    document.getElementById('edit_prog_id').value = id;
    document.getElementById('edit_department_id').value = deptId;
    document.getElementById('edit_name').value = name;
    document.getElementById('edit_code').value = code || '';
    document.getElementById('edit_description').value = description || '';
    document.getElementById('editModal').classList.remove('hidden');
}

function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
}

document.getElementById('editModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeEditModal();
    }
});
</script>
{% endblock %}

