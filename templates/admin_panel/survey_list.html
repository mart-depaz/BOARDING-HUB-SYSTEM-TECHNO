{% extends 'base.html' %}

{% block title %}Student Surveys - Boarding Hub{% endblock %}

{% block header_title %}Safety Management Panel{% endblock %}
{% block current_view_title %}Student Surveys{% endblock %}

{% block sidebar %}
{% include 'admin_panel/_sidebar.html' %}
{% endblock %}

{% block content %}
{% include 'admin_panel/modals/delete_survey_modal.html' %}

<div class="max-w-7xl mx-auto overflow-x-hidden">
    <header class="mb-4">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-xl font-bold text-gray-900">Student Surveys</h2>
                <p class="text-sm text-gray-500 mt-1">Create and manage student registration surveys.</p>
            </div>
            <a href="{% url 'admin_panel:survey_create' %}" class="px-3 py-1.5 bg-indigo-600 text-white text-sm font-semibold rounded-lg hover:bg-indigo-700 transition shadow-lg">
                <i class="fas fa-plus mr-1"></i>Create New
            </a>
        </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    {% for survey in surveys %}
    <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-200 hover:shadow-xl transition duration-300 overflow-hidden flex flex-col" style="min-height: 280px;">
        <div class="flex justify-between items-start mb-3 gap-2">
            <div class="flex-1 min-w-0 overflow-hidden">
                <h3 class="text-base font-bold text-gray-900 mb-1 break-words">{{ survey.title }}</h3>
                <p class="text-xs text-gray-600 mb-2" style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; word-break: break-word; word-wrap: break-word; max-width: 100%;">{{ survey.description|default:"No description provided." }}</p>
            </div>
            <div class="flex flex-col items-end space-y-1">
                <span class="px-2 py-0.5 rounded-full text-xs font-semibold {% if survey.status == 'active' %}bg-green-100 text-green-700{% elif survey.status == 'draft' %}bg-yellow-100 text-yellow-700{% else %}bg-gray-100 text-gray-700{% endif %}">
                    {{ survey.get_status_display }}
                </span>
                {% if survey.status == 'draft' %}
                <div class="flex space-x-1">
                    <a href="{% url 'admin_panel:survey_create' %}?id={{ survey.id }}" class="px-2 py-0.5 bg-indigo-600 text-white text-xs font-semibold rounded hover:bg-indigo-700 transition" title="Edit Survey">
                        <i class="fas fa-edit"></i>
                    </a>
                    <a href="{% url 'admin_panel:survey_create' %}?id={{ survey.id }}&preview=1" class="px-2 py-0.5 bg-teal-600 text-white text-xs font-semibold rounded hover:bg-teal-700 transition" title="Preview Survey">
                        <i class="fas fa-eye"></i>
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="space-y-1.5 mb-3 flex-grow">
            <div class="flex items-center text-xs text-gray-600">
                <i class="fas fa-clipboard-list mr-1.5 text-indigo-600 text-xs"></i>
                <span>{{ survey.sections.count }} Section{{ survey.sections.count|pluralize }}</span>
            </div>
            <div class="flex items-center text-xs text-gray-600">
                <i class="fas fa-reply mr-1.5 text-indigo-600 text-xs"></i>
                <span>{{ survey.responses.count }} Response{{ survey.responses.count|pluralize }}</span>
            </div>
            <div class="flex items-center text-xs text-gray-600">
                <i class="fas fa-clock mr-1.5 text-indigo-600 text-xs"></i>
                <span>Created {{ survey.created_at|date:"M d, Y" }}</span>
            </div>
        </div>
        
        <div class="mt-auto pt-3 border-t border-gray-200">
            {% if survey.status == 'active' %}
            <div class="mb-3">
                <div class="flex items-center space-x-2">
                    <input type="text" id="survey-link-{{ survey.id }}" value="{{ request.scheme }}://{{ request.get_host }}/survey/{{ survey.unique_code }}/" readonly 
                           class="flex-1 px-2 py-1 border border-gray-300 rounded bg-gray-50 font-mono text-xs min-w-0" 
                           style="overflow-x: auto; word-break: break-all; max-width: calc(100% - 60px);">
                    <button onclick="copySurveyLink(event, {{ survey.id }})" class="px-2 py-1 bg-indigo-600 text-white text-xs font-semibold rounded hover:bg-indigo-700 transition" title="Copy Link">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
            {% endif %}
            <div class="flex space-x-2">
                <a href="{% url 'admin_panel:survey_detail' survey.id %}" class="flex-1 px-2 py-1.5 bg-indigo-100 text-indigo-700 text-xs font-semibold rounded-lg hover:bg-indigo-200 transition text-center">
                    <i class="fas fa-eye mr-1"></i>View
                </a>
                <a href="{% url 'admin_panel:survey_responses' survey.id %}" class="flex-1 px-2 py-1.5 bg-green-100 text-green-700 text-xs font-semibold rounded-lg hover:bg-green-200 transition text-center">
                    <i class="fas fa-list mr-1"></i>Responses
                </a>
                <button onclick="openDeleteSurveyModal({{ survey.id }}, '{{ survey.title|escapejs }}', {{ survey.responses.count }})" class="px-2 py-1.5 bg-red-100 text-red-700 text-xs font-semibold rounded-lg hover:bg-red-200 transition" title="Delete Survey">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-span-full bg-white p-8 rounded-xl shadow-lg text-center">
        <i class="fas fa-clipboard-list text-4xl text-gray-300 mb-3"></i>
        <h3 class="text-lg font-bold text-gray-700 mb-1">No Surveys Yet</h3>
        <p class="text-sm text-gray-500 mb-4">Create your first student registration survey to get started.</p>
        <a href="{% url 'admin_panel:survey_create' %}" class="inline-block px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-lg hover:bg-indigo-700 transition">
            <i class="fas fa-plus mr-1"></i>Create Survey
        </a>
    </div>
    {% endfor %}
    </div>
</div>

<script>
function copySurveyLink(event, surveyId) {
    event.preventDefault();
    const linkInput = document.getElementById('survey-link-' + surveyId);
    linkInput.select();
    linkInput.setSelectionRange(0, 99999); // For mobile devices
    document.execCommand('copy');
    
    // Show feedback
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i>';
    button.classList.add('bg-green-600');
    button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
    
    setTimeout(() => {
        button.innerHTML = originalHTML;
        button.classList.remove('bg-green-600');
        button.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
    }, 2000);
}
</script>
{% endblock %}

